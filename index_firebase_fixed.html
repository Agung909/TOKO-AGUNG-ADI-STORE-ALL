<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Premium Gold ‚Äî Toko Akun & OTP - Voucher v19.4 (VIP) ‚Äî Strikethrough Total</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
body{font-family:'Poppins',sans-serif;margin:0;padding:0;background:#eef2ff;}
.container{max-width:640px;margin:auto;background:white;border-radius:20px;box-shadow:0 5px 20px rgba(0,0,0,0.15);overflow:hidden;}
.header{background:linear-gradient(90deg,#fffaf2,#fff1cc);color:white;text-align:center;padding:20px;}
.tabs{display:flex;background:#f3f4f6;}
.tab{flex:1;text-align:center;padding:12px 0;font-weight:600;cursor:pointer;}
.tab.active{background:#b58900;color:white;}
.content{padding:20px;}
.subtab{display:flex;background:#e5e7eb;margin-bottom:10px;border-radius:12px;overflow:hidden;}
.subtab div{flex:1;text-align:center;padding:8px 0;cursor:pointer;}
.subtab div.active{background:#b58900;color:white;}
.produk{background:#f9fafb;border-radius:12px;padding:10px;margin-bottom:10px;}
.produk-header{display:flex;justify-content:space-between;align-items:center;}
.harga{color:#b58900;font-weight:600;}
.kontrol{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
.jumlah{display:flex;align-items:center;gap:6px;}
.jumlah button{background:#b58900;color:white;border:none;border-radius:8px;width:28px;height:28px;font-weight:bold;cursor:pointer;}
.jumlah input{width:40px;text-align:center;border:none;background:transparent;font-weight:600;}
.tambah-btn{background:#b58900;color:white;border:none;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;}
.tambah-btn[disabled]{opacity:0.5;cursor:not-allowed;}
#btnKeranjang,#btnHistory,#btnNotif,#btnVoucher,#btnVIP{position:fixed;top:20px;background:#b58900;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:18px;font-weight:bold;cursor:pointer;z-index:100;}
#btnKeranjang{right:20px;}
#btnHistory{right:80px;}
#btnNotif{right:140px;}
#btnVoucher{right:200px;}
#btnVIP{right:260px;background:#c48b00;}
#countKeranjang{position:absolute;top:-5px;right:-5px;background:red;color:white;width:18px;height:18px;border-radius:50%;font-size:12px;text-align:center;line-height:18px;}
.popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:200;}
.popup-content{background:white;padding:20px;border-radius:20px;max-width:620px;width:94%;max-height:80%;overflow-y:auto;}
.btn-checkout{width:100%;padding:12px;margin-top:10px;border:none;border-radius:12px;background:#b58900;color:white;font-weight:600;cursor:pointer;}
.btn-close{background:#ef4444;}
footer{text-align:center;color:#6b7280;font-size:13px;padding:15px;}
.voucher-item{padding:8px;border-radius:10px;margin-bottom:8px;background:#f8fafc;border:1px solid #e6eef8;}
.voucher-expired{color:#ef4444;font-weight:700;}
.voucher-active{color:#047857;font-weight:700;}
.small{font-size:13px;color:#6b7280;}
.btn-small{padding:6px 8px;border-radius:8px;border:none;background:#b58900;color:white;cursor:pointer;margin-right:6px;}
.search-box{display:flex;gap:8px;margin-bottom:10px;}
.search-box input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd;}
.search-box button{padding:8px 10px;border-radius:8px;border:none;background:#b58900;color:white;cursor:pointer;}
.no-results{color:#6b7280;font-style:italic;padding:8px;}

.suggestions { max-height:140px; overflow:auto; }
.suggest-item{padding:8px;border-radius:6px;cursor:pointer;}
.suggest-item:hover{background:#f3f4ff;}
.suggest-empty{color:#6b7280;padding:8px;font-style:italic;}

.vip-status{padding:10px;border-radius:12px;background:#fffaf2;border:1px solid #fff0b8;margin-bottom:10px;}
.vip-code{font-family:monospace;background:#f3f4f6;padding:6px;border-radius:8px;display:inline-block;}
.strike{ text-decoration: line-through; color: #9ca3af; margin-right:8px; }
.discounted{ color: #059669; font-weight:700; }

/* ===== Level Member (üéñ) styles ===== */
#btnLevel{position:fixed;top:20px;left:20px;background:linear-gradient(135deg,#a855f7,#b58900);color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:20px;font-weight:700;cursor:pointer;z-index:120;box-shadow:0 6px 18px rgba(59,130,246,0.18);}
#btnLevel:hover{transform:scale(1.05);transition:transform .15s ease;}
/* Level popup */
#levelPopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:250;}
#levelPopup .popup-content{max-width:620px;width:94%;border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.35);background:linear-gradient(180deg,#ffffff,#f1f5f9);}
.level-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.level-badge{padding:8px 12px;border-radius:12px;font-weight:700;}
.level-bronze{background:linear-gradient(90deg,#fee7d0,#f5c27a);color:#7a4108;}
.level-silver{background:linear-gradient(90deg,#f3f4f6,#d1d5db);color:#374151;}
.level-gold{background:linear-gradient(90deg,#fffaf2,#fde68a);color:#78350f;}
.level-platinum{background:linear-gradient(90deg,#ecfeff,#bfdbfe);color:#075985;}
.progress-bar{background:#e6eefc;border-radius:12px;height:14px;overflow:hidden;margin:10px 0;}
#lvlProgress{background:#b58900;height:100%;width:0%;transition:width .35s ease;}
.reward-item{background:#fff;padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid #eef2ff;display:flex;justify-content:space-between;align-items:center;}


.fav-btn{background:transparent;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;font-weight:700;cursor:pointer;}
.fav-btn:hover{transform:scale(1.05);}

/* ========== Added: Social dropdown + settings + insight styles ========== */
.footer-enhanced {
  text-align: center;
  color: #6b7280;
  font-size: 13px;
  padding: 18px 12px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}
.footer-enhanced .dropdown { position: relative; display: inline-block; margin-top: 8px; }
.footer-enhanced .dropbtn {
  background: #b58900; color: white; padding: 8px 14px; font-weight: 600; border: none; border-radius: 8px;
  cursor: pointer; transition: all 0.15s ease;
}
.footer-enhanced .dropbtn:hover { background: #a06a00; }

.footer-enhanced .dropdown-content {
  display: none; position: absolute; background-color: #ffffff; min-width: 220px;
  box-shadow: 0px 8px 24px rgba(2,6,23,0.15); border-radius: 10px; z-index: 9999; overflow: hidden; text-align: left;
}
.footer-enhanced .dropdown-content a { color: #1e3a8a; padding: 10px 14px; text-decoration: none; display: block; font-weight: 500; transition: background 0.15s ease; }
.footer-enhanced .dropdown-content a:hover { background-color: #e0e7ff; }
.footer-enhanced .dropdown:hover .dropdown-content { display: block; }

/* Settings card */
.settings-card {
  max-width: 640px; margin: 14px auto; background: white; border-radius: 12px; padding: 12px 14px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.06); display: flex; flex-direction: column; gap: 10px;
}
.settings-title { font-weight:700; color:#fffaf2; display:flex;justify-content:space-between; align-items:center; gap:12px; }
.switch {
  --w:48px; --h:26px;
  position: relative; width: var(--w); height: var(--h); background: #e5e7eb; border-radius: 999px; cursor: pointer;
  transition: background .18s ease;
}
.switch .knob {
  position: absolute; top: 3px; left: 3px; width: calc(var(--h) - 6px); height: calc(var(--h) - 6px); background: white;
  border-radius: 999px; transition: transform .18s ease, background .18s ease; box-shadow: 0 2px 6px rgba(2,6,23,0.12);
}
.switch.on { background: #16a34a; }
.switch.on .knob { transform: translateX(calc(var(--w) - var(--h))); }

/* Insight card */
.insight-card {
  max-width: 640px; margin: 12px auto; background: white; border-radius: 12px; padding: 12px 14px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.06); display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 10px;
}
.insight-item { background:#f8fafc; padding:10px;border-radius:10px; text-align:left; }
.insight-item h4 { margin:0 0 6px 0; font-size:14px; }
.insight-item p { margin:0; font-weight:700; color:#0f172a; font-size:15px; }

/* small utility */
.center-small { max-width:640px; margin:10px auto; text-align:center; color:#6b7280; font-size:13px; }
.export-btn { background:#b58900;color:white;padding:8px 12px;border-radius:8px;border:none;font-weight:700; cursor:pointer; }


/* Settings button + hidden card styles */
.settings-card.hidden {
  display: none !important;
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity .22s ease, transform .22s ease;
}
.settings-card.visible {
  display: block !important;
  opacity: 1;
  transform: translateY(0);
}
.settings-button {
  background: #fffaf2;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 6px 20px rgba(2,6,23,0.08);
}
.settings-button:active { transform: translateY(1px); }


/* insight summary in settings */
.insight-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap: 8px;
  margin-top: 10px;
}
.insight-summary .s-item {
  background: #fff;
  border: 1px solid #eef2ff;
  padding: 8px;
  border-radius: 8px;
  text-align: left;
}
.insight-summary .s-item small { display:block; color:#6b7280; font-size:12px; margin-bottom:6px; }
.insight-summary .s-item strong { font-size:15px; color:#0f172a; }

</style>

<style>
/* ===== Premium Gold (terang) overrides ===== */
.header{
  background: linear-gradient(90deg,#fffaf2,#fff1cc) !important;
  color: #5b3e00 !important;
  box-shadow: 0 6px 28px rgba(181,137,0,0.06);
}
.header h2, .header p { color: #6b3e00 !important; }

/* Tabs & active states */
.tab.active{ background: #b58900 !important; color: white !important; box-shadow: 0 6px 18px rgba(181,137,0,0.12); }
.subtab div.active{ background: #b58900 !important; color: white !important; }

/* Prices, highlights */
.harga{ color:#b58900 !important; font-weight:800; }

/* Buttons -> gold */
.jumlah button, .tambah-btn, .btn-checkout, .btn-small, .export-btn, .settings-button {
  background: linear-gradient(180deg,#ffd95a,#d4af37) !important;
  color: #4b2f00 !important;
  border: none !important;
  box-shadow: 0 8px 18px rgba(212,175,55,0.12);
}
.tambah-btn[disabled]{ opacity:0.6; transform:none; }

/* Floating action buttons */
#btnKeranjang,#btnHistory,#btnNotif,#btnVoucher,#btnVIP,#btnFavorit,#btnLevel{
  background: linear-gradient(180deg,#ffd95a,#d4af37) !important;
  color:#4b2f00 !important;
  box-shadow: 0 10px 26px rgba(212,175,55,0.12) !important;
}

/* VIP/voucher cards */
.vip-status, .voucher-item { background: #fffaf2 !important; border-color:#fff1cc !important; color:#6b3e00 !important; }
.vip-code { background:#fff6df !important; color:#6b3e00; border:1px solid #fff1cc; }

/* Footer */
.footer-enhanced { background:#fffaf2 !important; color:#6b3e00 !important; border-top:1px solid #fff1cc !important; }

/* Settings */
.settings-card { box-shadow: 0 10px 30px rgba(181,137,0,0.06) !important; }
.settings-button { background:#6b3e00 !important; color:white !important; }

/* Level badge - gold emphasis */
.level-gold { background: linear-gradient(90deg,#fff7e6,#fde68a) !important; color:#6b3e00 !important; }

/* Small UI tweaks */
.fav-btn { background: transparent !important; border-color: #f3ead0 !important; color:#6b3e00 !important; }
.insight-card, .settings-card, .reward-item { border: 1px solid #fff6e0 !important; }

/* Strike/discount colors */
.strike{ color: #9c7d00 !important; }
.discounted{ color:#6b3e00 !important; }

/* Gold shimmer animation */
@keyframes shimmer {
  0% { transform: translateX(-100%); opacity: 0; }
  50% { opacity: .9; }
  100% { transform: translateX(100%); opacity: 0; }
}
.header h2 { position: relative; overflow: hidden; display:inline-block; }
.header h2::after {
  content: "";
  position: absolute;
  left: -120%;
  top: 0;
  height: 100%;
  width: 120%;
  background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.6), rgba(255,255,255,0));
  animation: shimmer 4s linear infinite;
  pointer-events:none;
  mix-blend-mode: overlay;
}

/* Make inputs and selects slightly warmer */
input, select, textarea { border-radius:8px; border:1px solid #f3ead0; background: #fffdf7; color:#4b2f00; }

/* Ensure popups keep the gold theme */
.popup-content { box-shadow: 0 12px 40px rgba(181,137,0,0.08); border-radius:18px; }

/* Responsive tweak for floating buttons stacking */
@media (max-width:480px){
  #btnKeranjang{ right:14px; top:18px; }
  #btnHistory{ right:74px; top:18px; }
  #btnNotif{ right:134px; top:18px; }
}
</style>


<!-- Premium Gold: Page Loader -->
<style>
#page-loader {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,250,242,0.98), rgba(255,249,238,0.98));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  transition: opacity 450ms ease, visibility 450ms ease;
  visibility: visible;
  opacity: 1;
  backdrop-filter: blur(2px);
}
#page-loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.loader-inner {
  text-align: center;
  padding: 18px 26px;
  border-radius: 14px;
  box-shadow: 0 12px 40px rgba(181,137,0,0.08);
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,250,236,0.95));
  border: 1px solid rgba(212,175,55,0.08);
  min-width: 220px;
}
.loader-spinner {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  margin: 6px auto 12px auto;
  position: relative;
  box-sizing: border-box;
  background: conic-gradient(#ffd95a 0% 40%, rgba(212,175,55,0.18) 40% 100%);
  animation: spin 1.4s linear infinite;
  border: 6px solid rgba(255,255,255,0.8);
}
@keyframes spin { to { transform: rotate(1turn); } }
.loader-text {
  font-weight: 700;
  color: #5b3e00;
  font-size: 16px;
  margin-top: 6px;
}
.loader-sub {
  font-size: 13px;
  color: #8b6b2a;
  margin-top: 4px;
}
</style>

<style>

/* Make VIP popup's 'Beli Sekarang' button text darker for contrast */
#vipPopup .btn-checkout:not(.btn-close) {
  color: #1a1200 !important;
  font-weight: 700;
}

</style>
<style>

/* Make VIP popup 'Beli Sekarang' button gold to match 'Tutup' */
#vipPopup .btn-checkout:not(.btn-close) {
  background: linear-gradient(180deg,#ffd95a,#d4af37) !important;
  color: #1a1200 !important;
  font-weight: 700;
  border: none !important;
  box-shadow: 0 6px 18px rgba(181,137,0,0.12);
}

</style>
</head>
<body>

<div id="page-loader" aria-hidden="false">
  <div class="loader-inner" role="status" aria-live="polite">
    <div class="loader-spinner" aria-hidden="true"></div>


<button id="skip-btn" aria-label="Lewati pemuatan" style="
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(180deg,#ffd95a,#d4af37);
  color:#4b2f00;
  border:none;
  border-radius:10px;
  padding:10px 18px;
  font-weight:700;
  cursor:pointer;
  font-size:14px;
  display:none;
  z-index:100000;
  box-shadow:0 8px 24px rgba(0,0,0,0.12);
">Lewati</button>

<script>
(function(){
  try {
    var loader = document.getElementById('page-loader');
    var skipBtn = document.getElementById('skip-btn');
    if(!loader || !skipBtn) return;
    // show Skip button after 3 seconds
    var showTimer = setTimeout(function(){
      try{ skipBtn.style.display = 'block'; }catch(e){}
    }, 3000);

    // hide loader when Skip pressed
    skipBtn.addEventListener('click', function(){
      try{
        loader.classList.add('hidden');
        skipBtn.style.display = 'none';
        clearTimeout(showTimer);
      }catch(e){}
    });

    // safety: always remove loader after 10 seconds (from script run) if still visible
    setTimeout(function(){
      try{
        loader.classList.add('hidden');
        skipBtn.style.display = 'none';
      }catch(e){}
    }, 10000);
  } catch(e) {
    console.warn('skip-btn init error', e);
  }
})();
</script>

    <div class="loader-text">Memuat Toko ‚Äî Premium Gold</div>
    <div class="loader-sub">Mohon tunggu, sedang menyiapkan tampilan...</div>
  </div>
</div>

<div class="container">
  <div class="header">
    <h2>Daftar Harga Produk</h2>
    <p>Lihat & unduh daftar harga produk. Klik tombol di bawah untuk unduh.</p>
  </div>

<!-- Registration info inserted by assistant: appears under the main header -->
<div id="registeredUnderHeader" style="max-width:780px;margin:12px auto;padding:10px 12px;background:#fffaf2;border:1px solid #fff1cc;border-radius:10px;color:#6b3e00;font-weight:700;text-align:center;display:none;">
  <span id="registeredUnderHeaderText"></span>
</div>

<!-- VIP Status Banner (inserted) -->
<div id="vipStatusBanner" style="max-width:640px;margin:12px auto;padding:12px;border-radius:10px;background:#fffaf2;border:1px solid #fff0b8;text-align:center;">
  <div id="vipBannerContent" style="font-size:15px;color:#92400e;"></div>
  
</div>

<script>

/* Helper: periksa apakah VIP benar aktif (cek expiry) */
function isVIPActive() {
  try {
    if (typeof vipState !== 'undefined' && vipState) {
      if (vipState.active) {
        if (vipState.expires) {
          var t = (typeof vipState.expires === 'number') ? Number(vipState.expires) : (new Date(vipState.expires)).getTime();
          if (!isNaN(t) && Date.now() < t) return true;
          return false;
        }
        return true;
      }
      return false;
    }
    if (window && window.localStorage) {
      var la = localStorage.getItem('vipActive');
      var le = localStorage.getItem('vipExpire');
      if (la === '1') {
        if (le) {
          var t2 = (new Date(le)).getTime();
          if (!isNaN(t2) && Date.now() < t2) return true;
          return false;
        }
        return true;
      }
    }
  } catch(e) { return false; }
  return false;
}

function renderVipBanner(){
  const el = document.getElementById('vipBannerContent');
  if(!el) return;
  // Only rely on runtime vipState (no persistence). If vipState is active, show active; otherwise show not-active.
  try{
    if(typeof vipState !== 'undefined' && vipState && vipState.active){
      const d = new Date(vipState.expires);
      el.innerHTML = `<div style="font-weight:700">üéüÔ∏è Tiket VIP kamu aktif sampai: ${d.toLocaleDateString('id-ID')}</div><div style="color:#6b3e00;font-weight:600">üåü Status: Premium User</div>`;
    } else {
      el.innerHTML = `<div style="font-weight:700;color:#92400e">‚ö†Ô∏è Kamu belum memiliki Tiket VIP</div><div>Segera aktifkan VIP (harga Rp15.000) untuk dapat voucher harian 1.000</div>`;
    }
  }catch(e){
    el.innerHTML = `<div style="font-weight:700;color:#92400e">‚ö†Ô∏è Kamu belum memiliki Tiket VIP</div><div>Segera aktifkan VIP (harga Rp15.000) untuk dapat voucher harian 1.000</div>`;
  }
}
document.addEventListener('DOMContentLoaded', renderVipBanner);
</script>
<!-- End VIP Status Banner -->

  


  <div class="tabs">
    <div class="tab active" id="tab-tiktok" onclick="bukaTab('tiktok', this)">Akun TikTok</div>
    <div class="tab" id="tab-otp" onclick="bukaTab('otp', this)">OTP / APK</div>
    <div class="tab" id="tab-rekber" onclick="bukaTab('rekber', this)">Rekber</div>
  </div>

  <div class="content">
    <div id="tiktok">
      <div class="subtab" id="subtab-tiktok">
        <div id="sub-tiktokBasic" class="active" onclick="bukaSubtab('tiktokBasic','sub-tiktokBasic')">Basic</div>
        <div id="sub-tiktokPremium" onclick="bukaSubtab('tiktokPremium','sub-tiktokPremium')">Premium</div>
      </div>

      <div class="search-box" id="search-wrap-tiktokBasic" data-no-results="no-tiktokBasic" style="display:block">
        <input id="search-tiktokBasic" placeholder="Cari produk di Basic (ketik nama)..." oninput="filterCategory('tiktokBasic', this.value)">
        <button onclick="performSearch('tiktokBasic')">Cari</button>
        <button onclick="document.getElementById('search-tiktokBasic').value='';filterCategory('tiktokBasic','')">Reset</button>
      </div>
      <div class="suggestions" id="suggest-tiktokBasic" style="display:none;border-radius:8px;background:#fff;padding:6px;margin-bottom:8px;border:1px solid #eee;"></div>
      <div class="no-results-container" id="no-tiktokBasic"></div>
      <div id="tiktokBasic"></div>

      <div class="search-box" id="search-wrap-tiktokPremium" data-no-results="no-tiktokPremium" style="display:none">
        <input id="search-tiktokPremium" placeholder="Cari produk di Premium (ketik nama)..." oninput="filterCategory('tiktokPremium', this.value)">
        <button onclick="performSearch('tiktokPremium')">Cari</button>
        <button onclick="document.getElementById('search-tiktokPremium').value='';filterCategory('tiktokPremium','')">Reset</button>
      </div>
      <div class="suggestions" id="suggest-tiktokPremium" style="display:none;border-radius:8px;background:#fff;padding:6px;margin-bottom:8px;border:1px solid #eee;"></div>
      <div class="no-results-container" id="no-tiktokPremium"></div>
      <div id="tiktokPremium" style="display:none"></div>
    </div>

    <div id="otp" style="display:none;">
      <div class="search-box" id="search-wrap-produk-otp" data-no-results="no-produk-otp">
        <input id="search-produk-otp" placeholder="Cari produk OTP..." oninput="filterCategory('produk-otp', this.value)">
        <button onclick="performSearch('produk-otp')">Cari</button>
        <button onclick="document.getElementById('search-produk-otp').value='';filterCategory('produk-otp','')">Reset</button>
      </div>
      <div class="suggestions" id="suggest-produk-otp" style="display:none;border-radius:8px;background:#fff;padding:6px;margin-bottom:8px;border:1px solid #eee;"></div>
      <div class="no-results-container" id="no-produk-otp"></div>
      <div id="produk-otp"></div>
    </div>

    <div id="rekber" style="display:none;">
      <div class="subtab" id="subtab-rekber">
        <div id="sub-rekberBasic" class="active" onclick="bukaSubtab('rekberBasic','sub-rekberBasic')">Basic</div>
        <div id="sub-rekberPremium" onclick="bukaSubtab('rekberPremium','sub-rekberPremium')">Premium</div>
      </div>

      <div class="search-box" id="search-wrap-rekberBasic" data-no-results="no-rekberBasic" style="display:block">
        <input id="search-rekberBasic" placeholder="Cari Rekber (Basic)..." oninput="filterCategory('rekberBasic', this.value)">
        <button onclick="performSearch('rekberBasic')">Cari</button>
        <button onclick="document.getElementById('search-rekberBasic').value='';filterCategory('rekberBasic','')">Reset</button>
      </div>
      <div class="suggestions" id="suggest-rekberBasic" style="display:none;border-radius:8px;background:#fff;padding:6px;margin-bottom:8px;border:1px solid #eee;"></div>
      <div class="no-results-container" id="no-rekberBasic"></div>
      <div id="rekberBasic"></div>

      <div class="search-box" id="search-wrap-rekberPremium" data-no-results="no-rekberPremium" style="display:none">
        <input id="search-rekberPremium" placeholder="Cari Rekber (Premium)..." oninput="filterCategory('rekberPremium', this.value)">
        <button onclick="performSearch('rekberPremium')">Cari</button>
        <button onclick="document.getElementById('search-rekberPremium').value='';filterCategory('rekberPremium','')">Reset</button>
      </div>
      <div class="suggestions" id="suggest-rekberPremium" style="display:none;border-radius:8px;background:#fff;padding:6px;margin-bottom:8px;border:1px solid #eee;"></div>
      <div class="no-results-container" id="no-rekberPremium"></div>
      <div id="rekberPremium" style="display:none"></div>
    </div>
  </div>
</div>

<button id="btnLevel" title="Level Member" onclick="bukaLevel()">üéñ</button>
<button id="btnKeranjang" title="Keranjang" onclick="bukaPopup()">üõí<span id="countKeranjang">0</span></button>
<button id="btnHistory" title="History" onclick="bukaHistory()">üìú</button>
<button id="btnNotif" title="Notifikasi" onclick="bukaNotif()">üîî</button>
<button id="btnVoucher" title="Voucher (admin)" onclick="bukaVoucher()">üéü</button>
<button id="btnVIP" title="Tiket VIP" onclick="bukaVIP()">‚≠ê</button>

<button id="btnFavorit" title="Favorit" onclick="bukaFavorites()" style="position:fixed;top:20px;left:80px;background:#ef4444;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:20px;font-weight:700;cursor:pointer;z-index:120;">‚ù§</button>




<!-- ===== Profil Section ===== -->

<section id="userProfile" style="margin:12px;padding:8px;border-radius:12px;background:#f8fafc;box-shadow:0 0 5px rgba(0,0,0,0.1);text-align:center;">
  <div id="profileDisplayWrapper">
    <button id="profileNameBtn" class="btn-small" onclick="showProfilePopup()" title="Klik untuk lihat/ubah profil">Masukkan Nama</button>
    <div id="profileSmallNote" style="margin-top:8px;font-size:13px;color:#334155;"></div>
  </div>
</section>


<script>
function saveProfile() {
  const nameEl = document.getElementById('userName');
  const birthEl = document.getElementById('userBirth');
  const name = nameEl.value.trim();
  const birth = birthEl.value;
  if (!name || !birth) {
    alert('Isi nama dan tanggal lahir dulu ya!');
    return;
  }
  localStorage.setItem('profileName', name);
  localStorage.setItem('profileBirth', birth);
  // lock inputs after saving
  nameEl.disabled = true;
  birthEl.disabled = true;
  document.getElementById('saveProfileBtn').disabled = true;
  renderProfile();
}

function renderProfile() {
  const name = localStorage.getItem('profileName');
  const birth = localStorage.getItem('profileBirth');
  const display = document.getElementById('profileDisplay');
  const nameEl = document.getElementById('userName');
  const birthEl = document.getElementById('userBirth');
  const btn = document.getElementById('saveProfileBtn');
  if (name && birth) {
    const d = new Date(birth);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const formatted = d.toLocaleDateString('id-ID', options);
    display.innerHTML = `Selamat datang, <b>${name}</b><br>Tanggal Lahir: ${formatted}`;
    if (nameEl) { nameEl.value = name; nameEl.disabled = true; }
    if (birthEl) { birthEl.value = birth; birthEl.disabled = true; }
    if (btn) btn.disabled = true;
  } else {
    display.innerHTML = 'Belum ada data profil tersimpan.';
    if (nameEl) { nameEl.disabled = false; }
    if (birthEl) { birthEl.disabled = false; }
    if (btn) btn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', function(){ renderProfile(); });
</script>
<!-- ===== End Profil Section ===== -->
<footer class="footer-enhanced">
  <p>¬© 2025 TikTok & OTP Store</p>

  <div class="dropdown" style="margin-top:10px;">
    <button class="dropbtn">üåê Sosial Media ‚ñº</button>
    <div class="dropdown-content" aria-label="Sosial media">
      <a href="https://youtube.com/@channelmodagungadi?si=h-VQu34oRfJkt0Tt" target="_blank">üé¨ YouTube</a>
      <a href="https://www.facebook.com/share/16Rw4ZymcX/" target="_blank">üìò Facebook</a>
      <a href="https://www.instagram.com/agung.keren.57?igsh=ZHcxcThmN3MzODZk" target="_blank">üì∏ Instagram</a>
      <a href="https://www.tiktok.com/@pphitampro9?_r=1&_t=ZS-913sj5wXrOs" target="_blank">üéµ TikTok</a>
      <a href="https://pin.it/3vZmEYQSZ" target="_blank">üìå Pinterest</a>
      <a href="https://x.com/agungadi981" target="_blank">üê¶ Twitter (X)</a>
      <a href="https://github.com/Agung909" target="_blank">üíª GitHub</a>
      <a href="https://wa.me/6285769302532" target="_blank">üí¨ WhatsApp</a>
    </div>
  </div>
</footer>
<button id="settingsBtn" class="settings-button" type="button">Nama Setelan Aplikasi</button>

<!-- Settings block (App Settings + Notification toggle) -->
<div class="settings-card hidden" id="appSettings" style="margin-bottom:16px;">
  <div class="settings-title">
    <div>
      <div style="font-size:15px;font-weight:700;color:#0f172a;">Nama Setelan Aplikasi</div>
      <div style="font-size:12px;color:#6b7280;">Kontrol pengaturan aplikasi dan notifikasi</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
      <div style="font-size:12px;color:#6b7280">Suara Notifikasi</div>
      <div id="notifSwitch" class="switch" role="switch" aria-checked="false" onclick="toggleNotif(this)">
        <div class="knob"></div>
      </div>
    </div>
  </div>

  <div style="display:flex;gap:10px;align-items:center;margin-top:8px;">
    <button class="export-btn" onclick="exportInsightCSV()">Export Laporan CSV</button>
    <button class="export-btn" onclick="renderInsight(true)" style="background:#d4af37">Refresh Insight</button>
    <button class="export-btn" onclick="sampleNotify()" style="background:#f59e0b">Tes Notifikasi</button>
  </div>
  <div class="center-small">Status Suara: <span id="statusSound">OFF</span></div>

  <div class="insight-summary" id="settingsInsight">
    <div class="s-item"><small>Total Pesanan</small><strong id="sum_totalOrders">0</strong></div>
    <div class="s-item"><small>Total Pengeluaran</small><strong id="sum_totalSpent">Rp0</strong></div>
    <div class="s-item"><small>Total Item Terjual</small><strong id="sum_totalItems">0</strong></div>
    <div class="s-item"><small>Rata-rata Per Order</small><strong id="sum_avgOrder">Rp0</strong></div>
    <div class="s-item"><small>Perkiraan Keuntungan</small><strong id="sum_profit">Rp0</strong></div>
    <div class="s-item"><small>Tanggal</small><strong id="sum_date">-</strong></div>
  </div>

</div>

<script>
/* ===== Added script for notification toggle, insight, CSV export ===== */
(function(){
  try{
    // init from localStorage
    const key = 'app_sound_on_v1';
    function setSwitchOn(el, on){
      if(on){
        el.classList.add('on');
        el.setAttribute('aria-checked','true');
      } else {
        el.classList.remove('on');
        el.setAttribute('aria-checked','false');
      }
      document.getElementById('statusSound').textContent = on ? 'ON' : 'OFF';
    }

    window.toggleNotif = function(el){
      const on = !el.classList.contains('on');
      setSwitchOn(el, on);
      localStorage.setItem(key, on ? '1' : '0');
      if(on) playBeep();
    };

    // set initial switch state
    const sw = document.getElementById('notifSwitch');
    const saved = localStorage.getItem(key);
    if(sw){
      setSwitchOn(sw, saved === '1');
    }

    // beep generator using WebAudio
    function playBeep(freq=880, duration=120, vol=0.02){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, duration);
      }catch(e){ console.warn('beep err', e); }
    }
    window.playBeep = playBeep;

    window.sampleNotify = function(){
      // sample notification: only play if sound enabled
      const enabled = localStorage.getItem(key) === '1' || (document.getElementById('notifSwitch') && document.getElementById('notifSwitch').classList.contains('on'));
      if(enabled) playBeep(880,200,0.04);
      alert('Tes notifikasi: ' + (enabled ? 'Suara ON' : 'Suara OFF'));
    };

    // Insight rendering function
    window.formatRupiah = window.formatRupiah || function(num){ return 'Rp' + Number(num || 0).toLocaleString('id-ID'); };

    window.renderInsight = function(showAlert){
      try{
        // try to find order history - prefer variable named "history" defined in page scripts
        var orders = [];
        try{ if(typeof history !== 'undefined' && Array.isArray(history)) orders = history; }catch(e){}
        // fallback: look for localStorage 'history' or 'orderHistory'
        if((!orders || orders.length===0) && localStorage.getItem('history')){
          try{ orders = JSON.parse(localStorage.getItem('history')||'[]'); }catch(e){}
        }
        if((!orders || orders.length===0) && localStorage.getItem('orderHistory')){
          try{ orders = JSON.parse(localStorage.getItem('orderHistory')||'[]'); }catch(e){}
        }

        const totalOrders = orders.length || 0;
        let totalSpent = 0, totalItems = 0;
        orders.forEach(o=>{
          // o.total may be number or string
          const t = Number(o.total || o.totalAfter || 0) || 0;
          totalSpent += t;
          if(Array.isArray(o.items)){
            o.items.forEach(it => { totalItems += Number(it.jumlah || it.qty || 0); });
          } else {
            totalItems += Number(o.jumlah || o.qty || 0) || 0;
          }
        });

        const avgOrder = totalOrders>0 ? Math.round(totalSpent/totalOrders) : 0;
        const profitEstimate = Math.round(totalSpent * 0.35); // estimate 35% margin (adjust as needed)
        document.getElementById('ins_totalOrders').textContent = totalOrders;
        document.getElementById('ins_totalSpent').textContent = formatRupiah(totalSpent);
        document.getElementById('ins_totalItems').textContent = totalItems;
        document.getElementById('ins_avgOrder').textContent = formatRupiah(avgOrder);
        document.getElementById('ins_profit').textContent = formatRupiah(profitEstimate);
        document.getElementById('ins_date').textContent = new Date().toLocaleDateString();

        if(showAlert) alert('Insight diperbarui (data dibaca dari variabel history / localStorage).');
      }catch(e){
        console.error('renderInsight err', e);
        if(showAlert) alert('Gagal memuat insight: ' + e);
      }
    };

    window.exportInsightCSV = function(){
      try{
        var orders = [];
        try{ if(typeof history !== 'undefined' && Array.isArray(history)) orders = history; }catch(e){}
        if((!orders || orders.length===0) && localStorage.getItem('history')){
          try{ orders = JSON.parse(localStorage.getItem('history')||'[]'); }catch(e){}
        }
        if((!orders || orders.length===0) && localStorage.getItem('orderHistory')){
          try{ orders = JSON.parse(localStorage.getItem('orderHistory')||'[]'); }catch(e){}
        }
        if(!orders || orders.length===0) return alert('Tidak ada data order untuk diexport.');

        // build CSV: tanggal, nama, jumlah, total, metode
        const rows = [['Tanggal','Nama','Jumlah','Total','Metode']];
        orders.forEach(o=>{
          const date = o.tanggal || o.date || '';
          const names = o.nama || (Array.isArray(o.items) ? o.items.map(it=>it.nama).join('; ') : '');
          const jumlah = o.jumlah || (Array.isArray(o.items) ? o.items.reduce((a,b)=>a + (Number(b.jumlah||b.qty||0)),0) : 0);
          const total = o.total || o.totalAfter || 0;
          const metode = o.metode || '';
          rows.push([date, names, jumlah, total, metode]);
        });
        const csvContent = rows.map(r => r.map(cell => '"' + String(cell).replace(/"/g,'""') + '"').join(',')).join('\n');
        const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'laporan_pengeluaran_pesanan.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }catch(e){
        console.error('export csv err', e);
        alert('Gagal export CSV: ' + e);
      }
    };

    // initial render after slight delay to ensure page scripts run first
    
  }catch(e){ console.error('init settings script err', e); }
})();
</script>



<!-- Profile Popup (shows user info and allows quick edit) -->
<div class="popup" id="profilePopup">
  <div class="popup-content">
    <h3>Profil Pengguna</h3>
    <div id="profilePopupContent" style="margin-bottom:10px;">
      <p><strong>Nama:</strong> <span id="pp_name">-</span></p>
      <p><strong>Tanggal Lahir:</strong> <span id="pp_birth">-</span></p>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn-checkout" id="pp_edit_btn" onclick="editProfileFromPopup()">Edit</button>
      <button class="btn-checkout btn-close" onclick="closeProfilePopup()">Tutup</button>
    </div>
  </div>
</div>

<!-- Pesanan Popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h3>Detail Pesanan</h3>
    <div id="detailPesanan"></div>
    <label class="small">Catatan:</label>
    <input type="text" id="catatan" placeholder="Tambahkan catatan" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;">
    <label class="small">Metode Pembayaran:</label>
    <select id="metode" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;">
      <option value="OVO">OVO</option>
      <option value="DANA">DANA</option>
      <option value="GoPay">GoPay</option>
      <option value="QRIS">QRIS</option>
    </select>
    <button class="btn-checkout" onclick="buatPesanan()">Buat Pesanan</button>
    <button class="btn-checkout btn-close" onclick="tutupPopup()">Tutup</button>
  </div>
</div>

<!-- VIP Popup -->
<div class="popup" id="vipPopup">
  <div class="popup-content">
    <h3>Beli Tiket VIP ‚Äî Rp15.000 (durasi 30 hari)</h3>
    <div id="vipArea">
      <div id="vipStatusBox" class="vip-status">
        <div id="vipMsg">Anda belum memiliki Tiket VIP.</div>
      </div>
      <div>
        <label class="small">Masukkan Kode Pembelian VIP (diberikan admin):</label>
        <input id="vipInput" placeholder="Contoh: VIPBUY2025A" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;">
        <button onclick="attemptBuyVIP()" class="btn-checkout">Bayar & Aktifkan (Rp15.000)</button>
      </div>
      <hr>
      <div id="vipDailyList"></div>
      <p class="small">Catatan: Setelah aktif, Anda akan menerima 1 voucher diskon Rp1.000 untuk setiap hari selama 30 hari. Voucher hanya berlaku 1 hari (tgl tertera) dan 1x pakai. Voucher untuk hari-hari mendatang tidak bisa dipakai sampai hari itu tiba.</p>
      <button class="btn-checkout btn-close" onclick="tutupVIP()">Tutup</button>
    </div>
  </div>
</div>



<!-- Favorites Popup -->
<div class="popup" id="favoritesPopup">
  <div class="popup-content">
    <h3>Produk Favorit</h3>
    <div id="favoritesList"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn-checkout btn-close" onclick="tutupFavorites()">Tutup</button>
    </div>
  </div>
</div>
<!-- Level Member Popup -->
<div class="popup" id="levelPopup">
  <div class="popup-content" id="levelBox">
    <div class="level-header">
      <h3>üéñ Status Level Member</h3>
      <div id="levelBadge" class="level-badge level-bronze">Bronze</div>
    </div>
    <p>Level Saat Ini: <strong id="lvlName">Bronze</strong></p>
    <p>Total Belanja: <span id="lvlTotal">Rp0</span></p>
    <div class="progress-bar"><div id="lvlProgress"></div></div>
    <p id="nextLevelInfo" class="small">Menuju Silver ‚Äî Rp100.000</p>
    <h4>üéÅ Riwayat Voucher Bonus:</h4>
    <div id="rewardList"><p class="small">Belum ada voucher bonus.</p></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn-checkout" onclick="tutupLevel()">Tutup</button>
    </div>
  </div>
</div>

<!-- History Popup -->
<div class="popup" id="historyPopup">
  <div class="popup-content">
    <h3>History Orderan</h3>
    <div id="historyList"></div>
    <button class="btn-checkout btn-close" onclick="tutupHistory()">Tutup</button>
  </div>
</div>

<!-- Notif Popup -->
<div class="popup" id="notifPopup">
  <div class="popup-content">
    <h3>Notifikasi</h3>
    <div id="notifList"></div>
    <button class="btn-checkout btn-close" onclick="tutupNotif()">Tutup</button>
  </div>
</div>

<!-- Voucher Popup (admin-only) -->
<div class="popup" id="voucherPopup">
  <div class="popup-content">
    <h3>Daftar Voucher Rahasia (Admin)</h3>
    <div id="voucherList"></div>
    <p class="small">Catatan: voucher bersifat rahasia. Untuk menonaktifkan voucher, hapus atau ubah tanggal kadaluarsa di file.</p>
    <button class="btn-checkout btn-close" onclick="tutupVoucher()">Tutup</button>
  </div>
</div>

<script>
// ===== v19.4: remove "Gunakan Sekarang", mark VIP daily voucher used on activation, and show strikethrough original total when voucher applied =====

function formatRupiah(num){return "Rp"+num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");}

// Helper: produce a user-facing label for vouchers (Format R2 for LVL codes: "üèÜ Rank <Name> ‚Äî Diskon RpX")
function getVoucherLabel(code, value, source){
  const val = value || 0;
  const vstr = formatRupiah(val);
  try{
    const c = (code||'').toString().toUpperCase();
    // Detect LVL-<RANK> patterns, allow separators -, _, or space
    const m = c.match(/LVL[\-\_ ]*([A-Z]+)/);
    if(m && m[1]){
      const rankRaw = m[1].toLowerCase();
      const rank = rankRaw.charAt(0).toUpperCase() + rankRaw.slice(1);
      return `üèÜ Rank ${rank} ‚Äî Diskon ${vstr}`;
    }
    if(/^VIPD\-/.test(c) || source === 'vip') return `üíé Voucher VIP Harian ‚Äî Diskon ${vstr}`;
    if(/^ADM\-|^ADMIN\-/.test(c) || source === 'admin') return `üßæ Voucher Admin ‚Äî Diskon ${vstr}`;
    return `üéüÔ∏è Voucher Promo ‚Äî Diskon ${vstr}`;
  }catch(e){
    return `üéüÔ∏è Voucher Promo ‚Äî Diskon ${vstr}`;
  }
}

function parseIso(dateStr){return new Date(dateStr);}
function isExpired(v){ return new Date() > parseIso(v.expires); }
function isSameDate(a,b){
  const da = new Date(a), db = new Date(b);
  return da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() && da.getDate()===db.getDate();
}
function todayDateOnly(){
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

// existing voucherData (general discounts) - admin-visible
const voucherData = [
  {code: 'HX2K77ABC2025', value: 2000, expires: '2025-11-01T23:59:59', used: false},
  {code: 'HX2K55LMN2025', value: 2000, expires: '2025-11-01T23:59:59', used: false},
  {code: 'HX5K99XYZ2025', value: 5000, expires: '2025-11-01T23:59:59', used: false},
  {code: 'HX5K22QWE2025', value: 5000, expires: '2025-11-01T23:59:59', used: false},
  {code: 'HX5K88RTY2025', value: 5000, expires: '2025-11-01T23:59:59', used: false}
];

// admin-generated VIP purchase codes (one-time use). Admin can add codes here.
let vipPurchaseData = [
  {code: 'VIPBUY2025A', used:false},
  {code: 'VIPBUY2025B', used:false},
  {code: 'VIPBUY2025C', used:false},
  {code: 'VIPBUY2025D', used:false},
  {code: 'VIPBUY2025E', used:false},
  {code: 'VIPBUY2025F', used:false},
  {code: 'VIPBUY2025G', used:false},
  {code: 'VIPBUY2025H', used:false},
  {code: 'VIPBUY2025I', used:false},
  {code: 'VIPBUY2025J', used:false},
  {code: 'VIPBUY2025K', used:false},
  {code: 'VIPBUY2025L', used:false}

];

// VIP state for current user
let vipState = {
  active:false,
  start:null,
  expires:null,
  purchaseCode:null,
  dailyVouchers: [], // {code, value, expires, used, dateStr}
  notifiedDates: [] // array of yyyy-mm-dd strings notifying which dates we've added notif for
};

let activeVouchers = [];
let voucherSourceMap = {}; // code -> source ('vip'|'admin'|'promo')

let searchHistory = []; // {term, category, date}
let lastSelectedSuggestion = {}; // per-category last selected term to avoid immediate re-show
let suppressSuggestionsUntilUserTyped = {}; // per-category suppress flag after programmatic fill
let keranjang = [];
let history = [];
let notifikasi = [
  "Rekber Basic: harga tetap Rp10.000",
  "Rekber Premium: harga dinamis mulai Rp12.000",
  "Promo: hubungi admin untuk kode voucher rahasia"
];

// master products (unchanged)
const products = [
  {id: 'p1', nama:'1k Follower',harga:50000,stok:100,deskripsi:'Basic, tanpa garansi',kategori:'tiktokBasic'},
  {id: 'p2', nama:'2k Follower',harga:100000,stok:100,deskripsi:'Basic, tanpa garansi',kategori:'tiktokBasic'},
  {id: 'p3', nama:'5k Follower',harga:250000,stok:100,deskripsi:'Basic, tanpa garansi',kategori:'tiktokBasic'},
  {id: 'p4', nama:'10k Follower',harga:500000,stok:100,deskripsi:'Basic, tanpa garansi',kategori:'tiktokBasic'},
  {id: 'p5', nama:'1k Follower Premium',harga:110000,stok:100,deskripsi:'Premium, ada garansi',kategori:'tiktokPremium'},
  {id: 'p6', nama:'2k Follower Premium',harga:220000,stok:100,deskripsi:'Premium, ada garansi',kategori:'tiktokPremium'},
  {id: 'p7', nama:'5k Follower Premium',harga:550000,stok:100,deskripsi:'Premium, ada garansi',kategori:'tiktokPremium'},
  {id: 'p8', nama:'10k Follower Premium',harga:1000000,stok:100,deskripsi:'Premium, ada garansi',kategori:'tiktokPremium'},
  {id: 'o1', nama:'Dana OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o2', nama:'OVO OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o3', nama:'GoPay OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o4', nama:'ShopeePay OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o5', nama:'WhatsApp OTP',harga:5000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o6', nama:'Telegram OTP',harga:10000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o7', nama:'Facebook OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o8', nama:'Instagram OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o9', nama:'Twitter OTP',harga:2000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'o10', nama:'All APK OTP',harga:3000,stok:100,deskripsi:'OTP 1 KALI PAKAI',kategori:'produk-otp'},
  {id: 'r1', nama:'Rekber Jefry Alson Basic',harga:10000,stok:100,deskripsi:'biaya ajak admin untuk rekber',kategori:'rekberBasic'},
  {id: 'r2', nama:'Rekber Jefry Alson Premium',harga:11000,stok:100,deskripsi:'sudah termasuk biaya admin saya dan biaya admin rekber',kategori:'rekberPremium'}

  ,{id: 'r3', nama:'Rekber Julie Sean Basic',harga:10000,stok:100,deskripsi:'biaya ajak admin untuk rekber',kategori:'rekberBasic'}
  ,{id: 'r4', nama:'Rekber Julie Sean Premium',harga:10000,stok:100,deskripsi:'sudah termasuk biaya admin saya dan biaya admin rekber',kategori:'rekberPremium'}
];

let activeTab = 'tiktok';
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]'); // array of {id,nama,harga}

function saveFavorites(){ try{ localStorage.setItem('favorites', JSON.stringify(favorites)); }catch(e){ console.error('save fav err',e);} }
function isFavorited(id){ return favorites.findIndex(f=>f.id===id) !== -1; }
function toggleFavorite(id, nama, harga){
  const idx = favorites.findIndex(f=>f.id===id);
  if(idx === -1){
    favorites.push({id,nama,harga});
  } else {
    favorites.splice(idx,1);
  }
  saveFavorites();
  // update UI: button and favorites list if open
  try{ const btn = document.getElementById('fav-'+id); if(btn) btn.textContent = isFavorited(id)?'‚ô•':'‚ô°'; }catch(e){}
  renderFavoritesList();
}

function renderFavoritesList(){
  const wrap = document.getElementById('favoritesList');
  if(!wrap) return;
  wrap.innerHTML = '';
  if(!favorites || favorites.length===0){
    wrap.innerHTML = '<p class=\"small\">Belum ada produk favorit.</p>';
    return;
  }
  favorites.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'produk';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.padding = '10px';
    div.style.marginBottom = '8px';
    div.innerHTML = `<div><strong>${f.nama}</strong><div class=\"small\">Harga: ${formatRupiah(f.harga)}</div></div>
      <div style=\"display:flex;gap:8px;align-items:center;\">
        <button class=\"btn-small\" onclick=\"addFavoriteToCart('${f.id}')\">Beli</button>
        <button class=\"btn-small\" onclick=\"removeFavorite('${f.id}')\">Hapus</button>
      </div>`;
    wrap.appendChild(div);
  });
}

function addFavoriteToCart(id){
  const prod = products.find(p=>p.id===id);
  if(!prod){ alert('Produk favorit tidak ditemukan.'); return; }
  // add qty 1 by default
  if(activeVouchers.length > 0) invalidateVouchers('keranjang berubah (tambah produk)');
  const idx = keranjang.findIndex(k=>k.id===id);
  if(idx !== -1) keranjang[idx].jumlah += 1;
  else keranjang.push({id:prod.id, nama:prod.nama, harga:prod.harga, jumlah:1, deskripsi:prod.deskripsi});
  updateCountKeranjang();
  bukaPopup();
}

function removeFavorite(id){
  const idx = favorites.findIndex(f=>f.id===id);
  if(idx !== -1) favorites.splice(idx,1);
  saveFavorites();
  renderFavoritesList();
  try{ const btn = document.getElementById('fav-'+id); if(btn) btn.textContent = '‚ô°'; }catch(e){}
}

function bukaFavorites(){
  const popup = document.getElementById('favoritesPopup');
  const wrap = document.getElementById('favoritesList');
  if(!popup || !wrap) return;
  renderFavoritesList();
  popup.style.display = 'flex';
}

function tutupFavorites(){ const p = document.getElementById('favoritesPopup'); if(p) p.style.display='none'; }

let activeSubtab = { tiktok: 'tiktokBasic', rekber: 'rekberBasic' };

function renderCategory(cat){
  const target = document.getElementById(cat);
  if(!target) return;
  target.innerHTML = '';
  const list = products.filter(p=>p.kategori===cat);
  if(list.length===0){
    target.innerHTML = '<p class="no-results">Tidak ada produk.</p>';
    return;
  }
  list.forEach(p=>{
    target.innerHTML += `
      <div class="produk" id="box-${p.id}" data-name="${p.nama.toLowerCase()}">
        <div class="produk-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="flex:1;"><h4>${p.nama}</h4><span class="small">${p.deskripsi}</span></div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="harga">${formatRupiah(p.harga)}</span>
            <button class="fav-btn" id="fav-${p.id}" onclick="toggleFavorite('${p.id}','${p.nama}',${p.harga})">${ isFavorited(p.id) ? '‚ô•' : '‚ô°' }</button>
          </div>
        </div>
        <p class="small">Stok tersisa: <strong id="stok-${p.id}">${p.stok}</strong></p>
        <div class="kontrol">
          <div class="jumlah">
            <button onclick="ubahJumlah('${p.id}-qty',-1)">-</button>
            <input id="${p.id}-qty" type="number" value="0" min="0" max="${p.stok}">
            <button onclick="ubahJumlah('${p.id}-qty',1)">+</button>
          </div>
          <button class="tambah-btn" id="btn-${p.id}" onclick="tambahKeranjang('${p.id}')" ${p.stok<=0?'disabled':''}>üõí</button>
        </div>
      </div>`;
  });
}

function performSearch(cat, addToHistory = true){
  const inputEl = document.getElementById('search-' + cat);
  const q = inputEl ? inputEl.value.trim() : '';
  if(addToHistory && q !== ''){
    const termLower = q.toLowerCase();
    const exists = searchHistory.findIndex(s => s.term.toLowerCase() === termLower && s.category === cat);
    if(exists !== -1){
      const item = searchHistory.splice(exists,1)[0];
      searchHistory.unshift(item);
    } else {
      searchHistory.unshift({term: q, category: cat, date: new Date().toLocaleString()});
      if(searchHistory.length > 100) searchHistory.pop();
    }
  }
  filterCategory(cat, q);
  highlightMatches(cat, q);
}

function highlightMatches(cat, q){
  const container = document.getElementById(cat);
  if(!container) return;
  const items = Array.from(container.querySelectorAll('.produk'));
  const ql = (q||'').trim().toLowerCase();
  let firstShown = null;
  items.forEach(it =>{
    const titleEl = it.querySelector('h4');
    if(!titleEl) return;
    const orig = titleEl.getAttribute('data-orig') || titleEl.textContent;
    titleEl.setAttribute('data-orig', orig);
    const lower = orig.toLowerCase();
    if(ql !== '' && lower.includes(ql)){
      const regex = new RegExp('('+ql.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+')','ig');
      titleEl.innerHTML = orig.replace(regex, '<mark>$1</mark>');
      if(!firstShown) firstShown = it;
    } else {
      titleEl.innerHTML = orig;
    }
  });
  if(firstShown){
    firstShown.scrollIntoView({behavior:'smooth', block:'center'});
  }
}

function filterCategory(cat, query){
  const q = (query||'').trim().toLowerCase();
  const container = document.getElementById(cat);
  if(!container) return;
  const items = Array.from(container.querySelectorAll('.produk'));
  let anyVisible = false;
  items.forEach(it=>{
    const name = it.getAttribute('data-name') || it.innerText.toLowerCase();
    if(q === '' || name.includes(q)){
      it.style.display = 'block';
      anyVisible = true;
    } else {
      it.style.display = 'none';
    }
  });
  const noEl = document.getElementById('no-' + cat);
  if(noEl){
    if(!anyVisible && q !== ''){
      noEl.textContent = '‚ùå Tidak ada produk yang sesuai di kategori ini.';
      noEl.style.display = 'block';
    } else {
      noEl.textContent = '';
      noEl.style.display = 'none';
    }
  } else {
    const existingNo = container.querySelector('.no-results-search');
    if(!anyVisible && q !== ''){
      if(!existingNo){
        const p = document.createElement('p');
        p.className = 'no-results no-results-search';
        p.textContent = 'Tidak ada produk yang sesuai.';
        container.appendChild(p);
      }
    } else {
      if(existingNo) existingNo.remove();
    }
  }
}

function setActiveTab(tabId){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const el = document.getElementById('tab-' + tabId);
  if(el) el.classList.add('active');
  document.getElementById('tiktok').style.display = (tabId==='tiktok')?'block':'none';
  document.getElementById('otp').style.display = (tabId==='otp')?'block':'none';
  document.getElementById('rekber').style.display = (tabId==='rekber')?'block':'none';
  activeTab = tabId;
}
function setActiveSubtab(tabName, subId){
  if(tabName==='tiktok'){
    document.getElementById('sub-tiktokBasic').classList.remove('active');
    document.getElementById('sub-tiktokPremium').classList.remove('active');
    document.getElementById(subId==='tiktokPremium'?'sub-tiktokPremium':'sub-tiktokBasic').classList.add('active');
    document.getElementById('tiktokBasic').style.display = (subId==='tiktokBasic')?'block':'none';
    document.getElementById('tiktokPremium').style.display = (subId==='tiktokPremium')?'block':'none';
    document.getElementById('search-wrap-tiktokBasic').style.display = (subId==='tiktokBasic')?'block':'none';
    document.getElementById('search-wrap-tiktokPremium').style.display = (subId==='tiktokPremium')?'block':'none';
    activeSubtab.tiktok = subId;
  }
  if(tabName==='rekber'){
    document.getElementById('sub-rekberBasic').classList.remove('active');
    document.getElementById('sub-rekberPremium').classList.remove('active');
    document.getElementById(subId==='rekberPremium'?'sub-rekberPremium':'sub-rekberBasic').classList.add('active');
    document.getElementById('rekberBasic').style.display = (subId==='rekberBasic')?'block':'none';
    document.getElementById('rekberPremium').style.display = (subId==='rekberPremium')?'block':'none';
    document.getElementById('search-wrap-rekberBasic').style.display = (subId==='rekberBasic')?'block':'none';
    document.getElementById('search-wrap-rekberPremium').style.display = (subId==='rekberPremium')?'block':'none';
    activeSubtab.rekber = subId;
  }
}
function bukaTab(id, el){ setActiveTab(id); }
function bukaSubtab(subId, subBtnId){
  let tabName = 'tiktok';
  if(subId.startsWith('rekber')) tabName = 'rekber';
  else if(subId.startsWith('tiktok')) tabName = 'tiktok';
  setActiveSubtab(tabName, subId);
  try{
    if(subBtnId){
      const btn = document.getElementById(subBtnId);
      if(btn && btn.parentElement){
        btn.parentElement.querySelectorAll('div').forEach(d=>d.classList.remove('active'));
        btn.classList.add('active');
      }
    }
  }catch(e){
    console.error('bukaSubtab helper error', e);
  }
}

function invalidateVouchers(reason){
  if(activeVouchers.length === 0) return;
  activeVouchers = [];
  const popup = document.getElementById('popup');
  if(popup.style.display === 'flex'){
    const statusEl = document.getElementById('voucherStatus');
    if(statusEl) statusEl.textContent = '';
    updateTotalDisplay();
  }
  alert('Perhatian: Voucher dibatalkan karena ' + reason + '. Silakan masukkan kode voucher lagi jika ingin diskon.');
}

function ubahJumlah(qid,delta){
  const input = document.getElementById(qid);
  if(!input) return;
  const max = parseInt(input.max || input.getAttribute('max') || '0');
  const val = parseInt(input.value || '0') + delta;
  input.value = Math.min(Math.max(val,0), max);
}

function tambahKeranjang(pid){
  const input = document.getElementById(pid + '-qty') || (document.getElementById('box-' + pid) && document.getElementById('box-' + pid).querySelector('input[type=number]')) || document.querySelector('input[id$="' + pid + '"]');
  if(!input) return alert('Gagal menemukan input jumlah untuk produk. Coba refresh halaman.');
  const jumlah = parseInt(input.value||'0');
  if(isNaN(jumlah) || jumlah <= 0) return alert('Atur jumlah dulu!');
  const prod = products.find(x=>x.id===pid);
  if(!prod) return alert('Produk tidak ditemukan.');
  if(jumlah > prod.stok) return alert('Stok tidak cukup!');
  if(activeVouchers.length > 0) invalidateVouchers('keranjang berubah (tambah produk)');
  const idx = keranjang.findIndex(k=>k.id===pid);
  if(idx !== -1) keranjang[idx].jumlah += jumlah;
  else keranjang.push({id:pid, nama:prod.nama, harga:prod.harga, jumlah, deskripsi:prod.deskripsi});
  input.value = 0;
  updateCountKeranjang();
}

function updateCountKeranjang(){ document.getElementById('countKeranjang').textContent = keranjang.reduce((a,b)=>a+b.jumlah,0); }

function bukaPopup(){
  if(keranjang.length===0) return alert('Keranjang kosong!');
  const popup = document.getElementById('popup'); const detail = document.getElementById('detailPesanan'); detail.innerHTML=''; let total=0;
  keranjang.forEach((item,index)=>{ let subtotal=item.harga*item.jumlah; total+=subtotal; detail.innerHTML += `
    <div style="margin-bottom:10px;border-bottom:1px solid #ddd;padding-bottom:8px;">
      <strong>${item.nama}</strong> x${item.jumlah}<br>
      <small>${item.deskripsi}</small><br>
      <span>Subtotal: ${formatRupiah(subtotal)}</span><br>
      <button onclick="hapusItem(${index})" style="margin-top:5px;background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:8px;">Hapus</button>
    </div>`;
  });

  // add voucher input area and total display placeholder
  detail.innerHTML += `
    <div style="margin-top:10px;">
      <label><strong>Masukkan Kode Voucher:</strong></label><br>
      <input id="voucherInput" type="text" placeholder="Masukkan kode voucher (jika ada)" style="width:100%;padding:8px;margin-top:5px;border-radius:8px;border:1px solid #ccc;">
      <button onclick="activateVoucherByInput()" style="margin-top:6px;background:#b58900;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Aktifkan Voucher</button>
    </div>
    <p id="voucherStatus" style="font-weight:bold;color:#b58900;"></p>
    <div id="totalArea"></div>
  `;
  popup.style.display='flex';
  popup.dataset.rawTotal = total;

  // set initial total display (uses helper)
  updateTotalDisplay();

  const statusEl = document.getElementById('voucherStatus');
  if(activeVouchers.length>0){
    updateActiveVoucherDisplay();
  } else {
    statusEl.textContent = '';
  }
}

function updateTotalDisplay(){
  const popup = document.getElementById('popup');
  const raw = Number(popup.dataset.rawTotal || 0);
  const disc = calcTotalDiscount();
  const totalArea = document.getElementById('totalArea');
  if(!totalArea) return;
  if(disc > 0){
    totalArea.innerHTML = `<p><strong><span class="strike">${formatRupiah(raw)}</span> <span class="discounted">${formatRupiah(Math.max(raw - disc,0))}</span></strong></p>`;
  } else {
    totalArea.innerHTML = `<p><strong id="totalDisplay">Total: ${formatRupiah(raw)}</strong></p>`;
  }
}



function activateVoucherByInput(){
  // Validasi total pesanan untuk voucher: minimal Rp10.000
  try{
    const popup = document.getElementById('popup');
    let totalSelected = 0;
    if(popup){
      const sel = popup.dataset.selectedTotal;
      const raw = popup.dataset.rawTotal;
      totalSelected = Number(typeof sel !== 'undefined' ? (sel || raw || 0) : (raw || 0));
    } else {
      // fallback: compute from keranjang and checkboxes if popup not open
      if(typeof keranjang !== 'undefined' && keranjang.length > 0){
        totalSelected = keranjang.reduce((a,b)=>a + (b.harga*b.jumlah), 0);
      }
    }
    // if totalSelected is less than 10000, disallow voucher activation
    if(Number(totalSelected) < 10000){
      const statusEl = document.getElementById('voucherStatus') || document.getElementById('voucherInput');
      if(statusEl) statusEl.textContent = 'Voucher hanya bisa dipakai untuk pesanan minimal Rp10.000.';
      alert('Voucher hanya bisa dipakai untuk pesanan minimal Rp10.000.');
      return;
    }
  }catch(e){
    console.error('voucher min-total check error', e);
  }

  const code = document.getElementById('voucherInput').value.trim().toUpperCase();
  const status = document.getElementById('voucherStatus');
  if(!code) return status.textContent='Masukkan kode voucher dulu ‚ùó';

  // enforce one voucher per order
  if(activeVouchers.length >= 1) return status.textContent = 'Hanya 1 voucher per pesanan. Hapus voucher aktif jika ingin ganti.';

  // search in general vouchers and VIP daily vouchers (but VIP daily only allowed if it's today)
  let found = (voucherData || []).find(v=>v.code===code);
  let fromVipDaily = false;
  if(!found){
    found = (vipState.dailyVouchers || []).find(v=>v.code===code);
    fromVipDaily = !!found;
  }
  if(!found) return status.textContent='Kode voucher tidak ditemukan ‚ùå';
  if(found.used) return status.textContent='Voucher sudah digunakan ‚ùå';
  if(isExpired(found)) return status.textContent='Voucher sudah kedaluwarsa ‚ùå';

  // VIP daily vouchers can only be activated on their date, but should NOT be marked 'used' until checkout
  if(fromVipDaily){
    const today = todayDateOnly();
    const voucherDate = new Date(found.dateStr);
    if(!isSameDate(today, voucherDate)) return status.textContent='Voucher VIP ini belum tersedia. Muncul pada: ' + new Date(found.dateStr).toLocaleDateString() + ' ‚è≥';
    // Do NOT set found.used = true here ‚Äî reserve it in activeVouchers until checkout
  }

  if(activeVouchers.includes(code)) return status.textContent='Voucher sudah aktif di keranjang ‚úÖ';

    // detect voucher source automatically
  let source = 'promo';
  if(/^VIPD\-/.test(code)) source = 'vip';
  else if(/^LVL[\-\_ ]/.test(code)) source = 'rank';
  else if(/^ADM\-|^ADMIN\-/.test(code)) source = 'admin';
  // if VIP source, ensure VIP active and date matches if daily voucher
  if(source === 'vip'){
    if(!vipState.active) return status.textContent = 'Voucher VIP tidak aktif (belum beli VIP) ‚ùå';
    // if vip daily voucher check date
    const vv = (vipState.dailyVouchers||[]).find(vv=>vv.code===code);
    if(vv){
      const today = todayDateOnly();
      const vDate = new Date(vv.dateStr);
      if(!isSameDate(today, vDate)) return status.textContent = 'Voucher VIP ini belum tersedia. Muncul pada: ' + new Date(vv.dateStr).toLocaleDateString() + ' ‚è≥';
    }
  }
  // store source mapping for display
  voucherSourceMap[code] = source;
  activeVouchers.push(code);
  // source mapping set above

  const _label_act = getVoucherLabel(code, found.value, source); status.textContent = _label_act + ' aktif di keranjang! ‚úÖ';

  // immediately add pill inside popup and update displays
  try{ addVoucherPillToPopup(code); }catch(e){ console.error('add pill failed', e); }
  updateActiveVoucherDisplay();
  updateTotalDisplay();
  renderVIPDailyList(); // refresh so UI shows it's reserved (we'll show "aktif di keranjang")
}








function updateActiveVoucherDisplay(){
  // Update voucher UI without duplicates. If popup has pillWrap, show only pill there and hide the top status.
  const status = document.getElementById('voucherStatus');
  const unique = [...new Set(activeVouchers)];

  // remove empty status if no active vouchers
  if(!status){
    return;
  }

  const detail = document.getElementById('detailPesanan');
  const pillWrap = detail ? detail.querySelector('.voucher-pill-wrap') : null;

  // If there are no active vouchers, clear both pillWrap and status
  if(unique.length === 0){
    status.textContent = '';
    if(pillWrap) pillWrap.remove();
    updateTotalDisplay();
    return;
  }

  // If pillWrap exists in popup, prefer showing the single pill(s) inside popup.
  if(pillWrap){
    // ensure pillWrap contains exactly the active vouchers (no duplicates)
    // remove any pills that are not active
    const existing = Array.from(pillWrap.querySelectorAll('[data-voucher]')).map(el => el.getAttribute('data-voucher'));
    // remove extras
    existing.forEach(code => { if(!unique.includes(code)) { const el = pillWrap.querySelector(`[data-voucher="${code}"]`); if(el) el.remove(); }});
    // add missing pills
    unique.forEach(code => {
      if(!pillWrap.querySelector(`[data-voucher="${code}"]`)){
        const span = document.createElement('span');
        span.setAttribute('data-voucher', code);
        span.style.display = 'inline-block';
        span.style.background = '#eef2ff';
        span.style.border = '1px solid #dbeafe';
        span.style.padding = '6px';
        span.style.borderRadius = '8px';
        span.style.marginRight = '6px';
        span.style.marginBottom = '6px';
        try{ const _vv = (voucherData||[]).find(x=>x.code===code) || (vipState.dailyVouchers||[]).find(x=>x.code===code) || {value:0}; const _label = getVoucherLabel(code, _vv.value, voucherSourceMap[code]||'promo'); span.innerHTML = _label + ' <br/>' + `${code} <button style="margin-left:6px;border:none;background:transparent;color:#ef4444;cursor:pointer;font-weight:700" onclick="removeActiveVoucher('${code}')">Hapus</button>`; }catch(e){ span.innerHTML = `${code} <button style="margin-left:6px;border:none;background:transparent;color:#ef4444;cursor:pointer;font-weight:700" onclick="removeActiveVoucher('${code}')">Hapus</button>`; }
        pillWrap.appendChild(span);
      }
    });
    // hide the top status to avoid duplicate visuals
    status.textContent = '';
  } else {
    // when no pillWrap, render concise status area with pills
    let html = ''; try{ const v0 = (voucherData||[]).find(x=>x.code===unique[0]) || (vipState.dailyVouchers||[]).find(x=>x.code===unique[0]) || {value:0}; const lbl = getVoucherLabel(unique[0], v0.value, voucherSourceMap[unique[0]]||'promo'); html += `<div style="font-weight:700;margin-bottom:6px;">${lbl}</div>`; }catch(e){}
    html += '<div style="margin-top:6px;">';
    unique.forEach(code=>{
      html += `<span style="display:inline-block;background:#eef2ff;border:1px solid #dbeafe;padding:6px;border-radius:8px;margin-right:6px;margin-bottom:6px;">${code} <button onclick="removeActiveVoucher('${code}')" style="margin-left:6px;border:none;background:transparent;color:#ef4444;cursor:pointer;font-weight:700">Hapus</button></span>`;
    });
    html += '</div>';
    status.innerHTML = html + ' ‚úÖ';
    // build small source line
    try{
      const src = voucherSourceMap[unique[0]] || '';
      let srcHtml = '';
      if(src === 'vip') srcHtml = '<div style="font-size:13px;color:#D4AF37;margin-top:6px;font-weight:600">üíé Voucher dari VIP ‚Äî berlaku sampai: ' + (vipState.expires ? new Date(vipState.expires).toLocaleDateString() : '-') + '</div>';
      else if(src === 'admin') srcHtml = '<div style="font-size:13px;color:#3B82F6;margin-top:6px;font-weight:600">üßæ Voucher dari Admin ‚Äî voucher diskon manual</div>';
      else if(src === 'rank') srcHtml = '<div style="font-size:13px;color:#10B981;margin-top:6px;font-weight:600">üéüÔ∏è Voucher Rank</div>';
      else if(src === 'promo') srcHtml = '<div style="font-size:13px;color:#10B981;margin-top:6px;font-weight:600">üéüÔ∏è Voucher promo</div>';
      if(srcHtml) status.innerHTML += srcHtml;
    }catch(e){console.error('src summary err',e);}

  }

  // attach remove handlers in status if any
  const buttons = status.querySelectorAll('button[onclick^="removeActiveVoucher"]');
  buttons.forEach(b=>{
    // onclick already set via markup; leave as is
  });

  // update totals
  updateTotalDisplay();

  // debounce a light refresh of vip list so reserved markers reflect state without heavy reflows
  if(window._vipRenderDebounce) clearTimeout(window._vipRenderDebounce);
  window._vipRenderDebounce = setTimeout(()=>{ renderVIPDailyList(); window._vipRenderDebounce = null; }, 120);
}







function calcTotalDiscount(){
  const unique = [...new Set(activeVouchers)];
  let sum = 0;
  unique.forEach(code=>{
    const v = (voucherData || []).find(x=>x.code===code);
    if(v && !isExpired(v)) sum += v.value;
    const vv = (vipState.dailyVouchers || []).find(x=>x.code===code);
    if(vv && !isExpired(vv)) sum += vv.value;
  });
  return sum;
}



function removeActiveVoucher(code){
  activeVouchers = activeVouchers.filter(c=>c!==code);
  try{ removeVoucherPillFromPopup(code); }catch(e){console.error('remove pill error', e);} 
  // update displays
  updateActiveVoucherDisplay();
  updateTotalDisplay();
  renderVIPDailyList(); // refresh so reservation status is removed
  const status = document.getElementById('voucherStatus');
  if(status && activeVouchers.length===0) status.textContent = '';
}

// Ensure voucher pill appears immediately inside popup when active (prevents needing to close/reopen)

function addVoucherPillToPopup(code){
  try{
    const status = document.getElementById('voucherStatus');
    // update concise status text first
    updateActiveVoucherDisplay();

    const detail = document.getElementById('detailPesanan');
    if(!detail) return;
    // find or create a container for voucher pills inside detailPesanan
    let pillWrap = detail.querySelector('.voucher-pill-wrap');
    if(!pillWrap){
      pillWrap = document.createElement('div');
      pillWrap.className = 'voucher-pill-wrap';
      pillWrap.style.marginTop = '8px';
      // insert after the voucher input group if exists, else append
      const voucherInput = detail.querySelector('#voucherInput');
      if(voucherInput && voucherInput.parentElement){
        voucherInput.parentElement.parentElement.insertBefore(pillWrap, voucherInput.parentElement.nextSibling);
      } else {
        detail.appendChild(pillWrap);
      }
    }
    // ensure we don't duplicate the same pill
    if(!pillWrap.querySelector(`[data-voucher="${code}"]`)){
      const span = document.createElement('span');
      span.setAttribute('data-voucher', code);
      span.style.display = 'inline-block';
      span.style.background = '#eef2ff';
      span.style.border = '1px solid #dbeafe';
      span.style.padding = '6px';
      span.style.borderRadius = '8px';
      span.style.marginRight = '6px';
      span.style.marginBottom = '6px';
      try{ const _vv = (voucherData||[]).find(x=>x.code===code) || (vipState.dailyVouchers||[]).find(x=>x.code===code) || {value:0}; const _label = getVoucherLabel(code, _vv.value, voucherSourceMap[code]||'promo'); span.innerHTML = _label + ' <br/>' + `${code} <button style="margin-left:6px;border:none;background:transparent;color:#ef4444;cursor:pointer;font-weight:700" onclick="removeActiveVoucher('${code}')">Hapus</button>`; }catch(e){ span.innerHTML = `${code} <button style="margin-left:6px;border:none;background:transparent;color:#ef4444;cursor:pointer;font-weight:700" onclick="removeActiveVoucher('${code}')">Hapus</button>`; }
      // add source label
      try{
        const src = voucherSourceMap[code] || '';
        let label = '';
        if(src === 'vip') label = '<div style="font-size:12px;color:#D4AF37;margin-top:6px;font-weight:600">üíé Voucher dari VIP</div>';
        else if(src === 'admin') label = '<div style="font-size:12px;color:#3B82F6;margin-top:6px;font-weight:600">üßæ Voucher dari Admin</div>';
        else if(src === 'rank') label = '<div style="font-size:12px;color:#10B981;margin-top:6px;font-weight:600">üéüÔ∏è Voucher Rank</div>';
        else if(src === 'promo') label = '<div style="font-size:12px;color:#10B981;margin-top:6px;font-weight:600">üéüÔ∏è Voucher promo</div>';
        if(label) span.innerHTML += label;
      }catch(e){console.error('label add err',e);}
      
      pillWrap.appendChild(span);
    }
  }catch(e){
    console.error('addVoucherPillToPopup error', e);
  }
}


// Remove pill DOM from popup if present
function removeVoucherPillFromPopup(code){
  try{
    const detail = document.getElementById('detailPesanan');
    if(!detail) return;
    const pillWrap = detail.querySelector('.voucher-pill-wrap');
    if(!pillWrap) return;
    const el = pillWrap.querySelector(`[data-voucher="${code}"]`);
    if(el) el.remove();
    // if empty, remove the wrapper
    if(pillWrap && pillWrap.children.length === 0) pillWrap.remove();
  }catch(e){
    console.error('removeVoucherPillFromPopup error', e);
  }
}



function hapusItem(index){
  keranjang.splice(index,1);
  updateCountKeranjang();
  invalidateVouchers('keranjang berubah (hapus produk)');
  if(keranjang.length>0) bukaPopup();
  else { document.getElementById('popup').style.display='none'; }
}



function buatPesanan(){
  if(keranjang.length===0) return alert('Keranjang kosong!');
  const metode = document.getElementById('metode').value;
  const catatan = document.getElementById('catatan').value || '-';
  let totalBefore = 0;
  keranjang.forEach(item=>{ totalBefore += item.harga * item.jumlah; 
  try{ renderInsight(true); }catch(e){ console.warn('Insight update failed', e); }
});
  const totalDisc = calcTotalDiscount();
  const totalAfter = Math.max(totalBefore - totalDisc, 0);

  
  // update member total belanja dan cek level
  try{ if(typeof updateMemberOnPurchase === 'function'){ updateMemberOnPurchase(totalAfter); } }catch(e){ console.error('member update err', e); }
// build WA message with VIP-specific notes (use real newlines so they are encoded correctly)
  const profileName = localStorage.getItem('profileName');
  let pesanWA = `Halo, saya${profileName ? ' ' + profileName : ''} ingin memesan:

`;
  keranjang.forEach(item=>{
    pesanWA += `‚Ä¢ ${item.nama} x${item.jumlah} (${formatRupiah(item.harga * item.jumlah)})\n`;
  });
  pesanWA += `\nTotal sebelum diskon: ${formatRupiah(totalBefore)}\n`;
  if(totalDisc>0){
    // Determine if the active vouchers include any VIP daily voucher codes
    const vipCodes = (vipState.dailyVouchers || []).map(v=>v.code);
    const activeVip = activeVouchers.filter(c => vipCodes.includes(c));
    if(activeVip.length > 0){
      pesanWA += `Diskon: ${formatRupiah(totalDisc)} (Voucher VIP)\n`;
      pesanWA += `Voucher aktif: ${activeVouchers.join(', ')}\n`;
    } else {
      pesanWA += `Diskon: ${formatRupiah(totalDisc)}\n`;
      pesanWA += `Voucher aktif: ${activeVouchers.join(', ')}\n`;
    }
  } else {
    pesanWA += `Diskon: ${formatRupiah(0)}\n`;
  }
  pesanWA += `Total bayar: ${formatRupiah(totalAfter)}\nMetode: ${metode}\nCatatan: ${catatan}\n`;

  // VIP section: if user is VIP, append VIP status + today's voucher info
  if(vipState.active){
    pesanWA += `\n== Info VIP ==\nVIP aktif sampai: ${new Date(vipState.expires).toLocaleString()}\n`;
    const tv = vipState.dailyVouchers ? vipState.dailyVouchers.find(v => isSameDate(new Date(v.dateStr), todayDateOnly())) : null;
    if(tv){
      const usedText = tv.used ? ' (sudah dipakai)' : ' (tersedia hari ini)';
      pesanWA += `Voucher VIP hari ini: ${tv.code} ‚Äî diskon ${formatRupiah(tv.value)}${usedText}\n`;
    } else {
      pesanWA += 'Tidak ada voucher VIP hari ini.\n';
    }
  } else {
    // not VIP: push admin notification and include short note in WA message
    const msg = 'Promo VIP: Beli Tiket VIP Rp15.000 untuk dapat voucher diskon Rp1.000/hari selama 30 hari.';
    notifikasi.unshift(msg);
    if(notifikasi.length > 100) notifikasi.pop();
    pesanWA += '\nInfo: Kamu belum memiliki tiket VIP ‚Äî segera aktifkan tiket VIP (harga Rp15.000) untuk dapat voucher harian 1.000';
  }

  // mark vouchers used as used (general vouchers and vip daily)
  activeVouchers.forEach(code=>{
    let v = voucherData.find(x=>x.code===code);
    if(v) v.used = true;
    let vv = vipState.dailyVouchers.find(x=>x.code===code);
    if(vv) vv.used = true;
  });

  // --- decrease stock for ordered items (fix for stok not berkurang) ---
  keranjang.forEach(item=>{
    const prod = products.find(x=>x.id===item.id);
    if(prod){
      prod.stok = Math.max(prod.stok - item.jumlah, 0);
      const stokEl = document.getElementById('stok-' + prod.id);
      if(stokEl) stokEl.textContent = prod.stok;
      const qtyInput = document.getElementById(prod.id + '-qty');
      if(qtyInput){
        qtyInput.max = prod.stok;
        if(parseInt(qtyInput.value||0) > prod.stok) qtyInput.value = prod.stok;
      }
      const btn = document.getElementById('btn-' + prod.id);
      if(btn){ if(prod.stok <= 0) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled'); }
    }
  });

  history.push({ items: keranjang.map(k=>({id:k.id,nama:k.nama,jumlah:k.jumlah,harga:k.harga,deskripsi:k.deskripsi})), nama: keranjang.map(k=>k.nama).join(', '), jumlah: keranjang.reduce((a,b)=>a+b.jumlah,0), metode, catatan, tanggal: new Date().toLocaleString(), total: totalAfter, vouchers: [...activeVouchers] });

  keranjang = []; updateCountKeranjang();
  activeVouchers = [];
  document.getElementById('popup').style.display='none';

  const vp = document.getElementById('voucherPopup');
  if(vp.style.display==='flex') bukaVoucher();

  window.open("https://wa.me/6285769302532?text=" + encodeURIComponent(pesanWA), "_blank");
}



// VIP-related helpers
function generateCode(len=8){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let s = '';
  for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

// Create 30 daily vouchers from startDate (Date object) ‚Äî each voucher tied to a specific date, but DO NOT inject future codes into admin-visible voucherData.
// Returns array of vouchers with dateStr for clarity.
function createDailyVouchers(startDate){
  const arr = [];
  for(let i=0;i<30;i++){
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    // set expiry to end of that day
    const exp = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
    const code = 'VIPD-' + generateCode(6) + '-' + (i+1);
    arr.push({code, value:1000, expires: exp.toISOString(), used:false, dateStr: new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString()});
  }
  return arr;
}



function attemptBuyVIP(){
  const code = document.getElementById('vipInput').value.trim().toUpperCase();
  if(!code) return alert('Masukkan kode pembelian VIP yang diberikan admin.');
  const found = vipPurchaseData.find(v=>v.code === code);
  if(!found) return alert('Kode pembelian VIP tidak valid.');
  if(found.used) return alert('Kode pembelian VIP sudah dipakai.');

  // simulate payment of 15k ‚Äî di aplikasi produksi ganti dengan verifikasi pembayaran
  const ok = confirm('Konfirmasi: Bayar Rp15.000 untuk Tiket VIP selama 30 hari? (Simulasi)');
  if(!ok) return;

  // consume the admin code (mark used)
  found.used = true;

  const now = new Date();
  const daysToAdd = 30;

  if(!vipState.active){
    // activate new VIP for 30 days
    vipState.active = true;
    vipState.start = now.toISOString();
    const exp = new Date();
    exp.setDate(exp.getDate() + daysToAdd);
    vipState.expires = exp.toISOString();
    vipState.purchaseCode = code;
    // create 30 daily vouchers starting today
    vipState.dailyVouchers = createDailyVouchers(now);
  } else {
    // already active -> extend expiry by 30 days and append 30 daily vouchers after last voucher date
    const oldExp = new Date(vipState.expires);
    const newExp = new Date(oldExp);
    newExp.setDate(newExp.getDate() + daysToAdd);
    vipState.expires = newExp.toISOString();

    // find last voucher date, else start from today
    let lastDate = null;
    if(vipState.dailyVouchers && vipState.dailyVouchers.length){
      vipState.dailyVouchers.sort((a,b)=> new Date(a.dateStr) - new Date(b.dateStr));
      lastDate = new Date(vipState.dailyVouchers[vipState.dailyVouchers.length - 1].dateStr);
    } else {
      lastDate = new Date();
      lastDate.setDate(lastDate.getDate() - 1);
    }

    const startDate = new Date(lastDate);
    startDate.setDate(startDate.getDate() + 1);
    const extra = [];
    const baseIndex = vipState.dailyVouchers ? vipState.dailyVouchers.length : 0;
    for(let i=0;i<daysToAdd;i++){
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);
      const expd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
      const codev = 'VIPD-' + generateCode(6) + '-' + (baseIndex + i + 1);
      extra.push({
        code: codev,
        value: 1000,
        expires: expd.toISOString(),
        used: false,
        dateStr: new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString()
      });
    }
    vipState.dailyVouchers = (vipState.dailyVouchers || []).concat(extra);
  }

  vipState.notifiedDates = vipState.notifiedDates || [];

  alert('Berhasil: Tiket VIP aktif/ditambah selama 30 hari. Voucher harian akan tersedia sesuai tanggalnya.');
  showVIPStatus();
  renderVIPDailyList();
  checkAndNotifyDailyVoucherAvailability();

  // persist vip state to localStorage and refresh banner
  try{
    if(vipState && vipState.active){
      }
  }catch(e){}
  if(typeof renderVipBanner === 'function') renderVipBanner();

}




function showVIPStatus(){
  const box = document.getElementById('vipMsg');
  if(!box) return;
  try{
    if(vipState && vipState.active){
      const startDate = vipState.start ? new Date(vipState.start) : null;
      const expDate = vipState.expires ? new Date(vipState.expires) : null;
      const startStr = startDate ? startDate.toLocaleString() : '-';
      const expStr = expDate ? expDate.toLocaleString() : '-';
      box.innerHTML = `VIP aktif ‚Äî <div style="font-size:14px">Mulai: <strong>${startStr}</strong></div><div style="font-size:14px">Berlaku sampai: <strong>${expStr}</strong></div><div style="margin-top:6px">Kode pembelian: <span class="vip-code">${vipState.purchaseCode || ''}</span></div>`;
    } else {
      box.innerHTML = 'Anda belum memiliki Tiket VIP.';
    }
  }catch(e){
    console.error('showVIPStatus err', e);
    box.innerHTML = 'Anda belum memiliki Tiket VIP.';
  }
}
function renderVIPDailyList(){
  const wrap = document.getElementById('vipDailyList');
  if(!wrap) return;
  wrap.innerHTML = '';
  if(!vipState.active || !vipState.dailyVouchers.length){
    wrap.innerHTML = '<p class="small">Belum ada voucher harian. Aktifkan VIP memakai kode pembelian dari admin.</p>';
    return;
  }
  // sort by date
  const sorted = vipState.dailyVouchers.slice().sort((a,b)=> new Date(a.dateStr) - new Date(b.dateStr));
  const today = todayDateOnly();
  sorted.forEach(v=>{
    const vDate = new Date(v.dateStr);
    const isToday = isSameDate(today, vDate);
    const isPast = vDate < today;
    const reserved = activeVouchers.includes(v.code);
    if(isToday){
      const used = v.used;
      const expired = isExpired(v);
      let statusText = expired ? '<span class="voucher-expired">‚ùå Kadaluarsa</span>' : (used ? '<span class="voucher-expired">‚ùå Voucher telah dipakai (Tiket VIP)</span>' : (reserved ? '<span class="voucher-active">‚úÖ Aktif di keranjang</span>' : '<span class="voucher-active">‚úÖ Voucher tersedia hari ini</span>'));
      wrap.innerHTML += `<div class="voucher-item">
        <div>${getVoucherLabel(v.code, v.value, 'vip')} <em>(voucher hari ini)</em></div>
        <div class="small">${statusText} üïí Berlaku sampai: ${new Date(v.expires).toLocaleString()}</div>
        <div style="margin-top:6px;">
          <button class="btn-small" onclick="copyVoucher('${v.code}')">Salin Kode</button>
          ${used ? '' : (reserved ? '<span class="small">Voucher ini sedang aktif di keranjang.</span>' : '<span class="small">Salin kode dan masukkan di kolom Voucher saat checkout.</span>')}
        </div>
      </div>`;
    } else if(isPast){
      const used = v.used;
      const expired = isExpired(v);
      let statusText = expired ? '<span class="voucher-expired">‚ùå Kadaluarsa</span>' : (used ? '<span class="voucher-expired">‚ùå Sudah Dipakai</span>' : '<span class="voucher-active">‚úÖ Belum Dipakai</span>');
      wrap.innerHTML += `<div class="voucher-item">
        <div>${getVoucherLabel(v.code, v.value, 'vip')} <small>(sudah lewat)</small></div>
        <div class="small">${statusText} üïí Berlaku sampai: ${new Date(v.expires).toLocaleDateString()}</div>
      </div>`;
    } else {
      wrap.innerHTML += `<div class="voucher-item">
        <div><strong>Voucher akan tersedia</strong> ‚Äî ${new Date(v.dateStr).toLocaleDateString()}</div>
        <div class="small">Kode akan muncul pada tanggal tersebut dan belum dapat dipakai sebelumnya.</div>
      </div>`;
    }
  });
}


// When VIP popup or notif opened, check if any voucher becomes available today and create a notification (only once per date)
function checkAndNotifyDailyVoucherAvailability(){
  try{
    if(!vipState.active || !vipState.dailyVouchers.length) return;
    const today = todayDateOnly();
    const todayISO = today.toISOString().split('T')[0];
    if(vipState.notifiedDates && vipState.notifiedDates.includes(todayISO)) return; // already notified
    // find voucher for today
    const todays = vipState.dailyVouchers.filter(v => isSameDate(new Date(v.dateStr), today));
    if(todays && todays.length){
      notifikasi.unshift(`Voucher VIP hari ini tersedia ‚Äî cek Tiket VIP.`);
      // mark notified for today so we don't duplicate
      vipState.notifiedDates.push(todayISO);
    }
  }catch(e){
    console.error('checkAndNotifyDailyVoucherAvailability error', e);
  }
}

// voucher admin popup (now hides future VIP codes from admin list by default ‚Äî admin can still inspect vipState in console)
function bukaVoucher(){
  const popup = document.getElementById('voucherPopup');
  const list = document.getElementById('voucherList'); list.innerHTML='';
  // show only general voucherData + any VIP daily vouchers that are today or past (admin)
  voucherData.forEach(v=>{
    const expired = isExpired(v);
    const used = v.used;
    let statusText = expired ? '<span class="voucher-expired">‚ùå Kadaluarsa</span>' : (used ? '<span class="voucher-expired">‚ùå Sudah Dipakai</span>' : '<span class="voucher-active">‚úÖ Belum Dipakai</span>');
    list.innerHTML += `<div class="voucher-item">
      <div>${getVoucherLabel(v.code, v.value, 'admin')}</div>
      <div class="small">${statusText} ${expired ? '' : 'üïí Berlaku sampai: ' + new Date(v.expires).toLocaleDateString()}</div>
      <div style="margin-top:6px;">
        <button class="btn-small" onclick="copyVoucher('${v.code}')">Salin Kode</button>
      </div>
    </div>`;
  });
  // include VIP daily vouchers only if they are today or already passed (so admin can audit recent ones)
  if(vipState.dailyVouchers && vipState.dailyVouchers.length){
    const today = todayDateOnly();
    vipState.dailyVouchers.forEach(v=>{
      const vDate = new Date(v.dateStr);
      if(vDate <= today){ // show today's and past
        const expired = isExpired(v);
        const used = v.used;
        let statusText = expired ? '<span class="voucher-expired">‚ùå Kadaluarsa</span>' : (used ? '<span class="voucher-expired">‚ùå Sudah Dipakai</span>' : '<span class="voucher-active">‚úÖ Belum Dipakai</span>');
        list.innerHTML += `<div class="voucher-item">
          <div>${getVoucherLabel(v.code, v.value, 'vip')}</div>
          <div class="small">${statusText} üïí Berlaku sampai: ${new Date(v.expires).toLocaleDateString()}</div>
          <div style="margin-top:6px;">
            <button class="btn-small" onclick="copyVoucher('${v.code}')">Salin Kode</button>
          </div>
        </div>`;
      }
    });
  }
  popup.style.display='flex';
}

function tutupVoucher(){ document.getElementById('voucherPopup').style.display='none'; }

function copyVoucher(code){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(code).then(()=>{ alert('Kode voucher disalin: ' + code); }).catch(()=>{ fallbackCopy(code); });
  } else {
    fallbackCopy(code);
  }
}
function fallbackCopy(text){
  try{
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.top = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if(ok) alert('Kode voucher disalin: ' + text);
    else prompt('Salin kode manual:', text);
  }catch(e){
    prompt('Salin kode manual:', text);
  }
}

function bukaNotif(){ 
  // when opening notifications, first check VIP daily availability then show list
  checkAndNotifyDailyVoucherAvailability();
  const popup = document.getElementById('notifPopup'); const list = document.getElementById('notifList'); list.innerHTML=''; notifikasi.forEach(n=>list.innerHTML += `<p>‚Ä¢ ${n}</p>`); popup.style.display='flex'; 
}

function bukaHistory(){ 
  const popup = document.getElementById('historyPopup'); 
  const list = document.getElementById('historyList'); 
  list.innerHTML=''; 
  if(history.length===0){ 
    list.innerHTML += '<h4>History Orderan</h4><p>Belum ada pesanan</p>'; 
  } else { 
    list.innerHTML += '<h4>History Orderan</h4>'; 
    history.forEach((h,hi)=>{ list.innerHTML += `<p><strong>${h.nama}</strong> x${h.jumlah}<br>Metode: ${h.metode}<br>Catatan: ${h.catatan}<br>Tanggal: ${h.tanggal}<br>Total: ${formatRupiah(h.total)}<br>Voucher: ${h.vouchers.join(', ')}<br><button class="btn-small" onclick="beliLagi(${hi})">Beli lagi</button></p><hr>`; }); 
  } 
  if(searchHistory && searchHistory.length>0){
    list.innerHTML += '<h4>History Pencarian</h4>';
    searchHistory.forEach(s=>{ list.innerHTML += `<p>‚Ä¢ <strong>${s.term}</strong> ‚Äî kategori: ${s.category} <br><small>${s.date}</small></p>`; });
    list.innerHTML += '<hr>';
  } else {
    list.innerHTML += '<h4>History Pencarian</h4><p>Belum ada aktivitas pencarian</p><hr>';
  }
  popup.style.display='flex'; 
}
function tutupHistory(){ document.getElementById('historyPopup').style.display='none'; }
function tutupNotif(){ document.getElementById('notifPopup').style.display='none'; }
function tutupPopup(){ document.getElementById('popup').style.display='none'; }

function beliLagi(index){ if(!history || !history[index]){ alert('Riwayat tidak ditemukan.'); return; } const entry = history[index]; keranjang = []; entry.items.forEach(it=>{ keranjang.push({id:it.id,nama:it.nama,harga:it.harga,jumlah:it.jumlah,deskripsi:it.deskripsi}); }); updateCountKeranjang(); bukaPopup(); }

function getSearchHistoryForCategory(cat){
  const seen = new Set();
  const list = [];
  if(!searchHistory) return list;
  for(const s of searchHistory){
    if(s.category === cat){
      const term = s.term;
      if(!seen.has(term.toLowerCase())){
        seen.add(term.toLowerCase());
        list.push(s);
      }
    }
    if(list.length>=100) break;
  }
  return list;
}

function showSuggestions(cat, q){
  const box = document.getElementById('suggest-' + cat);
  if(!box) return;
  const ql = (q||'').trim().toLowerCase();
  if(ql.length < 1){ box.style.display='none'; box.innerHTML=''; return; }
  const last = (lastSelectedSuggestion && lastSelectedSuggestion[cat]) ? lastSelectedSuggestion[cat].toLowerCase() : '';
  const suppressed = (suppressSuggestionsUntilUserTyped && suppressSuggestionsUntilUserTyped[cat]) ? true : false;
  if(ql === last && suppressed){ box.style.display='none'; box.innerHTML=''; return; }

  const historyList = getSearchHistoryForCategory(cat);
  const matches = historyList.filter(s => s.term.toLowerCase().includes(ql)).slice(0,5);
  box.innerHTML = '';
  if(matches.length === 0){
    box.innerHTML = '<div class="suggest-empty">Tidak ada saran dari riwayat.</div>';
  } else {
    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'suggest-item';
      div.textContent = m.term;
      div.onclick = function(){ 
        const input = document.getElementById('search-' + cat);
        if(input){ input.value = m.term; performSearch(cat, false); lastSelectedSuggestion[cat] = m.term; suppressSuggestionsUntilUserTyped[cat] = true; }
        hideSuggestions(cat);
      };
      box.appendChild(div);
    });
  }
  box.style.display = 'block';
}

function hideSuggestions(cat){
  const box = document.getElementById('suggest-' + cat);
  if(box){ box.style.display = 'none'; box.innerHTML=''; }
}

function attachSuggestionHandlers(){
  const ids = ['tiktokBasic','tiktokPremium','produk-otp','rekberBasic','rekberPremium'];
  ids.forEach(cat=>{
    const input = document.getElementById('search-' + cat);
    if(input){
      input.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){ e.preventDefault(); performSearch(cat); hideSuggestions(cat); }
        if(e.key === 'Escape'){ hideSuggestions(cat); }
      });
      input.addEventListener('input', function(e){
        const cur = this.value.trim();
        if(lastSelectedSuggestion && lastSelectedSuggestion[cat] && cur.toLowerCase() !== lastSelectedSuggestion[cat].toLowerCase()){
          lastSelectedSuggestion[cat] = null;
          suppressSuggestionsUntilUserTyped[cat] = false;
        }
        if(cur === ''){ lastSelectedSuggestion[cat] = null; suppressSuggestionsUntilUserTyped[cat] = false; hideSuggestions(cat); return; }
        showSuggestions(cat, this.value);
      });
      document.addEventListener('click', function(ev){
        const box = document.getElementById('suggest-' + cat);
        if(!box) return;
        if(ev.target === input || box.contains(ev.target)) return;
        hideSuggestions(cat);
      });
    }
  });
}

function initRender(){
  renderCategory('tiktokBasic');
  renderCategory('tiktokPremium');
  renderCategory('produk-otp');
  renderCategory('rekberBasic');
  renderCategory('rekberPremium');
  setActiveTab(activeTab);
  setActiveSubtab('tiktok', activeSubtab.tiktok);
  setActiveSubtab('rekber', activeSubtab.rekber);
}

initRender();
setTimeout(attachSuggestionHandlers, 200);

// expose some helper to admin for quick adding purchase codes in console (for dev)
window.__adminAddVipPurchaseCode = function(code){
  vipPurchaseData.push({code:code.toUpperCase(), used:false});
  alert('Kode pembelian VIP ditambahkan: ' + code.toUpperCase());
};
// expose helper to view vipState in console for admin
window.__debugVipState = function(){ console.log(JSON.parse(JSON.stringify(vipState))); alert('vipState tercetak di console.'); };

// safer wrapper for opening VIP popup (prevents uncaught errors)
function bukaVIP(){
  try{
    showVIPStatus();
    renderVIPDailyList();
    checkAndNotifyDailyVoucherAvailability();
    document.getElementById('vipPopup').style.display = 'flex';
  }catch(e){
    console.error('Error membuka VIP popup', e);
    alert('Terjadi kesalahan saat membuka Tiket VIP. Coba refresh halaman atau periksa console.');
  }
}
function tutupVIP(){ document.getElementById('vipPopup').style.display='none'; }


// ===== Level Member (üéñ) logic =====
let memberState = {
  level: 'Bronze',
  totalBelanja: 0,
  rewardVouchers: [] // {code, value, expires, used, level}
};

function formatRupiah(num){ return 'Rp' + Number(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }

function bukaLevel(){
  renderLevelPopup();
  document.getElementById('levelPopup').style.display = 'flex';
}
function tutupLevel(){ document.getElementById('levelPopup').style.display = 'none'; }

function renderLevelPopup(){
  const name = document.getElementById('lvlName');
  const total = document.getElementById('lvlTotal');
  const prog = document.getElementById('lvlProgress');
  const next = document.getElementById('nextLevelInfo');
  const list = document.getElementById('rewardList');
  const badge = document.getElementById('levelBadge');

  total.textContent = formatRupiah(memberState.totalBelanja);
  name.textContent = memberState.level;

  let max = 100000, nextLvl = 'Silver', bonus = 1000;
  if(memberState.level === 'Silver'){ max = 200000; nextLvl = 'Gold'; bonus = 2000; }
  else if(memberState.level === 'Gold'){ max = 500000; nextLvl = 'Platinum'; bonus = 2000; }
  else if(memberState.level === 'Platinum'){ nextLvl = '-'; max = memberState.totalBelanja; }

  const pct = Math.min(100, Math.round((memberState.totalBelanja / (max || 1)) * 100));
  prog.style.width = pct + '%';
  next.textContent = (memberState.level === 'Platinum') ? 'Kamu sudah di level tertinggi üéâ' : `Menuju ${nextLvl} ‚Äî ${formatRupiah(max)}`;

  // update badge class
  badge.className = 'level-badge ' + (memberState.level === 'Bronze' ? 'level-bronze' : memberState.level === 'Silver' ? 'level-silver' : memberState.level === 'Gold' ? 'level-gold' : 'level-platinum');
  badge.textContent = memberState.level;

  if(memberState.rewardVouchers.length > 0){
    list.innerHTML = '';
    memberState.rewardVouchers.forEach(v => {
      list.innerHTML += `<div class="reward-item"><div><strong>${v.code}</strong> <button class="btn-small" onclick="copyVoucher('${v.code}')">Salin</button><div class="small">Diskon ${formatRupiah(v.value)}</div></div><div><small>${new Date(v.expires).toLocaleDateString()}</small></div></div>`;
    });
  } else {
    list.innerHTML = '<p class="small">Belum ada voucher bonus.</p>';
  }
}

function _generateMemberCode(prefix='LVL', len=5){
  return prefix + '-' + Math.random().toString(36).substring(2, 2+len).toUpperCase();
}

// Call this after a successful order to update member totals
function updateMemberOnPurchase(amountPaid){
  try{
    amountPaid = Number(amountPaid) || 0;
    if(amountPaid <= 0) return;
    const oldLevel = memberState.level;
    memberState.totalBelanja = (memberState.totalBelanja || 0) + amountPaid;
    // determine level
    let newLevel = 'Bronze';
    if(memberState.totalBelanja >= 500000) newLevel = 'Platinum';
    else if(memberState.totalBelanja >= 200000) newLevel = 'Gold';
    else if(memberState.totalBelanja >= 100000) newLevel = 'Silver';

    if(newLevel !== oldLevel){
      // user naik level! buat voucher bonus sesuai level
      memberState.level = newLevel;
      const value = (newLevel === 'Silver') ? 1000 : 2000;
      const code = _generateMemberCode('LVL-' + newLevel.toUpperCase(), 6);
      const exp = new Date(); exp.setMonth(exp.getMonth() + 1);
      const voucher = { code: code, value: value, expires: exp.toISOString(), used: false, source: 'member', level: newLevel };
      // add to member history
      memberState.rewardVouchers = memberState.rewardVouchers || [];
      memberState.rewardVouchers.push(voucher);
      // also add to admin-visible voucherData so user dapat pakai di checkout
      if(typeof voucherData !== 'undefined' && Array.isArray(voucherData)){
        voucherData.push({ code: voucher.code, value: voucher.value, expires: voucher.expires, used: false });
      }
      // map source for UI (optional)
      voucherSourceMap[voucher.code] = 'member';

      // show congrats and open level popup
      setTimeout(()=>{
        alert('üéâ Selamat! Kamu naik ke level ' + newLevel + '!\nKamu menerima voucher: ' + code + ' (Diskon ' + formatRupiah(value) + ', berlaku 30 hari).');
        bukaLevel();
      }, 120);
    }
  }catch(e){ console.error('updateMemberOnPurchase error', e); }
}
// ===== end Level Member logic =====


// === Tambahan v20.2: tampilkan voucher & rank di popup pesanan ===
function updateDetailPesananPopup(){
  const detailEl = document.getElementById('detailPesanan');
  if(!detailEl) return;
  if(keranjang.length===0){ detailEl.innerHTML='<p>Keranjang kosong.</p>'; return; }

  let html = '<ul>';
  let totalBefore = 0;
  keranjang.forEach(item=>{
    const subtotal = item.harga * item.jumlah;
    totalBefore += subtotal;
    html += `<li>${item.nama} x${item.jumlah} ‚Äî <strong>${formatRupiah(subtotal)}</strong></li>`;
  });
  html += '</ul>';

  const totalDisc = calcTotalDiscount ? calcTotalDiscount() : 0;
  const totalAfter = Math.max(totalBefore - totalDisc, 0);

  // tampilkan voucher aktif dan rank
  let rankInfo = userRank ? userRank.name : 'Bronze';
  let vouchers = [];
  if(activeVouchers && activeVouchers.length>0) vouchers = [...activeVouchers];
  let voucherHtml = '<p><strong>Voucher Aktif:</strong><br>'+(vouchers.length? vouchers.join(', ') : 'Tidak ada')+'</p>';

  html += `<p><strong>Rank Saat Ini:</strong> ${rankInfo}</p>`;
  html += `<p><strong>Total Sebelum Diskon:</strong> ${formatRupiah(totalBefore)}<br>`;
  html += `<strong>Total Diskon:</strong> ${formatRupiah(totalDisc)}<br>`;
  html += `<strong>Total Bayar:</strong> ${formatRupiah(totalAfter)}</p>`;
  html += voucherHtml;

  detailEl.innerHTML = html;
}

// panggil otomatis tiap kali buka popup
const old_bukaPopup = bukaPopup;
bukaPopup = function(){
  old_bukaPopup();
  updateDetailPesananPopup();
};


// Ensure favorite buttons show actual hearts (handles dynamic rendering)
function refreshFavoriteButtons(){
  try{
    document.querySelectorAll('[id^="fav-"]').forEach(btn => {
      try{
        const id = btn.id.slice(4);
        btn.textContent = (typeof isFavorited === 'function' && isFavorited(id)) ? '‚ô•' : '‚ô°';
      }catch(e){}
    });
  }catch(e){console.error('refreshFavoriteButtons err',e);}
}
window.addEventListener('load', function(){ setTimeout(refreshFavoriteButtons, 120); });
setInterval(refreshFavoriteButtons, 600);



/* ===== Added: checkbox select & auto-update total (injected v22) ===== */
// Preserve original functions if present
if(!window._orig_bukaPopup) window._orig_bukaPopup = window.bukaPopup || null;
if(!window._orig_buatPesanan) window._orig_buatPesanan = window.buatPesanan || null;
if(!window._orig_updateTotalDisplay) window._orig_updateTotalDisplay = window.updateTotalDisplay || null;

function toggleSelectAll(el){
  const detail = document.getElementById('detailPesanan');
  if(!detail) return;
  const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
  cbs.forEach(cb => { cb.checked = el.checked; });
  updateSelectedTotal();
}

function updateSelectedTotal(){
  const popup = document.getElementById('popup');
  const detail = document.getElementById('detailPesanan');
  if(!popup || !detail) return;
  const checkboxes = Array.from(detail.querySelectorAll('.itemCheckbox'));
  if(checkboxes.length === 0){
    popup.dataset.selectedTotal = popup.dataset.rawTotal || '0';
    // call existing updateTotalDisplay (may be overridden later)
    if(typeof window.updateTotalDisplay === 'function') window.updateTotalDisplay();
    return;
  }
  let selTotal = 0;
  checkboxes.forEach(cb=>{
    try{
      if(cb.checked){
        const idx = parseInt(cb.getAttribute('data-index'));
        const item = keranjang[idx];
        if(item) selTotal += (item.harga * item.jumlah);
      }
    }catch(e){}
  });
  popup.dataset.selectedTotal = String(selTotal);
  if(typeof window.updateTotalDisplay === 'function') window.updateTotalDisplay();
}

// New bukaPopup that renders checkboxes (overrides previous)
function _v22_bukaPopup(){
  if(keranjang.length===0) return alert('Keranjang kosong!');
  const popup = document.getElementById('popup'); 
  const detail = document.getElementById('detailPesanan'); 
  detail.innerHTML=''; 
  let total=0;

  // header pilih semua
  detail.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
    <input type='checkbox' id='selectAll' onchange='toggleSelectAll(this)'>
    <label for='selectAll' style='margin:0;'><strong>Pilih Semua</strong></label>
  </div>`;

  keranjang.forEach((item,index)=>{ 
    let subtotal = item.harga * item.jumlah; 
    total += subtotal; 
    // each item row includes a checkbox (default checked)
    detail.innerHTML += `
      <div style="margin-bottom:10px;border-bottom:1px solid #ddd;padding-bottom:8px;display:flex;align-items:flex-start;gap:8px;">
        <input type='checkbox' class='itemCheckbox' data-index='${index}' checked style='margin-top:6px;'>
        <div style='flex:1'>
          <strong>${item.nama}</strong> x${item.jumlah}<br>
          <small>${item.deskripsi}</small><br>
          <span>Subtotal: ${formatRupiah(subtotal)}</span><br>
          <button onclick="hapusItem(${index})" style="margin-top:5px;background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:8px;">Hapus</button>
        </div>
      </div>`;
  });

  // add voucher input area and total display placeholder
  detail.innerHTML += `
    <div style="margin-top:10px;">
      <label><strong>Masukkan Kode Voucher:</strong></label><br>
      <input id="voucherInput" type="text" placeholder="Masukkan kode voucher (jika ada)" style="width:100%;padding:8px;margin-top:5px;border-radius:8px;border:1px solid #ccc;">
      <button onclick="activateVoucherByInput()" style="margin-top:6px;background:#b58900;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Aktifkan Voucher</button>
    </div>
    <p id="voucherStatus" style="font-weight:bold;color:#b58900;"></p>
    <div id="totalArea"></div>
  `;

  popup.style.display='flex';
  popup.dataset.rawTotal = total;
  // initialize selectedTotal as full total (all checked)
  popup.dataset.selectedTotal = total;

  // attach onchange listeners to item checkboxes and selectAll control
  try{
    setTimeout(function(){
      const detailEl = document.getElementById('detailPesanan');
      const cbs = Array.from(detailEl.querySelectorAll('.itemCheckbox'));
      cbs.forEach(cb=>{ cb.addEventListener('change', function(){
        checkRekberRequirement();
        const all = Array.from(detailEl.querySelectorAll('.itemCheckbox'));
        const selAll = document.getElementById('selectAll');
        if(all.length > 0){
          const allChecked = all.every(x=>x.checked);
          if(selAll) selAll.checked = allChecked;
        }
        updateSelectedTotal();
        checkRekberRequirement();
      }); });
      const sel = document.getElementById('selectAll');
      if(sel) sel.addEventListener('change', function(){ toggleSelectAll(this); updateSelectedTotal();
        checkRekberRequirement(); });
      // initial update for selected total (all checkboxes default checked)
      updateSelectedTotal();
        checkRekberRequirement();
    }, 20);
  }catch(e){ console.error('attach checkbox listeners err', e); }

  const statusEl = document.getElementById('voucherStatus');
  if(activeVouchers.length>0){
    if(typeof updateActiveVoucherDisplay === 'function') updateActiveVoucherDisplay();
  } else {
    if(statusEl) statusEl.textContent = '';
  }
}

// New updateTotalDisplay that prefers selected total when available
function _v22_updateTotalDisplay(){
  const popup = document.getElementById('popup');
  if(!popup) return;
  const rawAll = Number(popup.dataset.rawTotal || 0);
  const selectedStr = popup.dataset.selectedTotal;
  const raw = (typeof selectedStr !== 'undefined') ? Number(selectedStr || 0) : rawAll;
  const disc = calcTotalDiscount();
  const totalArea = document.getElementById('totalArea');
  if(!totalArea) return;
  if(disc > 0){
    totalArea.innerHTML = `<p><strong><span class="strike">${formatRupiah(raw)}</span> <span class="discounted">${formatRupiah(Math.max(raw - disc,0))}</span></strong></p>`;
  } else {
    totalArea.innerHTML = `<p><strong id="totalDisplay">Total: ${formatRupiah(raw)}</strong></p>`;
  }
}

// New buatPesanan wrapper: processes only checked items, then restores leftover items in keranjang
function _v22_buatPesanan(){
  // ensure there's a popup and detail to read checkboxes
  const detail = document.getElementById('detailPesanan');
  if(!detail) return alert('Buka popup keranjang dulu.');
  const checkboxes = Array.from(detail.querySelectorAll('.itemCheckbox'));
  if(checkboxes.length === 0){
    // fallback: call original if exists
    if(window._orig_buatPesanan) return window._orig_buatPesanan();
    return alert('Tidak ada item di keranjang.');
  }
  const checkedIndexes = checkboxes.filter(cb => cb.checked).map(cb => parseInt(cb.getAttribute('data-index')));
  if(checkedIndexes.length === 0){
    return alert('Pilih minimal 1 produk dulu!');
  }
  // prepare selected items
  const selectedItems = keranjang.filter((_,idx)=>checkedIndexes.includes(idx));


  // ===== Rekber rules enforcement (updated) =====
  // If any Rekber product is selected, enforce that:
  // - Exactly 1 related product entry must be present among selected items,
  //   where related = (Akun TikTok OR OTP). It must be exactly one entry (not zero, not more).
  try{
    const rekberItems = selectedItems.filter(it => {
      try{ const pp = products.find(x=>x.id===it.id); return pp && pp.kategori && pp.kategori.startsWith('rekber'); }catch(e){ return false; }
    });
    if(rekberItems.length > 0){
      // find entries in selectedItems that are either tiktok accounts or otp products
      const relatedEntries = selectedItems.filter(it => {
        try{ const p = products.find(pp=>pp.id===it.id); return p && p.kategori && (p.kategori.startsWith('tiktok') || p.kategori === 'produk-otp'); }catch(e){ return false; }
      });
      if(relatedEntries.length !== 1){
        alert('Untuk membeli produk Rekber Jefry Alson, wajib menyertakan tepat 1 (satu) produk: Akun TikTok atau OTP. (Tidak boleh 0 atau lebih dari 1).');
        return;
      }
      // Optionally you may enforce that the related entry has quantity 1 ‚Äî currently we only enforce entry count.
    }
  }catch(e){
    console.error('rekber rule check error', e);
  }
  // ===== end rekber rules =====


  if(selectedItems.length === 0) return alert('Tidak ada produk dipilih!');

  // preserve original keranjang, then set keranjang to selected and call original buatPesanan
  const savedKeranjang = JSON.parse(JSON.stringify(keranjang)); // deep copy simple objects
  const remaining = savedKeranjang.filter((_,idx)=>!checkedIndexes.includes(idx));
  // set keranjang to selected items (shallow copy acceptable)
  keranjang = selectedItems.map(it => ({...it}));

  // call original buatPesanan implementation if present, otherwise run minimal flow
  if(window._orig_buatPesanan){
    try{
      window._orig_buatPesanan();
    }catch(e){
      console.error('error calling original buatPesanan', e);
      alert('Gagal membuat pesanan (error internal).');
    }
  } else {
    // minimal fallback: build WA message and open WA as original does (simplified)
    let totalBefore = keranjang.reduce((a,b)=>a + (b.harga*b.jumlah), 0);
    const profileName = localStorage.getItem('profileName');
  let pesanWA = `Halo, saya${profileName ? ' ' + profileName : ''} ingin memesan:

`;
    keranjang.forEach(item=> pesanWA += `‚Ä¢ ${item.nama} x${item.jumlah} (${formatRupiah(item.harga * item.jumlah)})\n`);
    pesanWA += `\nTotal: ${formatRupiah(totalBefore)}\n`;
    window.open("https://wa.me/6285769302532?text=" + encodeURIComponent(pesanWA), "_blank");
  }

  // restore keranjang to remaining items
  keranjang = remaining;
  updateCountKeranjang();
  // close popup if empty, else refresh popup
  const popup = document.getElementById('popup');
  if(keranjang.length === 0 && popup) popup.style.display = 'none';
  else if(popup && popup.style.display === 'flex') _v22_bukaPopup();
}

/* Bind our v22 implementations to global names so UI uses them */
window.bukaPopup = _v22_bukaPopup;
window.updateTotalDisplay = _v22_updateTotalDisplay;
window.buatPesanan = _v22_buatPesanan;

console.log('Injected v22: checkbox select & auto-total ready.');
/* ===== end injected v22 ===== */




// ===== Rekber UI enforcement helpers =====
function checkRekberRequirement(){
  try{
    const popup = document.getElementById('popup');
    const detail = document.getElementById('detailPesanan');
    if(!popup || !detail) return;
    // determine if keranjang contains any rekber product
    const rekberInCart = (keranjang || []).some(it => { try{ const p = products.find(pp=>pp.id===it.id); return p && p.kategori && p.kategori.startsWith('rekber'); }catch(e){return false;} });
    // find related selected entries (tiktok or otp)
    const relatedSelected = Array.from(detail.querySelectorAll('.itemCheckbox')).map(cb => {
      try{ return { checked: cb.checked, idx: parseInt(cb.getAttribute('data-index')) }; }catch(e){ return null; }
    }).filter(Boolean).filter(x=>x.checked).map(x=> keranjang[x.idx]).filter(Boolean);
    const relatedEntries = relatedSelected.filter(it => { try{ const p = products.find(pp=>pp.id===it.id); return p && p.kategori && (p.kategori.startsWith('tiktok') || p.kategori === 'produk-otp'); }catch(e){return false;} });
    // find the checkout button inside popup (the one that calls buatPesanan)
    const checkoutBtn = document.getElementById('popup') ? document.getElementById('popup').querySelector('.btn-checkout[onclick^=\"buatPesanan\"]') : null;
    // manage banner
    let banner = detail.querySelector('#rekberNotice');
    if(rekberInCart){
      if(!banner){
        banner = document.createElement('div');
        banner.id = 'rekberNotice';
        banner.style.background = '#fff4e5';
        banner.style.border = '1px solid #fff0b8';
        banner.style.padding = '10px';
        banner.style.borderRadius = '8px';
        banner.style.marginBottom = '8px';
        banner.innerHTML = '<strong>Perhatian:</strong> Produk <em>Rekber Jefry Alson</em> mengharuskan menambahkan <u>tepat 1</u> produk tambahan: <strong>Akun TikTok</strong> <em>atau</em> <strong>OTP</strong>. Tidak boleh lebih dari 1. Silakan tambahkan satu produk tersebut sebelum checkout.';
        // insert at top of detail
        detail.insertBefore(banner, detail.firstChild);
      }
      // Decide whether requirement met
      const ok = (relatedEntries.length === 1);
      if(checkoutBtn) checkoutBtn.disabled = !ok;
      // also visually indicate status on banner
      if(ok) banner.style.borderColor = '#d1fae5', banner.style.background = '#ecfdf5', banner.innerHTML = '<strong>Perhatian:</strong> Persyaratan Rekber terpenuhi ‚Äî tepat 1 produk terkait ditemukan. Anda dapat melanjutkan checkout.';
      else banner.style.borderColor = '#fff0b8', banner.style.background = '#fff4e5';
    } else {
      // no rekber in cart -> remove banner and enable checkout
      if(banner) banner.remove();
      if(checkoutBtn) checkoutBtn.disabled = false;
    }
  }catch(e){
    console.error('checkRekberRequirement error', e);
  }
}



// ===== v26: Enforce single Rekber per order & UI disable for Rekber buttons =====
function isRekberProductId(pid){
  try{ const pp = products.find(x=>x.id===pid); return pp && pp.kategori && pp.kategori.startsWith('rekber'); }catch(e){ return false; }
}
function hasRekberInCart(){
  try{ return (keranjang || []).some(it=>{ const p = products.find(x=>x.id===it.id); return p && p.kategori && p.kategori.startsWith('rekber'); }); }catch(e){ return false; }
}
function updateRekberControls(){
  try{
    const has = hasRekberInCart();
    // disable/enable add buttons and qty inputs for rekber products
    (products || []).forEach(prod=>{
      if(prod && prod.kategori && prod.kategori.startsWith && prod.kategori.startsWith('rekber')){
        const btn = document.getElementById('btn-' + prod.id);
        const qty = document.getElementById(prod.id + '-qty');
        if(btn){
          if(has){
            btn.setAttribute('disabled','true');
            btn.title = 'Hanya 1 Rekber per pesanan';
          } else {
            if(prod.stok > 0) btn.removeAttribute('disabled');
            btn.title = '';
          }
        }
        if(qty){
          if(has){
            // lock qty to 0 to prevent adding accidentally
            qty.value = 0;
            qty.disabled = true;
          } else {
            qty.disabled = false;
            qty.max = prod.stok || qty.max || 1;
          }
        }
      }
    });
  }catch(e){ console.error('updateRekberControls err', e); }
}

// override tambahKeranjang to block adding rekber when one already exists
if(typeof window.tambahKeranjang === 'function' && !window._orig_tambahKeranjang){
  window._orig_tambahKeranjang = window.tambahKeranjang;
  window.tambahKeranjang = function(pid){
    try{
      if(isRekberProductId(pid) && hasRekberInCart()){
        alert('Produk Rekber hanya boleh 1 per pesanan. Hapus Rekber yang ada jika ingin mengganti.');
        updateRekberControls();
        return;
      }
    }catch(e){ console.error('tambahKeranjang override err', e); }
    // call original
    return window._orig_tambahKeranjang(pid);
  };
}

// override ubahJumlah to enforce qty 1 for rekber items in cart
if(typeof window.ubahJumlah === 'function' && !window._orig_ubahJumlah){
  window._orig_ubahJumlah = window.ubahJumlah;
  window.ubahJumlah = function(qid, delta){
    try{
      // if qid corresponds to a rekber product id like 'r1-qty'
      const pid = qid && qid.replace && qid.replace('-qty','');
      if(pid && isRekberProductId(pid)){
        const input = document.getElementById(qid);
        if(input){
          const newVal = Math.min(Math.max(parseInt(input.value||'0') + delta, 0), 1); // cap at 1
          input.value = newVal;
          if(newVal > 1){
            alert('Jumlah Rekber dibatasi max 1 per pesanan.');
            input.value = 1;
          }
          return;
        }
      }
    }catch(e){ console.error('ubahJumlah override err', e); }
    return window._orig_ubahJumlah(qid, delta);
  };
}

// ensure controls updated after cart changes or page load
document.addEventListener('DOMContentLoaded', function(){ setTimeout(updateRekberControls, 120); });
// call after count/update functions if present
const origUpdateCount = window.updateCountKeranjang;
if(typeof origUpdateCount === 'function'){
  window.updateCountKeranjang = function(){
    try{ origUpdateCount(); }catch(e){}
    try{ updateRekberControls(); }catch(e){}
  }
} else {
  window.updateCountKeranjang = function(){ try{ updateRekberControls(); }catch(e){} };
}

// Also call updateRekberControls after popup open
if(typeof window.bukaPopup === 'function'){
  const _origBuka = window.bukaPopup;
  window.bukaPopup = function(){
    const res = _origBuka();
    try{ setTimeout(updateRekberControls, 50); }catch(e){}
    return res;
  }
}

console.log('v26 injected: single Rekber enforcement and UI controls active.');
// ===== end v26 =====




// ===== Dynamic pricing for Rekber Premium based on total Akun TikTok + OTP (applies only to rekberPremium) =====
function computeRekberPremiumPriceFromRelatedTotal(relatedTotal){
  // relatedTotal in number (rupiah). Base price is from products array (we assume r2 base 11000)
  const base = 11000;
  const threshold = 20000; // >20k starts increase
  if(Number(relatedTotal) <= threshold) return base;
  const extra = Number(relatedTotal) - threshold;
  // increments per full 10k above threshold
  const increments = Math.floor(extra / 10000) + 1;
  return base + (increments * 1000);
}

// Calculate related total (Akun TikTok + OTP) considering only CHECKED items in popup (if popup present), else consider whole keranjang
function calcRelatedTotalFromChecked(){
  try{
    const detail = document.getElementById('detailPesanan');
    let relatedTotal = 0;
    if(detail){
      const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
      cbs.forEach(cb=>{
        try{
          if(cb.checked){
            const idx = parseInt(cb.getAttribute('data-index'));
            const item = keranjang[idx];
            if(!item) return;
            // find product meta
            const meta = products.find(p=>p.id === item.id);
            if(!meta) return;
            if(meta.kategori && (meta.kategori.startsWith('tiktok') || meta.kategori === 'produk-otp')){
              relatedTotal += (item.harga * item.jumlah);
            }
          }
        }catch(e){}
      });
    } else {
      // fallback: sum across keranjang
      (keranjang || []).forEach(item=>{
        try{
          const meta = products.find(p=>p.id === item.id);
          if(meta && (meta.kategori && (meta.kategori.startsWith('tiktok') || meta.kategori === 'produk-otp'))){
            relatedTotal += (item.harga * item.jumlah);
          }
        }catch(e){}
      });
    }
    return relatedTotal;
  }catch(e){
    console.error('calcRelatedTotalFromChecked error', e);
    return 0;
  }
}

// Get effective price for a cart item index (uses dynamic price for rekberPremium)
function getEffectivePriceForIndex(idx){
  try{
    const item = keranjang[idx];
    if(!item) return 0;
    const meta = products.find(p=>p.id === item.id) || {};
    if(meta.kategori && meta.kategori === 'rekberPremium'){
      // compute related total from checked items
      const relatedTotal = calcRelatedTotalFromChecked();
      return computeRekberPremiumPriceFromRelatedTotal(relatedTotal);
    }
    // otherwise return regular price
    return item.harga;
  }catch(e){
    console.error('getEffectivePriceForIndex error', e);
    return item && item.harga ? item.harga : 0;
  }
}

// Modify updateSelectedTotal to use effective prices per item (if function exists, override)
if(typeof updateSelectedTotal === 'function'){
  const _orig_updateSelectedTotal = updateSelectedTotal;
  updateSelectedTotal = function(){
    try{
      const popup = document.getElementById('popup');
      if(!popup) return _orig_updateSelectedTotal();
      const detail = document.getElementById('detailPesanan');
      if(!detail) return _orig_updateSelectedTotal();
      const checkboxes = Array.from(detail.querySelectorAll('.itemCheckbox'));
      if(checkboxes.length === 0){
        popup.dataset.selectedTotal = popup.dataset.rawTotal || '0';
        if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
        return;
      }
      let selTotal = 0;
      checkboxes.forEach(cb=>{
        try{
          if(cb.checked){
            const idx = parseInt(cb.getAttribute('data-index'));
            const item = keranjang[idx];
            if(!item) return;
            const effectivePrice = getEffectivePriceForIndex(idx);
            selTotal += (effectivePrice * item.jumlah);
          }
        }catch(e){}
      });
      popup.dataset.selectedTotal = String(selTotal);
      if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
      return;
    }catch(e){
      console.error('override updateSelectedTotal error', e);
      return _orig_updateSelectedTotal();
    }
  };
}

// Also override bukaPopup rendering to show dynamic subtotal for rekberPremium
if(typeof bukaPopup === 'function' && !window._v27_bukaPopup_overridden){
  window._v27_bukaPopup_overridden = true;
  const _origBuka = bukaPopup;
  bukaPopup = function(){
    // call original which builds detailPesanan and sets popup.dataset.rawTotal (but original uses static prices)
    const res = _origBuka();
    try{
      const detail = document.getElementById('detailPesanan');
      if(!detail) return res;
      // Re-render the rows in detail to update Rekber premium prices/subtotals based on current checked state
      const rows = Array.from(detail.querySelectorAll('[data-vrow-index]'));
      if(rows.length === 0){
        // if original didn't mark rows, we will instead iterate itemCheckbox wrappers
        const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
        cbs.forEach(cb=>{
          try{
            const idx = parseInt(cb.getAttribute('data-index'));
            const parent = cb.parentElement;
            if(!parent) return;
            const item = keranjang[idx];
            if(!item) return;
            const effectivePrice = getEffectivePriceForIndex(idx);
            // find subtotal span inside parent and update it if present
            const span = parent.querySelector('.dynamic-subtotal');
            if(span){
              span.textContent = formatRupiah(effectivePrice * item.jumlah);
            } else {
              // try to find the line with "Subtotal:" and replace the following text
              const html = parent.innerHTML.replace(/Subtotal:\s*[^<\n]*/i, 'Subtotal: ' + formatRupiah(effectivePrice * item.jumlah));
              parent.innerHTML = html;
            }
          }catch(e){}
        });
      } else {
        // update rows by data attribute
        rows.forEach(r=>{
          try{
            const idx = parseInt(r.getAttribute('data-vrow-index'));
            const item = keranjang[idx];
            if(!item) return;
            const effectivePrice = getEffectivePriceForIndex(idx);
            const span = r.querySelector('.dynamic-subtotal');
            if(span) span.textContent = formatRupiah(effectivePrice * item.jumlah);
          }catch(e){}
        });
      }
      // after updating subtotals, refresh selected total and raw total
      updateSelectedTotal();
      // recompute rawTotal by summing effective prices for all items
      try{
        const popup = document.getElementById('popup');
        if(popup){
          let raw = 0;
          for(let i=0;i<keranjang.length;i++){
            const eff = getEffectivePriceForIndex(i);
            raw += eff * keranjang[i].jumlah;
          }
          popup.dataset.rawTotal = raw;
        }
      }catch(e){}
      if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
    }catch(e){ console.error('post-bukaPopup dynamic price update error', e); }
    return res;
  };
}

console.log('v27 dynamic rekber premium pricing injected.');
// ===== end dynamic pricing =====




// ===== v29: Fix subtotal calculation multiplying by quantity and robust popup rendering =====
(function(){

  // Helper: compute effective price for index (uses existing computeRekberPremiumPriceFromRelatedTotal if present)
  function getEffectivePriceForIndex_fixed(idx){
    try{
      const item = keranjang[idx];
      if(!item) return 0;
      const meta = products.find(p=>p.id === item.id) || {};
      // Special pricing for Rekber Julie Sean (ids: r3, r4 or name contains 'Julie Sean')
      try{
        const name = (meta && meta.nama) ? String(meta.nama).toLowerCase() : '';
        if(meta && (meta.id === 'r3' || meta.id === 'r4' || name.indexOf('julie sean') !== -1)){
          // calculate related total (Akun TikTok + OTP) using checked items if possible
          let relatedTotal = 0;
          try{
            const detail = document.getElementById('detailPesanan');
            if(detail){
              const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
              cbs.forEach(cb=>{
                if(cb && cb.checked){
                  const iidx = parseInt(cb.getAttribute('data-index'));
                  const it = keranjang[iidx];
                  if(!it) return;
                  const m = products.find(p=>p.id === it.id);
                  if(m && (m.kategori && (m.kategori.startsWith('tiktok') || m.kategori === 'produk-otp'))){
                    relatedTotal += (it.harga * it.jumlah);
                  }
                }
              });
            } else {
              (keranjang||[]).forEach(it=>{
                const m = products.find(p=>p.id === it.id);
                if(m && (m.kategori && (m.kategori.startsWith('tiktok') || m.kategori === 'produk-otp'))){
                  relatedTotal += (it.harga * it.jumlah);
                }
              });
            }
          }catch(e){ relatedTotal = 0; }
          const special = computeJulieSeanPrice(relatedTotal);
          if(special === -1){
            // signal admin contact by returning a very large price to force manual handling later (or set price to 0 and show notice)
            return 0;
          }
          return special;
        }
      }catch(e){}
    
      // if rekberPremium apply dynamic pricing
      if(meta.kategori && meta.kategori === 'rekberPremium' && typeof computeRekberPremiumPriceFromRelatedTotal === 'function'){
        // compute related total from checked items if possible, else from all keranjang
        let relatedTotal = 0;
        try{
          // prefer checked items in popup
          const detail = document.getElementById('detailPesanan');
          if(detail){
            const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
            cbs.forEach(cb=>{
              if(cb && cb.checked){
                const i = parseInt(cb.getAttribute('data-index'));
                const it = keranjang[i];
                if(!it) return;
                const m = products.find(p=>p.id === it.id);
                if(m && (m.kategori && (m.kategori.startsWith('tiktok') || m.kategori === 'produk-otp'))){
                  relatedTotal += (it.harga * it.jumlah);
                }
              }
            });
          } else {
            // fallback sum across keranjang
            (keranjang||[]).forEach(it=>{
              const m = products.find(p=>p.id === it.id);
              if(m && (m.kategori && (m.kategori.startsWith('tiktok') || m.kategori === 'produk-otp'))){
                relatedTotal += (it.harga * it.jumlah);
              }
            });
          }
        }catch(e){ console.error('relatedTotal calc err', e); relatedTotal = 0; }
        return computeRekberPremiumPriceFromRelatedTotal(relatedTotal);
      }
      // default price
      return item.harga;
    }catch(e){
      console.error('getEffectivePriceForIndex_fixed error', e);
      return (keranjang[idx] && keranjang[idx].harga) ? keranjang[idx].harga : 0;
    }
  }

  // Re-render popup rows with consistent structure and subtotal spans
  function renderPopupWithFixedRows(){
    const popup = document.getElementById('popup');
    const detail = document.getElementById('detailPesanan');
    if(!popup || !detail) return;
    // build header and rows
    let html = '';
    html += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
      <input type='checkbox' id='selectAll' onchange='toggleSelectAll(this)'>
      <label for='selectAll' style='margin:0;'><strong>Pilih Semua</strong></label>
    </div>`;
    for(let index=0; index<keranjang.length; index++){
      const item = keranjang[index];
      const subtotal = (getEffectivePriceForIndex_fixed(index) * item.jumlah) || 0;
      const unitPrice = getEffectivePriceForIndex_fixed(index) || item.harga || 0;
      html += `
        <div class="popup-row" data-vrow-index="${index}" style="margin-bottom:10px;border-bottom:1px solid #ddd;padding-bottom:8px;display:flex;align-items:flex-start;gap:8px;">
          <input type='checkbox' class='itemCheckbox' data-index='${index}' checked style='margin-top:6px;'>
          <div style='flex:1'>
            <strong>${item.nama}</strong> x<span class="item-qty">${item.jumlah}</span><br>
            <small>${item.deskripsi}</small><br>
            <div>Harga/unit: <span class="item-unit-price">${formatRupiah(unitPrice)}</span></div>
            <div>Subtotal: <span class="item-subtotal">${formatRupiah(subtotal)}</span></div>
            <button onclick="hapusItem(${index})" style="margin-top:5px;background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:8px;">Hapus</button>
          </div>
        </div>`;
    }
    // voucher input and total area
    html += `
      <div style="margin-top:10px;">
        <label><strong>Masukkan Kode Voucher:</strong></label><br>
        <input id="voucherInput" type="text" placeholder="Masukkan kode voucher (jika ada)" style="width:100%;padding:8px;margin-top:5px;border-radius:8px;border:1px solid #ccc;">
        <button onclick="activateVoucherByInput()" id="btnActivateVoucher" style="margin-top:6px;background:#b58900;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Aktifkan Voucher</button>
      </div>
      <p id="voucherStatus" style="font-weight:bold;color:#b58900;"></p>
      <div id="totalArea"></div>
    `;
    
  // Tambahkan perhitungan pajak 3% pada popup
  let totalBeforeTax = 0;
  for (let i=0;i<keranjang.length;i++) {
    const it = keranjang[i];
    totalBeforeTax += (getEffectivePriceForIndex_fixed(i) * it.jumlah) || 0;
  }
  let pajak3 = 0;
  try{
    if (isVIPActive()) { pajak3 = 0; } else { pajak3 = Math.round(totalBeforeTax * 0.03); }
  }catch(e){ pajak3 = Math.round(totalBeforeTax * 0.03); }
  const totalAfterTax = totalBeforeTax + pajak3;
  html += `
    <div style="border-top:1px solid #ddd;margin-top:10px;padding-top:10px;text-align:right;">
      <div><strong>Subtotal:</strong> ${formatRupiah(totalBeforeTax)}</div>
      ${ isVIPActive() ? '<div><strong>Pajak:</strong> Bebas (Premium)</div>' : `<div><strong>Pajak (3%):</strong> ${formatRupiah(pajak3)}</div>` }
      <div><strong>Total Bayar:</strong> ${formatRupiah(totalAfterTax)}</div>
    </div>
  `;
  detail.innerHTML = html;
    // set raw total based on effective prices
    let raw = 0;
    for(let i=0;i<keranjang.length;i++){
      raw += getEffectivePriceForIndex_fixed(i) * keranjang[i].jumlah;
    }
    popup.dataset.rawTotal = raw;
    popup.dataset.selectedTotal = raw;
    popup.style.display = 'flex';
    // attach listeners
    setTimeout(function(){
      const detailEl = document.getElementById('detailPesanan');
      if(!detailEl) return;
      const cbs = Array.from(detailEl.querySelectorAll('.itemCheckbox'));
      cbs.forEach(cb=>{
        cb.addEventListener('change', function(){
          // sync selectAll
          const all = Array.from(detailEl.querySelectorAll('.itemCheckbox'));
          const selAll = document.getElementById('selectAll');
          if(all.length > 0){
            const allChecked = all.every(x=>x.checked);
            if(selAll) selAll.checked = allChecked;
          }
          // update subtotals and totals
          updateRowSubtotals_fixed();
          if(typeof updateSelectedTotal === 'function') updateSelectedTotal();
          if(typeof checkRekberRequirement === 'function') checkRekberRequirement();
        });
      });
      const sel = document.getElementById('selectAll');
      if(sel) sel.addEventListener('change', function(){ toggleSelectAll(this); updateRowSubtotals_fixed(); if(typeof updateSelectedTotal === 'function') updateSelectedTotal(); if(typeof checkRekberRequirement === 'function') checkRekberRequirement(); });
      // initial update
      updateRowSubtotals_fixed();
      if(typeof updateSelectedTotal === 'function') updateSelectedTotal();
      if(typeof checkRekberRequirement === 'function') checkRekberRequirement();
    }, 10);
  }

  function updateRowSubtotals_fixed(){
    try{
      const detail = document.getElementById('detailPesanan');
      if(!detail) return;
      const rows = Array.from(detail.querySelectorAll('[data-vrow-index]'));
      rows.forEach(r=>{
        try{
          const idx = parseInt(r.getAttribute('data-vrow-index'));
          const item = keranjang[idx];
          if(!item) return;
          const eff = getEffectivePriceForIndex_fixed(idx);
          const subtotalEl = r.querySelector('.item-subtotal');
          const unitEl = r.querySelector('.item-unit-price');
          const qtyEl = r.querySelector('.item-qty');
          if(unitEl) unitEl.textContent = formatRupiah(eff);
          if(qtyEl) qtyEl.textContent = String(item.jumlah);
          if(subtotalEl) subtotalEl.textContent = formatRupiah(eff * item.jumlah);
        }catch(e){}
      });
      // also update popup.dataset.rawTotal to reflect effective sums
      const popup = document.getElementById('popup');
      if(popup){
        let raw = 0;
        for(let i=0;i<keranjang.length;i++){
          raw += getEffectivePriceForIndex_fixed(i) * keranjang[i].jumlah;
        }
        popup.dataset.rawTotal = raw;
      }
    }catch(e){ console.error('updateRowSubtotals_fixed err', e); }
  }

  // Override/update updateSelectedTotal to ensure it multiplies by quantity and uses fixed effective price
  if(typeof updateSelectedTotal === 'function'){
    const _orig = updateSelectedTotal;
    updateSelectedTotal = function(){
      try{
        const popup = document.getElementById('popup');
        const detail = document.getElementById('detailPesanan');
        if(!popup || !detail) return _orig();
        const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
        if(cbs.length === 0){
          popup.dataset.selectedTotal = popup.dataset.rawTotal || '0';
          if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
          return;
        }
        let selTotal = 0;
        cbs.forEach(cb=>{
          try{
            if(cb.checked){
              const idx = parseInt(cb.getAttribute('data-index'));
              const item = keranjang[idx];
              if(!item) return;
              const eff = getEffectivePriceForIndex_fixed(idx);
              selTotal += eff * item.jumlah;
            }
          }catch(e){}
        });
        popup.dataset.selectedTotal = String(selTotal);
        if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
        return;
      }catch(e){ console.error('override updateSelectedTotal err', e); return _orig(); }
    };
  } else {
    // if updateSelectedTotal doesn't exist, define it
    updateSelectedTotal = function(){
      const popup = document.getElementById('popup');
      const detail = document.getElementById('detailPesanan');
      if(!popup || !detail) return;
      const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
      let selTotal = 0;
      cbs.forEach(cb=>{
        try{
          if(cb.checked){
            const idx = parseInt(cb.getAttribute('data-index'));
            const item = keranjang[idx];
            if(!item) return;
            const eff = getEffectivePriceForIndex_fixed(idx);
            selTotal += eff * item.jumlah;
          }
        }catch(e){}
      });
      popup.dataset.selectedTotal = String(selTotal);
      if(typeof updateTotalDisplay === 'function') updateTotalDisplay();
    };
  }

  // Finally, override bukaPopup to our fixed renderer to guarantee correct structure
  if(typeof bukaPopup === 'function'){
    const _origBuka = bukaPopup;
    bukaPopup = function(){
      // rebuild popup UI using fixed renderer (preserve any prior behavior)
      try{ renderPopupWithFixedRows(); }catch(e){ console.error('renderPopupWithFixedRows err', e); }
      return;
    };
    // mark overridden
    window._v29_bukaPopup_overridden = true;
  }

  console.log('v29 injected: fixed subtotal multiply by quantity and robust popup rendering.');

})();
// ===== end v29 =====


// ===== Compute price for Rekber Julie Sean based on related total =====
function computeJulieSeanPrice(relatedTotal){
  // relatedTotal in number (rupiah)
  const t = Number(relatedTotal || 0);
  // tiers:
  // 10k - 299k => 10k
  // 300k - 499k => 20k
  // 500k - 699k => 30k
  // 700k - 999k => 40k
  // 1,000k - 2,999k => 50k
  // 3,000k - 4,999k => 60k
  // 5,000k - 7,999k => 70k
  // >7,999k => contact admin (return 0 to signal special handling)
  if(t < 10000) return 10000; // default minimal
  if(t >= 10000 && t <= 299000) return 10000;
  if(t >= 300000 && t <= 499000) return 20000;
  if(t >= 500000 && t <= 699000) return 30000;
  if(t >= 700000 && t <= 999000) return 40000;
  if(t >= 1000000 && t <= 2999000) return 50000;
  if(t >= 3000000 && t <= 4999000) return 60000;
  if(t >= 5000000 && t <= 7999000) return 70000;
  // above cap: return -1 to indicate admin contact required
  return -1;
}





// ===== v31 Fix: buatPesanan builds WA message using effective (dynamic) prices per item =====
(function(){
  function getEffectivePrice(idx){
    // Prefer v29 fixed function if present
    if(typeof getEffectivePriceForIndex_fixed === 'function') return getEffectivePriceForIndex_fixed(idx);
    if(typeof getEffectivePriceForIndex === 'function') return getEffectivePriceForIndex(idx);
    if(typeof getEffectivePriceForIndex_fixed !== 'function' && typeof getEffectivePriceForIndex !== 'function'){
      // last resort: use keranjang price
      try{ return (keranjang[idx] && keranjang[idx].harga) ? keranjang[idx].harga : 0; }catch(e){ return 0; }
    }
    return 0;
  }

  // New implementation that only processes checked items in popup (if popup exists), otherwise falls back to whole keranjang
  function _v31_buatPesanan(){
    // Ensure there are items
    if((keranjang || []).length === 0) return alert('Keranjang kosong!');
    // Determine selected items via popup checkboxes if present
    const detail = document.getElementById('detailPesanan');
    let selectedIndexes = [];
    if(detail){
      const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
      if(cbs.length > 0){
        selectedIndexes = cbs.filter(cb=>cb.checked).map(cb => parseInt(cb.getAttribute('data-index'))).filter(i=>!isNaN(i));
      }
    }
    // fallback: if none selected, treat all items as selected
    if(selectedIndexes.length === 0){
      // If popup existed but user didn't check anything, warn (per earlier requirement)
      if(detail && detail.querySelectorAll('.itemCheckbox').length > 0){
        alert('Pilih minimal 1 produk dulu!');
        return;
      } else {
        // no popup checkboxes (older UI) -> select all indexes
        selectedIndexes = keranjang.map((_,i)=>i);
      }
    }

    // Build selectedItems array (deep copy simple objects)
    const selectedItems = selectedIndexes.map(i => Object.assign({}, keranjang[i]));

    // Compute totals using effective prices (dynamic pricing included)
    let totalBefore = 0;
    const lineItems = [];
    selectedIndexes.forEach(i => {
      const item = keranjang[i];
      if(!item) return;
      const effPrice = Number(getEffectivePrice(i) || 0);
      const qty = Number(item.jumlah || 0);
      const subtotal = effPrice * qty;
      totalBefore += subtotal;
      lineItems.push({ idx: i, id: item.id, nama: item.nama, harga_unit: effPrice, jumlah: qty, subtotal });
    });

    // Apply discount calculation (use existing calcTotalDiscount which inspects activeVouchers)
    const totalDisc = (typeof calcTotalDiscount === 'function') ? calcTotalDiscount() : 0;
    const totalAfter = Math.max(totalBefore - totalDisc, 0);

    // Build WA message similar to original formatting
    const profileName = localStorage.getItem('profileName');
  let pesanWA = `Halo, saya${profileName ? ' ' + profileName : ''} ingin memesan:

`;
    lineItems.forEach(li => {
      pesanWA += `‚Ä¢ ${li.nama} x${li.jumlah} (${formatRupiah(li.harga_unit)}) ‚Äî Subtotal: ${formatRupiah(li.subtotal)}\n`;
    });
    pesanWA += `\nTotal sebelum diskon: ${formatRupiah(totalBefore)}\n`;
    if(totalDisc > 0){
      pesanWA += `Diskon: ${formatRupiah(totalDisc)}\n`;
      pesanWA += `Voucher aktif: ${activeVouchers && activeVouchers.length? activeVouchers.join(', ') : '-'}\n`;
    } else {
      pesanWA += `Diskon: ${formatRupiah(0)}\n`;
    }
    pesanWA += `Total bayar: ${formatRupiah(totalAfter)}\n`;

        
    // TAX for WA message: exempt if VIP
    try{
      if (isVIPActive()){
        pesanWA += `Pajak: Bebas (Premium)\n`;
        pesanWA += `Total bayar setelah pajak: ${formatRupiah(totalAfter)}\n`;
      } else {
        const pajakForWA = Math.round(totalAfter * 0.03);
            // Unified TAX for WA message - show exempt when VIP active
    
    // Unified TAX for WA message - show exempt when VIP active
    
}
    }catch(e){}
const pajak3 = Math.round(totalAfter * 0.03);
    const totalAfterPajak = totalAfter + pajak3;
        // Unified TAX for WA message - show exempt when VIP active
    
    // Unified TAX for WA message - show exempt when VIP active
    
// Add metode & catatan if present in popup inputs (fallbacks)
    try{
      const metodeEl = document.getElementById('metode');
      const catEl = document.getElementById('catatan');
      pesanWA += `Metode: ${metodeEl ? metodeEl.value : ' - '}\n`;
      pesanWA += `Catatan: ${catEl ? (catEl.value || '-') : '-'}\n`;
    }catch(e){}

    // VIP info: mark VIP voucher daily usage etc (preserve original behavior)
    try{
      if(vipState && vipState.active){
        pesanWA += `\n== Info VIP ==\nVIP aktif sampai: ${vipState.expires ? new Date(vipState.expires).toLocaleString() : '-'}\n`;
        const tv = vipState.dailyVouchers ? vipState.dailyVouchers.find(v => isSameDate(new Date(v.dateStr), todayDateOnly())) : null;
        if(tv){
          const usedText = tv.used ? ' (sudah dipakai)' : ' (tersedia hari ini)';
          pesanWA += `Voucher VIP hari ini: ${tv.code} ‚Äî diskon ${formatRupiah(tv.value)}${usedText}\n`;
        } else {
          pesanWA += 'Tidak ada voucher VIP hari ini.\n';
        }
      } else {
        // if not VIP, add note about VIP promo
        pesanWA += '\nInfo: Kamu belum memiliki tiket VIP ‚Äî segera aktifkan tiket VIP (harga Rp15.000) untuk dapat voucher harian 1.000';
      }
    }catch(e){}

    // Mark vouchers used as in original logic (general vouchers and vip daily)
    try{
      activeVouchers.forEach(code=>{
        let v = (typeof voucherData !== 'undefined' ? voucherData.find(x=>x.code===code) : null);
        if(v) v.used = true;
        let vv = (vipState && vipState.dailyVouchers) ? vipState.dailyVouchers.find(x=>x.code===code) : null;
        if(vv) vv.used = true;
      });
    }catch(e){}

    // decrease stock for ordered items and update UI similar to original
    try{
      selectedIndexes.forEach(i => {
        const item = selectedItems.find(si => si.id === keranjang[i].id);
        if(!item) return;
        // find master product
        const prod = products.find(x=>x.id===item.id);
        if(prod){
          prod.stok = Math.max(prod.stok - item.jumlah, 0);
          const stokEl = document.getElementById('stok-' + prod.id);
          if(stokEl) stokEl.textContent = prod.stok;
          const qtyInput = document.getElementById(prod.id + '-qty');
          if(qtyInput){
            qtyInput.max = prod.stok;
            if(parseInt(qtyInput.value||0) > prod.stok) qtyInput.value = prod.stok;
          }
          const btn = document.getElementById('btn-' + prod.id);
          if(btn){ if(prod.stok <= 0) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled'); }
        }
      });
    }catch(e){ console.error('stock decrease err', e); }

    // Save history (similar to original)
    try{
      history.push({ items: selectedItems.map(k=>({id:k.id,nama:k.nama,jumlah:k.jumlah,harga_unit:k.harga,deskripsi:k.deskripsi})), nama: selectedItems.map(k=>k.nama).join(', '), jumlah: selectedItems.reduce((a,b)=>a+b.jumlah,0), metode: (document.getElementById('metode')?document.getElementById('metode').value:'-'), catatan: (document.getElementById('catatan')?document.getElementById('catatan').value:'-'), tanggal: new Date().toLocaleString(), total: totalAfter, vouchers: [...(activeVouchers||[])] });
    }catch(e){ console.error('history push err', e); }

    // Remove processed items from keranjang (keep remaining)
    try{
      // Build set of ids+index processed, remove by index descending to avoid reindexing issues
      const removeSet = new Set(selectedIndexes);
      const remaining = [];
      for(let i=0;i<keranjang.length;i++){
        if(!removeSet.has(i)) remaining.push(keranjang[i]);
      }
      keranjang = remaining;
      updateCountKeranjang();
    }catch(e){ console.error('remove processed items err', e); }

    // Close popup
    try{ const popup = document.getElementById('popup'); if(popup) popup.style.display='none'; }catch(e){}

    // Open WA with pesanWA
    try{
      window.open("https://wa.me/6285769302532?text=" + encodeURIComponent(pesanWA), "_blank");
    }catch(e){ console.error('open wa err', e); }

  } // end _v31_buatPesanan

  // Bind override
  window.buatPesanan = _v31_buatPesanan;
  console.log('v31: buatPesanan overridden to use effective dynamic prices in WA message.');
})();
// ===== end v31 =====




// ===== v32: Ensure WA message uses exact UI-displayed values (read from popup DOM when available) =====
(function(){
  function parseRupiahToNumber(str){
    if(!str) return 0;
    try{
      // remove non-digits
      const num = str.replace(/[^\d]/g, '');
      return Number(num) || 0;
    }catch(e){ return 0; }
  }

  function buildWAMessageFromPopup(){
    const detail = document.getElementById('detailPesanan');
    const popup = document.getElementById('popup');
    if(!detail || !popup) return null;
    const rows = Array.from(detail.querySelectorAll('[data-vrow-index]'));
    if(rows.length === 0){
      // try older structure: look for elements with class item-subtotal
      const subtotalEls = Array.from(detail.querySelectorAll('.item-subtotal'));
      if(subtotalEls.length === 0) return null;
    }
    const lineItems = [];
    let totalBefore = 0;
    // prefer data-vrow-index structure
    if(rows.length > 0){
      rows.forEach(r=>{
        try{
          const idx = parseInt(r.getAttribute('data-vrow-index'));
          const nameEl = r.querySelector('strong');
          const name = nameEl ? nameEl.textContent.trim() : ('Item ' + idx);
          const qtyEl = r.querySelector('.item-qty');
          const qty = qtyEl ? parseInt(qtyEl.textContent.replace(/[^\d]/g,'')) || 0 : (keranjang[idx] ? (keranjang[idx].jumlah||0) : 0);
          const unitEl = r.querySelector('.item-unit-price');
          const unit = unitEl ? parseRupiahToNumber(unitEl.textContent) : (keranjang[idx] ? keranjang[idx].harga : 0);
          const subtotalEl = r.querySelector('.item-subtotal');
          const subtotal = subtotalEl ? parseRupiahToNumber(subtotalEl.textContent) : (unit * qty);
          totalBefore += subtotal;
          lineItems.push({idx, name, qty, unit, subtotal});
        }catch(e){}
      });
    } else {
      // fallback: attempt to parse lists of names, qtys, unit prices and subtotals in order
      const nameEls = Array.from(detail.querySelectorAll('strong'));
      const qtyEls = Array.from(detail.querySelectorAll('.item-qty'));
      const unitEls = Array.from(detail.querySelectorAll('.item-unit-price'));
      const subtotalEls = Array.from(detail.querySelectorAll('.item-subtotal'));
      const len = Math.max(nameEls.length, subtotalEls.length);
      for(let i=0;i<len;i++){
        const name = nameEls[i] ? nameEls[i].textContent.trim() : ('Item ' + i);
        const qty = qtyEls[i] ? parseInt(qtyEls[i].textContent.replace(/[^\d]/g,'')) || 0 : 1;
        const unit = unitEls[i] ? parseRupiahToNumber(unitEls[i].textContent) : 0;
        const subtotal = subtotalEls[i] ? parseRupiahToNumber(subtotalEls[i].textContent) : (unit * qty);
        totalBefore += subtotal;
        lineItems.push({idx:i, name, qty, unit, subtotal});
      }
    }
    return { lineItems, totalBefore };
  }

  // Override buatPesanan to prefer DOM-derived message when popup is open
  if(typeof window.buatPesanan === 'function'){
    const _orig = window.buatPesanan;
    window.buatPesanan = function(){
      try{
        const popup = document.getElementById('popup');
        const detail = document.getElementById('detailPesanan');
        const domMsg = buildWAMessageFromPopup();
        if(domMsg){
          // construct message from DOM values to ensure exact match with UI
          const { lineItems, totalBefore } = domMsg;
          // compute discount using existing calcTotalDiscount (which uses activeVouchers)
          const totalDisc = (typeof calcTotalDiscount === 'function') ? calcTotalDiscount() : 0;
          const totalAfter = Math.max(totalBefore - totalDisc, 0);
          const profileName = localStorage.getItem('profileName');
  let pesanWA = `Halo, saya${profileName ? ' ' + profileName : ''} ingin memesan:

`;
          lineItems.forEach(li=>{
            pesanWA += `‚Ä¢ ${li.name} x${li.qty} (${formatRupiah(li.unit)}) ‚Äî Subtotal: ${formatRupiah(li.subtotal)}\n`;
          });
          pesanWA += `\nTotal sebelum diskon: ${formatRupiah(totalBefore)}\n`;
          pesanWA += `Diskon: ${formatRupiah(totalDisc)}\n`;
          pesanWA += `Total bayar: ${formatRupiah(totalAfter)}\n`;
              const pajak3 = Math.round(totalAfter * 0.03);
    const totalAfterPajak = totalAfter + pajak3;
        // Unified TAX for WA message - show exempt when VIP active
    
    // Unified TAX for WA message - show exempt when VIP active
    try {
      const pajak3 = isVIPActive() ? 0 : Math.round(totalAfter * 0.03);
      if (isVIPActive()) {
        pesanWA += `Pajak: Bebas (Premium)\n`;
        pesanWA += `Total bayar setelah pajak: ${formatRupiah(totalAfter)}\n`;
      } else {
        pesanWA += `Pajak (3%): ${formatRupiah(pajak3)}\n`;
        pesanWA += `Total bayar setelah pajak: ${formatRupiah(totalAfter + pajak3)}\n`;
      }
    } catch(e) { console.warn('tax-snippet error', e); }
// metode & catatan
          try{ const metodeEl = document.getElementById('metode'); const catEl = document.getElementById('catatan'); pesanWA += `Metode: ${metodeEl?metodeEl.value:'-'}\n`; pesanWA += `Catatan: ${catEl?(catEl.value||'-'):'-'}\n`; }catch(e){}
          // VIP info preserved
          try{
            if(vipState && vipState.active){
              pesanWA += `\n== Info VIP ==\nVIP aktif sampai: ${vipState.expires?new Date(vipState.expires).toLocaleString():'-'}\n`;
            } else {
              pesanWA += '\nInfo: Kamu belum memiliki tiket VIP ‚Äî segera aktifkan tiket VIP (harga Rp15.000) untuk dapat voucher harian 1.000';
            }
          }catch(e){}
          // mark vouchers used similar to original
          try{ activeVouchers.forEach(code=>{ let v = (typeof voucherData!=='undefined'?voucherData.find(x=>x.code===code):null); if(v) v.used=true; let vv = (vipState&&vipState.dailyVouchers)?vipState.dailyVouchers.find(x=>x.code===code):null; if(vv) vv.used=true; }); }catch(e){}
          // perform stock decrease & history & remove processed items (reuse original behavior as in v31)
          try{ 
            // build selectedIndexes from checkboxes if available
            let selectedIndexes = [];
            if(detail){
              const cbs = Array.from(detail.querySelectorAll('.itemCheckbox'));
              if(cbs.length > 0){
                selectedIndexes = cbs.filter(cb=>cb.checked).map(cb=>parseInt(cb.getAttribute('data-index'))).filter(i=>!isNaN(i));
              }
            }
            if(selectedIndexes.length === 0){
              selectedIndexes = keranjang.map((_,i)=>i);
            }
            const selectedItems = selectedIndexes.map(i=>Object.assign({}, keranjang[i]));
            // decrease stock
            selectedItems.forEach(item=>{
              const prod = products.find(x=>x.id===item.id);
              if(prod){
                prod.stok = Math.max(prod.stok - item.jumlah, 0);
                const stokEl = document.getElementById('stok-' + prod.id);
                if(stokEl) stokEl.textContent = prod.stok;
                const qtyInput = document.getElementById(prod.id + '-qty');
                if(qtyInput){ qtyInput.max = prod.stok; if(parseInt(qtyInput.value||0) > prod.stok) qtyInput.value = prod.stok; }
                const btn = document.getElementById('btn-' + prod.id);
                if(btn){ if(prod.stok <= 0) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled'); }
              }
            });
            // push history
            try{ history.push({ items: selectedItems.map(k=>({id:k.id,nama:k.nama,jumlah:k.jumlah,harga_unit:k.harga,deskripsi:k.deskripsi})), nama: selectedItems.map(k=>k.nama).join(', '), jumlah: selectedItems.reduce((a,b)=>a+b.jumlah,0), metode: (document.getElementById('metode')?document.getElementById('metode').value:'-'), catatan: (document.getElementById('catatan')?document.getElementById('catatan').value:'-'), tanggal: new Date().toLocaleString(), total: totalAfter, vouchers: [...(activeVouchers||[])] }); }catch(e){}
            // remove processed items from keranjang
            const removeSet = new Set(selectedIndexes);
            const remaining = [];
            for(let i=0;i<keranjang.length;i++){ if(!removeSet.has(i)) remaining.push(keranjang[i]); }
            keranjang = remaining;
            updateCountKeranjang();
          }catch(e){ console.error('post-WA stock/history removal err', e); }
          // close popup
          try{ const popupEl = document.getElementById('popup'); if(popupEl) popupEl.style.display = 'none'; }catch(e){}
          // open WA
          window.open('https://wa.me/6285769302532?text=' + encodeURIComponent(pesanWA), '_blank');
          return;
        }
      }catch(e){ console.error('DOM-based buatPesanan override err', e); }
      // fallback to original implementation if anything fails
      try{ return _orig(); }catch(e){ console.error('fallback original buatPesanan err', e); }
    };
  }
  console.log('v32: buatPesanan overridden to use DOM-displayed values when available.');
})();
// ===== end v32 =====




// ===== VIP Promo Notification & Persistent Banner =====
(function(){
  const promoMsg = 'Promo VIP: Beli Tiket VIP Rp15.000 ‚Äî Dapat voucher Rp1.000/hari selama 30 hari. Jangan kelewatan!';
  try{
    if(typeof notifikasi !== 'undefined'){
      if(!notifikasi.includes(promoMsg)){
        notifikasi.unshift(promoMsg);
        // limit notifikasi array length reasonably
        if(notifikasi.length > 150) notifikasi.length = 150;
      }
    }
  }catch(e){ console.error('vip promo push err', e); }

  // create a small persistent banner that appears after page load
  window.addEventListener('DOMContentLoaded', function(){
    try{
      // don't create multiple banners
      if(document.getElementById('vipPromoBanner')) return;
      const banner = document.createElement('div');
      banner.id = 'vipPromoBanner';
      banner.style.position = 'fixed';
      banner.style.bottom = '80px';
      banner.style.left = '12px';
      banner.style.right = '12px';
      banner.style.background = 'linear-gradient(90deg,#c48b00,#b58900)';
      banner.style.color = 'white';
      banner.style.padding = '12px';
      banner.style.borderRadius = '12px';
      banner.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
      banner.style.zIndex = 9999;
      banner.style.display = 'flex';
      banner.style.justifyContent = 'space-between';
      banner.style.alignItems = 'center';
      banner.style.gap = '12px';
      banner.innerHTML = '<div style="flex:1;"><strong>Promo VIP Rp15.000 ‚Äî 1 bulan</strong><div style="font-size:13px">Dapat voucher Rp1.000 setiap hari selama 30 hari. Jangan kelewatan! Mulai dari harga Rp15.000.</div></div>' +
                         '<div style="display:flex;gap:8px;align-items:center">' +
                         '<button id="vipPromoBuyBtn" style="background:#fff;color:#fffaf2;border:none;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer">Beli Sekarang</button>' +
                         '<button id="vipPromoCloseBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.5);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer">Tutup</button>' +
                         '</div>';
      document.body.appendChild(banner);

      // Button actions
      const buyBtn = document.getElementById('vipPromoBuyBtn');
      const closeBtn = document.getElementById('vipPromoCloseBtn');
      if(buyBtn){
        buyBtn.addEventListener('click', function(e){
          try{ if(typeof bukaVIP === 'function') bukaVIP(); else { const vp = document.getElementById('vipPopup'); if(vp) vp.style.display='flex'; } }catch(err){ console.error(err); }
        });
      }
      if(closeBtn){
        closeBtn.addEventListener('click', function(e){
          const b = document.getElementById('vipPromoBanner');
          if(b) b.remove();
        });
      }

      // small auto-hide after 20 seconds but keep in notifikasi list
      setTimeout(function(){ try{ const b = document.getElementById('vipPromoBanner'); if(b) b.style.opacity = '0.0'; setTimeout(()=>{ if(b) b.remove(); }, 400); }catch(e){} }, 20000);

    }catch(e){ console.error('vip promo banner err', e); }
  });
})();
// ===== end VIP Promo Notification & Banner =====




// ===== VIP activation helper: activateVIPFromPurchase(code) =====
(function(){
  function fmtDateYMD(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return yyyy + '-' + mm + '-' + dd;
  }
  // Generate YYYY-MM-DDTHH:MM:SS format local
  function fmtDateTimeLocal(d){
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0');
  }

  window.activateVIPFromPurchase = function(purchaseCode){
    try{
      if(!purchaseCode) return alert('Masukkan kode pembelian VIP.');
      // find vipPurchaseData array
      const vp = (typeof vipPurchaseData !== 'undefined') ? vipPurchaseData : null;
      if(!vp || !Array.isArray(vp)) return alert('Data kode VIP tidak tersedia.');
      const idx = vp.findIndex(x=>String(x.code).toUpperCase() === String(purchaseCode).toUpperCase());
      if(idx === -1) return alert('Kode pembelian tidak ditemukan.');
      if(vp[idx].used) return alert('Kode pembelian sudah digunakan.');
      // mark used
      vp[idx].used = true;
      // set vipState on window (simulate activation)
      const now = new Date();
      const expires = new Date(now.getTime() + (30*24*60*60*1000)); // 30 days
      window.vipState = window.vipState || {};
      window.vipState.active = true;
      window.vipState.started = now.getTime();
      window.vipState.expires = expires.getTime();
      window.vipState.purchaseCode = vp[idx].code;
      // generate daily vouchers
      const daily = [];
      for(let i=0;i<30;i++){
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + i);
        const dateStr = fmtDateYMD(d);
        // code format VIPYYYYMMDD-<random 4>
        const rnd = Math.random().toString(36).substring(2,6).toUpperCase();
        const code = 'VIPDAY' + dateStr.replace(/-/g,'') + '-' + rnd;
        daily.push({ code: code, dateStr: dateStr, value: 1000, used: false });
      }
      window.vipState.dailyVouchers = daily;
      // inform user
      alert('VIP diaktifkan. Berlaku sampai ' + fmtDateTimeLocal(expires) + '. ' + daily.length + ' voucher harian dibuat.');
      console.log('VIP activated', window.vipState);
      // store in localStorage for persistence
      try{ localStorage.setItem('vipState', JSON.stringify(window.vipState)); }catch(e){}
      return window.vipState;
    }catch(e){
      console.error('activateVIPFromPurchase err', e);
      alert('Gagal mengaktifkan VIP (lihat console).');
    }
  };

  // auto-restore vipState from localStorage on load if present
  try{
    if(window && window.addEventListener){
      window.addEventListener('DOMContentLoaded', function(){
        try{
          const raw = localStorage.getItem('vipState');
          if(raw){
            const obj = JSON.parse(raw);
            if(obj && obj.expires && Date.now() < Number(obj.expires)){
              window.vipState = obj;
            }
          }
        }catch(e){}
      });
    }
  }catch(e){}
})();
// ===== end activateVIPFromPurchase =====


</script>

<!-- ===== Fancy Dark Hamburger (non-blur, clean) ===== -->
<style>
/* hide original floating buttons if present */
#btnKeranjang, #btnHistory, #btnNotif, #btnVoucher, #btnVIP, #btnLevel, #btnFavorit, #btnSettings {
  display: none !important;
}

/* Fancy hamburger button */
#hamburgerBtn {
  position: fixed;
  top: 14px;
  left: 14px;
  width: 52px;
  height: 52px;
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.03);
  box-shadow: 0 10px 28px rgba(2,6,23,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:999;
  transition: transform .18s ease, box-shadow .18s ease;
}

/* lines */
#hamburgerBtn .line { display:block; width:22px; height:2px; background: linear-gradient(90deg,#fbfdff,#dfeeff); border-radius:2px; transition: transform .25s ease, opacity .18s ease; }
#hamburgerBtn .line + .line{ margin-top:5px; }

/* open state */
#hamburgerBtn.open { transform: rotate(90deg) scale(1.02); box-shadow: 0 14px 36px rgba(2,6,23,0.32); }
#hamburgerBtn.open .line:nth-child(1){ transform: translateY(7px) rotate(45deg); }
#hamburgerBtn.open .line:nth-child(2){ opacity:0; transform: scaleX(0); }
#hamburgerBtn.open .line:nth-child(3){ transform: translateY(-7px) rotate(-45deg); }

/* Panel (dark, non-blur) */
#hamburgerPanel {
  position: fixed;
  top: 72px;
  left: 14px;
  width: 320px;
  max-width: calc(100% - 28px);
  background: linear-gradient(180deg, #071226, #0b1a2a);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 20px 48px rgba(2,6,23,0.36);
  border: 1px solid rgba(255,255,255,0.04);
  display: none;
  z-index: 998;
  transform-origin: top left;
  overflow: visible;
}

/* entrance */
#hamburgerPanel.show { display:block; animation: popIn .22s cubic-bezier(.2,.9,.3,1); }
@keyframes popIn { from { opacity:0; transform: translateY(-6px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }

/* grid */
.hamb-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

/* item */
.hamb-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; cursor:pointer; transition: transform .15s ease, box-shadow .15s ease, background .15s ease; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }
.hamb-item:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(2,6,23,0.18); }

/* icon badge */
.hamb-badge-icon { min-width:44px; min-height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; color:white; }

/* gradients */
.g1{background:linear-gradient(135deg,#7c3aed,#d4af37);}
.g2{background:linear-gradient(135deg,#ef4444,#fb923c);}
.g3{background:linear-gradient(135deg,#b58900,#60a5fa);}
.g4{background:linear-gradient(135deg,#10b981,#34d399);}
.g5{background:linear-gradient(135deg,#f59e0b,#c48b00);}
.g6{background:linear-gradient(135deg,#e11d48,#f973a2);}

/* text */
.hamb-title{font-size:14px;font-weight:700;color:#e6f0ff;}
.hamb-sub{font-size:12px;color:#9fb3c6;margin-top:2px;}

/* cart count */
.hamb-count{ margin-left:auto; background:rgba(255,255,255,0.06); color:#e6f0ff; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; }

/* responsive */
@media (max-width:420px){ #hamburgerPanel{ width:86%; left:8px; top:64px; } .hamb-grid{ gap:8px; } }
</style>

<!-- button -->
<button id="hamburgerBtn" aria-expanded="false" aria-label="Menu">
  <span class="line"></span>
  <span class="line"></span>
  <span class="line"></span>
</button>

<!-- panel -->
<div id="hamburgerPanel" aria-hidden="true">
  <div class="hamb-grid">
    <div class="hamb-item" id="menu-tutorial" onclick="try{openTutorial(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g4">üìò</div>
      <div><div class="hamb-title">Tutorial</div><div class="hamb-sub">Cara pakai & FAQ</div></div>
    </div>

    <div class="hamb-item" id="menu-level" onclick="try{bukaLevel(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g1">üéñ</div>
      <div><div class="hamb-title">Level</div><div class="hamb-sub">Keanggotaan</div></div>
    </div>
    <div class="hamb-item" id="menu-keranjang" onclick="try{bukaPopup(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g4">üõí</div>
      <div><div class="hamb-title">Keranjang</div><div class="hamb-sub">Lihat pesanan</div></div>
      <div class="hamb-count" id="menu-countKeranjang">0</div>
    </div>
    <div class="hamb-item" id="menu-history" onclick="try{bukaHistory(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g3">üìú</div>
      <div><div class="hamb-title">History</div><div class="hamb-sub">Riwayat</div></div>
    </div>
    <div class="hamb-item" id="menu-notif" onclick="try{bukaNotif(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g2">üîî</div>
      <div><div class="hamb-title">Notifikasi</div><div class="hamb-sub">Pesan terbaru</div></div>
    </div>
    <div class="hamb-item" id="menu-voucher" onclick="try{bukaVoucher(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g5">üéü</div>
      <div><div class="hamb-title">Voucher</div><div class="hamb-sub">Diskon & kode</div></div>
    </div>
    <div class="hamb-item" id="menu-vip" onclick="try{bukaVIP(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g6">‚≠ê</div>
      <div><div class="hamb-title">VIP</div><div class="hamb-sub">Tiket harian</div></div>
    </div>
    <div class="hamb-item" id="menu-favorit" onclick="try{bukaFavorites(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g1">ü§ç</div>
      <div><div class="hamb-title">Favorit</div><div class="hamb-sub">Simpan produk</div></div>
    </div>
    <div class="hamb-item" id="menu-settings" onclick="try{openSettings(); toggleHambPanel(false);}catch(e){toggleHambPanel(false);}">
      <div class="hamb-badge-icon g3">‚öôÔ∏è</div>
      <div><div class="hamb-title">Pengaturan</div><div class="hamb-sub">Reset / Backup / Upload</div></div>
    </div>
  </div>
</div>

<script>
(function(){
  const hamBtn = document.getElementById('hamburgerBtn');
  const hamPanel = document.getElementById('hamburgerPanel');
  const countSrc = document.getElementById('countKeranjang');
  const countDest = document.getElementById('menu-countKeranjang');

  function setOpenState(open){
    if(open){
      hamBtn.classList.add('open');
      hamBtn.setAttribute('aria-expanded','true');
      hamPanel.classList.add('show');
      hamPanel.setAttribute('aria-hidden','false');
    } else {
      hamBtn.classList.remove('open');
      hamBtn.setAttribute('aria-expanded','false');
      hamPanel.classList.remove('show');
      hamPanel.setAttribute('aria-hidden','true');
      setTimeout(()=>{ if(!hamPanel.classList.contains('show')) hamPanel.style.display = 'none'; }, 260);
    }
  }

  window.toggleHambPanel = function(force){
    if(typeof force === 'boolean') return setOpenState(force);
    const open = hamBtn.classList.contains('open');
    if(open) setOpenState(false);
    else {
      hamPanel.style.display = 'block';
      requestAnimationFrame(()=> setOpenState(true));
    }
  };

  hamBtn.addEventListener('click', function(e){ e.stopPropagation(); toggleHambPanel(); });

  document.addEventListener('click', function(ev){
    if(!hamPanel.contains(ev.target) && ev.target !== hamBtn){
      setOpenState(false);
    }
  });

  function syncCart(){
    try{
      if(countSrc && countDest){ countDest.textContent = countSrc.textContent || '0'; }
    }catch(e){}
  }
  setInterval(syncCart, 500);
  document.addEventListener('keydown', function(e){ if(e.key === 'Escape') setOpenState(false); });

})();
</script>
<!-- ===== end fancy dark hamburger ===== -->


<!-- ===== Settings popup (Reset / Backup / Upload) ===== -->
<style>
#settingsPopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:1200;}
#settingsPopup .popup-content{background:linear-gradient(180deg,#0b1a2a,#071226);color:#e6f0ff;max-width:520px;width:92%;border-radius:12px;padding:16px;box-shadow:0 18px 40px rgba(2,6,23,0.5);border:1px solid rgba(255,255,255,0.03);}
.settings-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.settings-row button{flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700;}
.small-note{font-size:13px;color:#9fb3c6;margin-top:8px;}
.file-input-wrap{display:flex;gap:8px;align-items:center;margin-top:8px;}
#uploadInfo{color:#9fb3c6;margin-top:6px;}
</style>


<div id="settingsPopup" onclick="if(event.target===this) closeSettings()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:1200;">
  <div class="popup-content" style="max-width:520px;width:92%;border-radius:12px;padding:16px;">
    <h3 style="margin:0 0 6px 0;">Pengaturan ‚Äî Reset / Backup / Upload</h3>
    <p class="small-note">
      <strong>Reset</strong> akan mengembalikan banyak data kecuali <strong>stok</strong> (stok tetap). 
      <strong>Backup</strong> akan mengunduh file <code>.json</code>; <strong>Upload</strong> langsung menerapkan file JSON (akan ditanya apakah stok dipertahankan).
    </p>
    <p class="small-note" style="color:#fca5a5;">
      ‚ö†Ô∏è <em>Sebelum melakukan reset, pastikan kamu sudah melakukan backup file ini. Jika belum dibackup dan sudah direset, admin tidak bertanggung jawab atas kehilangan semua isi di dalamnya ‚Äî termasuk tiket VIP, voucher, dan data lainnya.</em>
    </p>

    <div class="settings-row" style="display:flex;gap:8px;margin-top:8px;">
      <button style="flex:1;background:#ef4444;color:white;border-radius:10px;padding:10px;border:none;" onclick="openResetConfirm()">Reset (kecuali stok)</button>
      <button style="flex:1;background:#b58900;color:white;border-radius:10px;padding:10px;border:none;" onclick="downloadEncryptedBackup()">Backup (Unduh)</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
      <input id="uploadBackupInput2" type="file" accept=".json,.bak" onchange="handleUploadAndStore(event)" style="flex:1;">
      <button onclick="restoreUploadedBackup()" style="padding:10px;border-radius:10px;background:#10b981;color:white;border:none;margin-left:8px;">Restore Upload</button>
      <button onclick="clearUploadedBackup()" style="padding:10px;border-radius:10px;background:#ef4444;color:white;border:none;margin-left:8px;">Hapus Upload</button>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px;">
      <button onclick="closeSettings()" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.08);">Tutup</button>
    </div>
    <div id="uploadInfo" style="margin-top:8px;color:#94a3b8;"></div>
  </div>
</div>


    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button onclick="closeSettings()" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6f0ff;">Tutup</button>
    </div>

    <div id="uploadInfo"></div>
  </div>
</div>

<script>
// Settings functions (safe, small versions)
function openSettings(){ 
  // close hamburger panel if open
  try{ toggleHambPanel(false); }catch(e){}
  document.getElementById('settingsPopup').style.display = 'flex'; 
}
function closeSettings(){ document.getElementById('settingsPopup').style.display = 'none'; }

function getSerializableState(){
  try{
    return {
      voucherData: JSON.parse(JSON.stringify(typeof voucherData !== 'undefined' ? voucherData : [])),
      vipPurchaseData: JSON.parse(JSON.stringify(typeof vipPurchaseData !== 'undefined' ? vipPurchaseData : [])),
      vipState: JSON.parse(JSON.stringify(typeof vipState !== 'undefined' ? vipState : {active:false})),
      activeVouchers: JSON.parse(JSON.stringify(typeof activeVouchers !== 'undefined' ? activeVouchers : [])),
      voucherSourceMap: JSON.parse(JSON.stringify(typeof voucherSourceMap !== 'undefined' ? voucherSourceMap : {})),
      searchHistory: JSON.parse(JSON.stringify(typeof searchHistory !== 'undefined' ? searchHistory : [])),
      keranjang: JSON.parse(JSON.stringify(typeof keranjang !== 'undefined' ? keranjang : [])),
      history: JSON.parse(JSON.stringify(typeof history !== 'undefined' ? history : [])),
      notifikasi: JSON.parse(JSON.stringify(typeof notifikasi !== 'undefined' ? notifikasi : [])),
      favorites: JSON.parse(JSON.stringify(typeof favorites !== 'undefined' ? favorites : [])),
      productsStocks: (typeof products !== 'undefined') ? products.map(p=>({id:p.id, stok:p.stok})) : []
    };
  }catch(e){
    console.error('getSerializableState error', e);
    return null;
  }
}

function applyState(stateObj, options){
  options = options || {};
  const keepStocks = options.keepStocks === true;
  if(!stateObj) return;
  try{
    if(typeof voucherData !== 'undefined' && stateObj.voucherData) voucherData.splice(0, voucherData.length, ...JSON.parse(JSON.stringify(stateObj.voucherData)));
    if(typeof vipPurchaseData !== 'undefined' && stateObj.vipPurchaseData) { vipPurchaseData = JSON.parse(JSON.stringify(stateObj.vipPurchaseData)); }
    if(typeof vipState !== 'undefined' && stateObj.vipState) { vipState = JSON.parse(JSON.stringify(stateObj.vipState)); }
    if(typeof activeVouchers !== 'undefined') activeVouchers = Array.isArray(stateObj.activeVouchers)? JSON.parse(JSON.stringify(stateObj.activeVouchers)) : [];
    if(typeof voucherSourceMap !== 'undefined') voucherSourceMap = stateObj.voucherSourceMap ? JSON.parse(JSON.stringify(stateObj.voucherSourceMap)) : {};
    if(typeof searchHistory !== 'undefined') searchHistory = stateObj.searchHistory ? JSON.parse(JSON.stringify(stateObj.searchHistory)) : [];
    if(typeof keranjang !== 'undefined') keranjang = stateObj.keranjang ? JSON.parse(JSON.stringify(stateObj.keranjang)) : [];
    if(typeof history !== 'undefined') history = stateObj.history ? JSON.parse(JSON.stringify(stateObj.history)) : [];
    if(typeof notifikasi !== 'undefined') notifikasi = stateObj.notifikasi ? JSON.parse(JSON.stringify(stateObj.notifikasi)) : [];
    if(typeof favorites !== 'undefined') { favorites = stateObj.favorites ? JSON.parse(JSON.stringify(stateObj.favorites)) : []; try{ saveFavorites(); }catch(e){} }

    if(typeof products !== 'undefined' && Array.isArray(products) && Array.isArray(stateObj.productsStocks)){
      const stocksMap = {};
      stateObj.productsStocks.forEach(s=>{ stocksMap[s.id] = s.stok; });
      products.forEach(p=>{
        if(keepStocks){
          // preserve current stok
        } else {
          if(typeof stocksMap[p.id] !== 'undefined') p.stok = stocksMap[p.id];
        }
      });
    }

    // Try to refresh UI where possible
    try{
      if(typeof renderCategory === 'function'){
        const cats = ['tiktokBasic','tiktokPremium','produk-otp','rekberBasic','rekberPremium'];
        cats.forEach(c=>{ try{ renderCategory(c);}catch(e){} });
      }
      if(typeof products !== 'undefined'){
        products.forEach(p=>{
          const stokEl = document.getElementById('stok-' + p.id);
          if(stokEl) stokEl.textContent = p.stok;
          const qtyInput = document.getElementById(p.id + '-qty');
          if(qtyInput){
            qtyInput.max = p.stok;
            if(parseInt(qtyInput.value||0) > p.stok) qtyInput.value = p.stok;
          }
          const btn = document.getElementById('btn-' + p.id);
          if(btn){ if(p.stok <= 0) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled'); }
        });
      }
      try{ renderFavoritesList(); }catch(e){}
      try{ renderVIPDailyList(); showVIPStatus(); }catch(e){}
      try{ updateCountKeranjang(); if(document.getElementById('popup') && document.getElementById('popup').style.display === 'flex') updateTotalDisplay(); }catch(e){}
    }catch(e){ console.error(e); }

    try{ saveFavorites(); }catch(e){}
    return true;
  }catch(e){
    console.error('applyState error', e);
    return false;
  }
}

// Capture initial snapshot
const __initial_snapshot_for_reset = getSerializableState();

function openResetConfirm(){
  if(!confirm('Reset aplikasi ke kondisi awal (kecuali stok akan tetap)\\n\\nLanjutkan?')) return;
  const ok = applyState(__initial_snapshot_for_reset, {keepStocks:true});
  if(ok) alert('Berhasil: aplikasi direset kecuali stok produk tetap.');
  else alert('Gagal me-reset aplikasi. Periksa console.');
}

function downloadEncryptedBackup(){
  try{
    const st = getSerializableState();
    localStorage.setItem('app_backup_snapshot', JSON.stringify(st));
    const blob = new Blob([JSON.stringify(st, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const now = new Date();
    const fname = `backup_app_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`;
    a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    document.getElementById('uploadInfo').textContent = 'Backup diunduh dan disimpan ke localStorage (app_backup_snapshot).';
    alert('Backup diunduh dan tersimpan.');
  }catch(e){ console.error(e); alert('Gagal membuat backup.'); }
}

function handleUploadAndApply(ev){
  try{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const parsed = JSON.parse(e.target.result);
        const keep = confirm('Apakah stok saat ini ingin dipertahankan? (OK = YA, Batal = Tidak ‚Äî stok akan diambil dari file)');
        const ok = applyState(parsed, {keepStocks: keep});
        if(ok){ alert('Backup dari file berhasil diterapkan.'); document.getElementById('uploadInfo').textContent = 'Backup diterapkan.'; closeSettings(); }
        else alert('Gagal menerapkan backup dari file. Periksa console.');
      }catch(pe){ console.error(pe); alert('Gagal membaca file JSON.'); }
    };
    reader.readAsText(file);
  }catch(e){ console.error(e); alert('Gagal mengunggah file.'); }
}
</script>
<!-- ===== end Settings popup ===== -->


<!-- ===== Tutorial popup (Cara Pakai) ===== -->
<style>
#tutorialPopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.48);justify-content:center;align-items:center;z-index:1300;}
#tutorialPopup .content{max-height:78vh;overflow:auto;-webkit-overflow-scrolling:touch;padding-right:6px}
/* optional scrollbar styling */
#tutorialPopup .content::-webkit-scrollbar{width:8px}
#tutorialPopup .content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:8px}

#tutorialPopup .content{max-width:720px;width:92%;border-radius:12px;padding:18px;background:linear-gradient(180deg,#071226,#0b1a2a);color:#e6f0ff;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 40px rgba(2,6,23,0.5);}
#tutorialPopup h3{margin:0 0 8px 0;font-size:18px;}
.tut-step{margin:8px 0;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));}
.tut-step b{display:block;margin-bottom:6px;color:#fff;}
.tut-close{margin-top:12px;display:flex;justify-content:flex-end;}
.tut-close button{padding:8px 12px;border-radius:8px;border:none;background:#b58900;color:white;font-weight:700;cursor:pointer;}
.tut-small{font-size:13px;color:#9fb3c6;margin-top:6px;}
</style>

<div id="tutorialPopup" onclick="if(event.target===this) closeTutorial()">
  <div class="content">
    <h3>Cara Pakai ‚Äî Toko Akun & OTP</h3>
    <div class="tut-step">
      <b>1) Menjelajah Produk</b>
      Gunakan tab <em>Akun TikTok</em>, <em>OTP / APK</em>, atau <em>Rekber</em>. Pilih kategori <strong>Basic</strong> atau <strong>Premium</strong>, lalu scroll untuk melihat produk. Gunakan kotak pencarian untuk menemukan produk cepat.
    </div>
    <div class="tut-step">
      <b>2) Menambahkan ke Keranjang</b>
      Atur jumlah dengan tombol <strong>-</strong> / <strong>+</strong>, lalu tekan ikon keranjang hijau pada produk untuk memasukkan. Lihat jumlah & isi keranjang lewat menu ‚ò∞ ‚Üí <em>Keranjang</em>.
    </div>
    <div class="tut-step">
      <b>3) Favorit</b>
      Tekan ikon ‚ù§Ô∏è pada produk untuk menyimpan ke favorit. Buka lewat menu ‚ò∞ ‚Üí <em>Favorit</em>.
    </div>
    <div class="tut-step">
      <b>4) VIP & Voucher</b>
      Menu ‚ò∞ memiliki akses cepat ke <em>VIP</em> dan <em>Voucher</em>. VIP memberikan akses harian khusus; voucher berisi kode & diskon.
    </div>
    <div class="tut-step">
      <b>5) Reset / Backup / Upload</b>
      Buka ‚ò∞ ‚Üí <em>Pengaturan</em>.  
      - <strong>Reset (kecuali stok)</strong>: kembalikan state kecuali stok produk.  
      - <strong>Backup</strong>: unduh file .json berisi state saat ini (juga tersimpan di localStorage).  
      - <strong>Upload</strong>: pilih file .json untuk langsung menerapkan (akan ditanya apakah stok dipertahankan).
    </div>
    <div class="tut-step">
      <b>6) Pembayaran & Selesai</b>
      Setelah isi keranjang, buka Keranjang ‚Üí periksa detail ‚Üí lanjutkan ke checkout sesuai instruksi pada popup (metode transfer / rekber tergantung produk).
    </div>

    <div class="tut-small">Jika butuh bantuan lebih lanjut, hubungi admin atau lihat bagian <em>History</em> & <em>Notifikasi</em> lewat menu ‚ò∞.</div>

    <div class="tut-close">
      <button onclick="closeTutorial()">Tutup</button>
    </div>
  </div>
</div>

<script>
function openTutorial(){
  try{ toggleHambPanel(false); }catch(e){}
  const el = document.getElementById('tutorialPopup');
  if(el) el.style.display = 'flex';
}
function closeTutorial(){
  const el = document.getElementById('tutorialPopup');
  if(el) el.style.display = 'none';
}
</script>
<!-- ===== end Tutorial popup ===== -->


<!-- BEGIN: Encrypted backup (password protected) -->
<script>
// Helper utilities
function randBytes(len){ const a = new Uint8Array(len); crypto.getRandomValues(a); return a; }
function arrayBufferToBase64(buffer){
  const bytes = new Uint8Array(buffer);
  let binary = '';
  const chunk = 0x8000;
  for (let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, Array.from(bytes.subarray(i, i+chunk)));
  }
  return btoa(binary);
}
function base64ToArrayBuffer(base64){
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
  return bytes.buffer;
}

async function deriveKeyFromPassword(password, salt){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: 150000, hash: 'SHA-256' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
}

async function encryptObjectWithPassword(obj, password){
  const plain = new TextEncoder().encode(JSON.stringify(obj));
  const salt = randBytes(16);
  const iv = randBytes(12);
  const key = await deriveKeyFromPassword(password, salt.buffer);
  const cipherBuffer = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv.buffer}, key, plain);
  return {
    v: 1,
    alg: 'AES-GCM',
    kdf: 'PBKDF2-SHA256',
    iterations: 150000,
    salt: arrayBufferToBase64(salt.buffer),
    iv: arrayBufferToBase64(iv.buffer),
    data: arrayBufferToBase64(cipherBuffer),
    meta: { created: (new Date()).toISOString(), note: 'Encrypted backup. Use password to restore.' }
  };
}

async function decryptWrapperWithPassword(wrapper, password){
  if(!wrapper || !wrapper.data || !wrapper.iv || !wrapper.salt) throw new Error('Not encrypted backup format');
  const salt = base64ToArrayBuffer(wrapper.salt);
  const iv = base64ToArrayBuffer(wrapper.iv);
  const cipher = base64ToArrayBuffer(wrapper.data);
  const key = await deriveKeyFromPassword(password, salt);
  const plainBuffer = await crypto.subtle.decrypt({name:'AES-GCM', iv: iv}, key, cipher);
  const text = new TextDecoder().decode(plainBuffer);
  return JSON.parse(text);
}

// Download encrypted backup: ask password, encrypt, download, save to localStorage (optional)
async function downloadEncryptedBackup(){
  try{
    const st = (typeof getSerializableState === 'function') ? getSerializableState() : (window.__fallback_get_state && window.__fallback_get_state() || {});
    let pwd = prompt('Masukkan password untuk enkripsi backup (ingat password ini untuk restore):');
    if(pwd === null) return;
    if(!pwd || pwd.length < 6){
      if(!confirm('Password kurang dari 6 karakter. Lanjutkan? (disarankan minimal 6 karakter)')) return;
    }
    const wrapper = await encryptObjectWithPassword(st, pwd);
    const blob = new Blob([JSON.stringify(wrapper)], {type:'application/json'});
    const now = new Date();
    const fname = `backup_enc_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.bak`;
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    try{ localStorage.setItem('app_backup_encrypted', JSON.stringify(wrapper)); }catch(e){}
    alert('Backup terenkripsi telah diunduh. Simpan password dengan aman.');
  }catch(err){
    console.error(err); alert('Gagal membuat backup terenkripsi: '+ (err && err.message || err));
  }
}

// Upload handler for encrypted or plain backup
function handleUploadAndApplyEncrypted(ev){
  try{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async function(e){
      try{
        const parsed = JSON.parse(e.target.result);
        if(parsed && parsed.data && parsed.iv && parsed.salt && parsed.v === 1){
          const pwd = prompt('File backup terenkripsi terdeteksi. Masukkan password untuk mendekripsi:');
          if(pwd === null) return;
          try{
            const stateObj = await decryptWrapperWithPassword(parsed, pwd);
            const keep = confirm('Apakah stok saat ini ingin dipertahankan? (OK = YA, Batal = Tidak ‚Äî stok akan diambil dari file)');
            const ok = (typeof applyState === 'function') ? applyState(stateObj, {keepStocks: keep}) : false;
            if(ok){ alert('Backup terenkripsi berhasil diterapkan.'); closeSettings(); }
            else alert('Backup didekripsi, tapi penerapan state gagal (cek console).');
          }catch(de){
            console.error(de); alert('Password salah atau file korup. Gagal mendekripsi.');
          }
        } else {
          if(!confirm('File tidak terenkripsi. Terapkan langsung sebagai backup?')) return;
          const keep = confirm('Apakah stok saat ini ingin dipertahankan? (OK = YA, Batal = Tidak)');
          const ok = (typeof applyState === 'function') ? applyState(parsed, {keepStocks: keep}) : false;
          if(ok){ alert('Backup (plain) berhasil diterapkan.'); closeSettings(); }
          else alert('Gagal menerapkan backup (plain).');
        }
      }catch(err){ console.error(err); alert('Gagal membaca file backup. Pastikan file berformat JSON atau backup terenkripsi yang valid.'); }
    };
    reader.readAsText(file);
  }catch(e){ console.error(e); alert('Gagal mengunggah file.'); }
}

// Expose to global (so existing buttons call these)
window.downloadEncryptedBackup = downloadEncryptedBackup;
window.handleUploadAndApplyEncrypted = handleUploadAndApplyEncrypted;
</script>
<!-- END: Encrypted backup (password protected) -->


<script>
// Store uploaded backup (encrypted wrapper or plain) into localStorage and window.__uploaded_backup
function handleUploadAndStore(ev){
  try{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const parsed = JSON.parse(e.target.result);
        // store parsed wrapper as JSON string in localStorage
        try{ localStorage.setItem('app_uploaded_backup', JSON.stringify(parsed)); window.__uploaded_backup = parsed; }catch(se){ console.warn('Could not save to localStorage', se); window.__uploaded_backup = parsed; }
        const info = document.getElementById('uploadInfo');
        if(info) info.textContent = 'File "' + file.name + '" disimpan untuk restore (tanpa perlu refresh). Klik "Restore Upload" untuk menerapkan.';
        alert('Backup berhasil diunggah dan disimpan sementara. Gunakan "Restore Upload" untuk menerapkan kapan saja.');
      }catch(pe){
        console.error('parse uploaded file error', pe);
        alert('Gagal membaca file JSON. Pastikan format benar.');
      }
    };
    reader.readAsText(file);
    // reset the input so same file can be reselected later if needed
    ev.target.value = '';
  }catch(e){
    console.error('handleUploadAndStore error', e);
    alert('Gagal mengunggah file.');
  }
}

// Restore uploaded backup previously stored in localStorage or window.__uploaded_backup
async function restoreUploadedBackup(){
  try{
    let raw = window.__uploaded_backup || localStorage.getItem('app_uploaded_backup');
    if(!raw){
      return alert('Tidak ada file backup yang diunggah. Gunakan Upload terlebih dahulu.');
    }
    let parsed = (typeof raw === 'string') ? JSON.parse(raw) : raw;

    // if encrypted wrapper detected
    if(parsed && parsed.data && parsed.iv && parsed.salt && parsed.v === 1){
      const pwd = prompt('Backup terenkripsi terdeteksi. Masukkan password untuk mendekripsi:');
      if(pwd === null) return;
      try{
        // decryptWrapperWithPassword should be available (from encrypted helpers)
        const stateObj = await decryptWrapperWithPassword(parsed, pwd);
        const keep = confirm('Apakah stok saat ini ingin dipertahankan? (OK = YA, Batal = Tidak ‚Äî stok akan diambil dari file)');
        const ok = (typeof applyState === 'function') ? applyState(stateObj, {keepStocks: keep}) : false;
        if(ok) { alert('Backup berhasil diterapkan dari unggahan (tanpa refresh).'); closeSettings(); } else alert('Gagal menerapkan state setelah dekripsi. Cek console.');
      }catch(de){
        console.error(de); alert('Password salah atau file korup. Gagal mendekripsi.');
      }
    } else {
      // plain JSON state
      if(!confirm('File backup tidak terenkripsi. Terapkan sekarang?')) return;
      const keep = confirm('Apakah stok saat ini ingin dipertahankan? (OK = YA, Batal = Tidak)');
      const ok = (typeof applyState === 'function') ? applyState(parsed, {keepStocks: keep}) : false;
      if(ok){ alert('Backup (plain) berhasil diterapkan dari unggahan (tanpa refresh).'); closeSettings(); }
      else alert('Gagal menerapkan backup (plain). Cek console.');
    }
  }catch(e){
    console.error('restoreUploadedBackup error', e);
    alert('Gagal merestore backup unggahan.');
  }
}

// Clear stored uploaded backup
function clearUploadedBackup(){
  try{
    localStorage.removeItem('app_uploaded_backup');
    window.__uploaded_backup = undefined;
    const info = document.getElementById('uploadInfo');
    if(info) info.textContent = '';
    alert('Backup unggahan dihapus.');
  }catch(e){
    console.error(e);
    alert('Gagal menghapus backup unggahan.');
  }
}
</script>


<!-- Reset confirmation popup requiring chat confirmation -->

<!-- Reset confirmation popup requiring typing "konfirmasi" -->

<!-- Reset confirmation popup requiring exact uppercase "KONFIRMASI" -->
<div id="resetConfirmPopup" onclick="if(event.target===this) closeResetConfirm()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);justify-content:center;align-items:center;z-index:1400;">
  <div class="popup-content" style="max-width:520px;width:92%;border-radius:12px;padding:18px;">
    <h3 style="margin:0 0 8px 0;">Konfirmasi Reset</h3>
    <p style="margin:6px 0;color:#fca5a5;">
      <strong>Perhatian:</strong> Reset akan menghapus banyak data (kecuali stok jika dipilih). 
      Pastikan kamu sudah melakukan <strong>Backup</strong> file ‚Äî silahkan download dulu. Apabila sudah download kamu dapat melakukan reset pabrik.
    </p>
    <div style="margin:10px 0;">
      <label style="display:block;font-size:14px;color:#94a3b8;margin-bottom:8px;">Ketik kata <strong>KONFIRMASI</strong> (huruf BESAR semua) untuk mengaktifkan tombol Reset:</label>
      <input id="resetConfirmInput" type="text" placeholder='KETIK "KONFIRMASI" DI SINI (HURUF BESAR)' style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button onclick="closeResetConfirm()" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.08);">Batal</button>
      <button id="resetConfirmOkBtn" onclick="performResetExceptStock()" disabled style="padding:8px 12px;border-radius:8px;background:#ef4444;color:white;border:none;opacity:0.6;cursor:not-allowed;">Oke, Reset Sekarang</button>
    </div>
    <div style="margin-top:10px;color:#9fb3c6;font-size:13px;">Jika belum menghubungi admin, silakan chat dulu agar data penting tidak hilang.</div>
  </div>
</div>

<script>
function openResetConfirm(){
  try{
    var popup = document.getElementById('resetConfirmPopup');
    if(!popup) return alert('Konfirmasi reset tidak tersedia.');
    var input = document.getElementById('resetConfirmInput');
    var okBtn = document.getElementById('resetConfirmOkBtn');
    // reset state
    popup.style.display = 'flex';
    if(input){ input.value = ''; input.focus(); }
    if(okBtn){ okBtn.disabled = true; okBtn.style.opacity = 0.6; okBtn.style.cursor = 'not-allowed'; }
    // attach listener
    try{
      input.removeEventListener('input', window.__resetConfirmListener);
    }catch(e){}
    window.__resetConfirmListener = function(){
      var v = (input.value||'');
      // require exact uppercase KONFIRMASI
      if(v === 'KONFIRMASI'){
        okBtn.disabled = false;
        okBtn.style.opacity = 1;
        okBtn.style.cursor = 'pointer';
      } else {
        okBtn.disabled = true;
        okBtn.style.opacity = 0.6;
        okBtn.style.cursor = 'not-allowed';
      }
    };
    input.addEventListener('input', window.__resetConfirmListener);
  }catch(e){ console.error(e); alert('Gagal menampilkan konfirmasi.'); }
}
function closeResetConfirm(){
  try{
    var popup = document.getElementById('resetConfirmPopup');
    if(popup) popup.style.display = 'none';
    // detach listener
    try{
      var input = document.getElementById('resetConfirmInput');
      if(input && window.__resetConfirmListener) input.removeEventListener('input', window.__resetConfirmListener);
    }catch(e){}
  }catch(e){}
}
function performResetExceptStock(){
  try{
    // ensure input valid
    var input = document.getElementById('resetConfirmInput');
    if(!input || (input.value||'') !== 'KONFIRMASI'){
      return alert('Silakan ketik kata "KONFIRMASI" (huruf BESAR semua) untuk dapat melakukan reset.');
    }
    // close popup
    closeResetConfirm();
    // call existing reset function if exists
    if(typeof askResetExceptStock === 'function'){
      return openResetConfirm();
    } else if(typeof __initial_snapshot_for_reset !== 'undefined' && typeof applyState === 'function'){
      var ok = applyState(__initial_snapshot_for_reset, {keepStocks:true});
      if(ok) alert('Reset berhasil (kecuali stok).');
      else alert('Reset gagal. Periksa console.');
      return;
    } else {
      alert('Fungsi reset tidak ditemukan.');
    }
  }catch(e){ console.error(e); alert('Gagal melakukan reset.'); }
}
</script>
<!-- End reset confirmation popup requiring exact uppercase KONFIRMASI -->
 



<!-- ABOUT POPUP -->
<div id="aboutPopup" onclick="if(event.target===this) closeAbout()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1600;">
  <div class="popup-content" style="max-width:720px;width:94%;border-radius:12px;padding:18px;">
    <h3 style="margin:0 0 8px 0;">Tentang Aplikasi</h3>
    <p style="margin:6px 0;color:var(--muted, #6b7280);">
      Ini adalah aplikasi <strong>TokoAkun VIP</strong> versi <strong>v41</strong>. Fitur utama: jual akun, voucher, VIP, backup/restore tanpa perlu refresh, dan proteksi dasar voucher. 
    </p>
    <ul style="margin:8px 0 12px 18px;color:var(--muted, #6b7280);">
      <li>Developer: <strong>Anda / Tim</strong></li>
      <li>Kontak admin: <strong>chat atau nomor yang ditentukan</strong></li>
      <li>Fitur keamanan: voucher dibatasi per device/IP, backup terenkripsi, konfirmasi reset</li>
      <li>Catatan: backup sangat penting ‚Äî admin tidak bertanggung jawab bila reset tanpa backup</li>
    </ul>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
      <div>
        <strong>Versi</strong><div class="small" style="margin-top:6px;">v41 (release lokal)</div>
      </div>
      <div>
        <strong>Lisensi</strong><div class="small" style="margin-top:6px;">Non-komersial / internal</div>
      </div>
    </div>

    <div style="margin-top:12px;color:var(--muted, #6b7280);font-size:13px;">
      Penggunaan: baca dokumentasi singkat, selalu unduh backup sebelum reset, dan hubungi admin untuk bantuan recovery.
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
      <button onclick="closeAbout()" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.08);">Tutup</button>
    </div>
  </div>
</div>
<!-- END ABOUT POPUP -->


<script>
// About popup controls
function openAbout(){ try{ document.getElementById('aboutPopup').style.display='flex'; }catch(e){ alert('Gagal membuka About'); } }
function closeAbout(){ try{ document.getElementById('aboutPopup').style.display='none'; }catch(e){} }

// Inject "Tentang / About" menu item into hamburger panel on load
document.addEventListener('DOMContentLoaded', function(){
  try{
    var hamb = document.getElementById('hamburgerPanel') || document.querySelector('.hamb-panel') || document.querySelector('#menuPanel') || document.querySelector('.nav');
    if(hamb && !document.getElementById('aboutMenuItem')){
      // create menu item element
      var item = document.createElement('div');
      item.id = 'aboutMenuItem';
      item.className = 'hamb-item';
      item.style.cursor = 'pointer';
      item.style.marginBottom = '8px';
      item.innerHTML = '<div style="display:flex;align-items:center;gap:10px;"><div class="hamb-badge-icon">i</div><div><div class="hamb-title">Tentang</div><div class="hamb-sub">Info & panduan singkat</div></div></div>';
      item.onclick = function(){ openAbout(); };
      // append to top of panel or end
      if(hamb.firstChild) hamb.insertBefore(item, hamb.firstChild);
      else hamb.appendChild(item);
    }
  }catch(e){}
});
</script>


<script>
// Ensure About menu item is placed inside the hamburger panel (garis 3)
document.addEventListener('DOMContentLoaded', function(){
  try{
    const selectors = [
      '#hamburgerPanel',
      '.hamb-panel',
      '.hamburger-panel',
      '#menuPanel',
      '.menu-panel',
      '.drawer',
      '.nav',
      'nav',
      '.sidebar',
      '#sidebar',
      '.panel'
    ];
    let pane = null;
    for(const s of selectors){
      const el = document.querySelector(s);
      if(el){
        pane = el;
        break;
      }
    }
    if(!pane){
      const candidates = Array.from(document.querySelectorAll('div,nav,section'));
      for(const c of candidates){
        try{
          if(c.id && /menu|hamb|panel|nav|drawer|sidebar/i.test(c.id)) { pane = c; break; }
          const cls = c.className || '';
          if(cls && /menu|hamb|panel|nav|drawer|sidebar/i.test(cls)) { pane = c; break; }
        }catch(e){}
      }
    }
    if(pane && !document.getElementById('aboutMenuItem')){
      const item = document.createElement('div');
      item.id = 'aboutMenuItem';
      item.className = 'hamb-item';
      item.style.cursor = 'pointer';
      item.style.padding = '10px 12px';
      item.style.borderRadius = '8px';
      item.style.marginBottom = '6px';
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '8px';
      item.innerHTML = '<div style="width:34px;height:34px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:700;color:#a06a00;">i</div><div style="flex:1"><div style="font-weight:700">Tentang</div><div style="font-size:12px;color:#64748b">Info & panduan singkat</div></div>';
      item.onclick = function(e){ e.preventDefault(); openAbout(); };
      if(pane.firstElementChild) pane.insertBefore(item, pane.firstElementChild);
      else pane.appendChild(item);
    } else if(!pane){
      const header = document.querySelector('.header') || document.querySelector('header') || document.body;
      if(header && !document.getElementById('aboutMenuItem')){
        const f = document.createElement('div');
        f.id = 'aboutMenuItem';
        f.style.cursor='pointer';
        f.style.display='inline-block';
        f.style.marginLeft='10px';
        f.innerHTML = '<a onclick="openAbout()" style="text-decoration:none;color:inherit;font-weight:700">Tentang</a>';
        header.appendChild(f);
      }
    }
  }catch(e){
    console.error('inject about into hamburger error', e);
  }
});
</script>


<!-- PRICE LIST POPUP -->
<div id="priceListPopup" onclick="if(event.target===this) closePriceList()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1700;">
  <div class="popup-content" style="max-width:820px;width:96%;border-radius:12px;padding:18px;max-height:80vh;overflow:auto;">
    <h3 style="margin:0 0 8px 0;">Daftar Harga Produk</h3>
    <p style="margin:6px 0;color:#475569;">Berikut contoh daftar harga produk. Kamu bisa mengganti nama, deskripsi, dan harga sesuai kebutuhan di file.</p>
    
<table id="priceListTable" style="width:100%;border-collapse:collapse;margin-top:10px;">
  <thead>
    <tr style="text-align:left;border-bottom:1px solid rgba(15,23,42,0.06);">
      <th style="padding:8px 6px;">Produk</th>
      <th style="padding:8px 6px;">Deskripsi</th>
      <th style="padding:8px 6px;">Stok</th>
      <th style="padding:8px 6px;">Harga (Rp)</th>
    </tr>
  </thead>

  <!-- Category nav (clickable) -->
  <tbody>
    <tr><td colspan="4" style="padding:8px 6px;">
      <div id="priceCategoryNav" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px;">
        <button onclick="showPriceCategory('all')" id="catbtn-all" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:#eef2ff;cursor:pointer;font-weight:700;">Semua</button>
        <button onclick="showPriceCategory('vip')" id="catbtn-vip" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üü¢ Paket VIP</button>
        <button onclick="showPriceCategory('follower_premium')" id="catbtn-follower_premium" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üîµ Follower (Premium)</button>
        <button onclick="showPriceCategory('follower_basic')" id="catbtn-follower_basic" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üü£ Follower (Basic)</button>
        <button onclick="showPriceCategory('otp')" id="catbtn-otp" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üü† Layanan OTP</button>
        <button onclick="showPriceCategory('rekber_basic')" id="catbtn-rekber_basic" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üü£ Rekber Basic</button>
        <button onclick="showPriceCategory('rekber_premium')" id="catbtn-rekber_premium" style="padding:6px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer;">üü¢ Rekber Premium</button>
      </div>
    </td></tr>
  </tbody>

  <tbody id="priceRows">
    <!-- VIP -->
    <tr class="cat-header" id="cat-vip"><td style="padding:8px 6px;font-weight:700;">üü¢ Paket VIP</td><td colspan="3"></td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 30 Hari</td><td style="padding:8px 6px;">Akses penuh 30 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp15.000</td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 60 Hari</td><td style="padding:8px 6px;">Akses penuh 60 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp30.000</td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 90 Hari</td><td style="padding:8px 6px;">Akses penuh 90 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp45.000</td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 120 Hari</td><td style="padding:8px 6px;">Akses penuh 120 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp60.000</td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 150 Hari</td><td style="padding:8px 6px;">Akses penuh 150 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp75.000</td></tr>
    <tr data-cat="vip"><td style="padding:8px 6px;">Paket VIP 180 Hari</td><td style="padding:8px 6px;">Akses penuh 180 hari</td><td style="padding:8px 6px;">unlimited</td><td style="padding:8px 6px;">Rp90.000</td></tr>

    <tr><td colspan="4" style="height:12px;"></td></tr>

    <!-- Follower Premium -->
    <tr class="cat-header" id="cat-follower_premium"><td style="padding:8px 6px;font-weight:700;">üîµ Follower (Premium)</td><td colspan="3"></td></tr>
    <tr data-cat="follower_premium"><td style="padding:8px 6px;">1K Followers Premium</td><td style="padding:8px 6px;">Premium garansi full</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp50.000</td></tr>
    <tr data-cat="follower_premium"><td style="padding:8px 6px;">2K Followers Premium</td><td style="padding:8px 6px;">Premium garansi full</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp100.000</td></tr>
    <tr data-cat="follower_premium"><td style="padding:8px 6px;">5K Followers Premium</td><td style="padding:8px 6px;">Premium garansi full</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp250.000</td></tr>
    <tr data-cat="follower_premium"><td style="padding:8px 6px;">10K Followers Premium</td><td style="padding:8px 6px;">Premium garansi full</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp500.000</td></tr>

    <tr><td colspan="4" style="height:12px;"></td></tr>

    <!-- Follower Basic -->
    <tr class="cat-header" id="cat-follower_basic"><td style="padding:8px 6px;font-weight:700;">üü£ Follower (Basic)</td><td colspan="3"></td></tr>
    <tr data-cat="follower_basic"><td style="padding:8px 6px;">1K Followers Basic</td><td style="padding:8px 6px;">Basic tanpa garansi</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp100.000</td></tr>
    <tr data-cat="follower_basic"><td style="padding:8px 6px;">2K Followers Basic</td><td style="padding:8px 6px;">Basic tanpa garansi</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp200.000</td></tr>
    <tr data-cat="follower_basic"><td style="padding:8px 6px;">5K Followers Basic</td><td style="padding:8px 6px;">Basic tanpa garansi</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp500.000</td></tr>
    <tr data-cat="follower_basic"><td style="padding:8px 6px;">10K Followers Basic</td><td style="padding:8px 6px;">Basic tanpa garansi</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp1.000.000</td></tr>

    <tr><td colspan="4" style="height:12px;"></td></tr>

    <!-- OTP -->
    <tr class="cat-header" id="cat-otp"><td style="padding:8px 6px;font-weight:700;">üü† Layanan OTP</td><td colspan="3"></td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Dana</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP OVO</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Gopay</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP ShopeePay</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP WhatsApp</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Telegram</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp10.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Facebook</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Instagram</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP Twitter</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp2.000</td></tr>
    <tr data-cat="otp"><td style="padding:8px 6px;">OTP All APK</td><td style="padding:8px 6px;">OTP berlaku untuk 1 kali pakai</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp3.000</td></tr>

    <tr><td colspan="4" style="height:12px;"></td></tr>

    <!-- Rekber Basic -->
    <tr class="cat-header" id="cat-rekber_basic"><td style="padding:8px 6px;font-weight:700;">üü£ Rekber Basic</td><td colspan="3"></td></tr>
    <tr data-cat="rekber_basic"><td style="padding:8px 6px;">Rekber Jefry Alson Basic</td><td style="padding:8px 6px;">Sudah termasuk ajak admin rekber</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp10.000</td></tr>
    <tr data-cat="rekber_basic"><td style="padding:8px 6px;">Rekber Julie Sean Basic</td><td style="padding:8px 6px;">Sudah termasuk ajak admin rekber</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp10.000</td></tr>

    <tr><td colspan="4" style="height:12px;"></td></tr>

    <!-- Rekber Premium -->
    <tr class="cat-header" id="cat-rekber_premium"><td style="padding:8px 6px;font-weight:700;">üü¢ Rekber Premium</td><td colspan="3"></td></tr>
    <tr data-cat="rekber_premium"><td style="padding:8px 6px;">Rekber Jefry Alson Premium</td><td style="padding:8px 6px;">Sudah termasuk ajak admin rekber</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp11.000</td></tr>
    <tr data-cat="rekber_premium"><td style="padding:8px 6px;">Rekber Julie Sean Premium</td><td style="padding:8px 6px;">Sudah termasuk ajak admin rekber</td><td style="padding:8px 6px;">100</td><td style="padding:8px 6px;">Rp10.000</td></tr>
  </tbody>
</table>

<script>
// Category navigation functions for price list popup
function showPriceCategory(cat){
  try{
    const rows = document.querySelectorAll('#priceRows tr[data-cat], #priceRows tr.cat-header');
    // reset all visible by default
    if(cat === 'all'){
      rows.forEach(r => { r.style.display = ''; });
      setActiveCatButton('all');
      return;
    }
    // hide everything then show headers & rows for selected cat
    rows.forEach(r => {
      const rc = r.getAttribute('data-cat');
      const isHeader = r.classList.contains('cat-header');
      if(isHeader){
        // header id pattern: cat-<catname>
        if(r.id === 'cat-' + cat) r.style.display = '';
        else r.style.display = 'none';
      } else {
        if(rc === cat) r.style.display = '';
        else r.style.display = 'none';
      }
    });
    // scroll header into view
    var hdr = document.getElementById('cat-' + cat);
    if(hdr) hdr.scrollIntoView({behavior:'smooth', block:'start'});
    setActiveCatButton(cat);
  }catch(e){
    console.error('showPriceCategory error', e);
  }
}

function setActiveCatButton(cat){
  const btns = document.querySelectorAll('#priceCategoryNav button');
  btns.forEach(b => { b.style.background = 'white'; b.style.borderColor = '#e6eef8'; b.style.fontWeight = '400'; });
  const active = document.getElementById('catbtn-' + cat);
  if(active){ active.style.background = '#eef2ff'; active.style.borderColor = '#b58900'; active.style.fontWeight = '700'; }
}

// Initialize: ensure 'Semua' active when popup opens
document.addEventListener('DOMContentLoaded', function(){
  setActiveCatButton('all');
});
</script>


    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
      <div style="color:#64748b;font-size:13px;">Butuh perubahan? Saya bisa sesuaikan daftar ini.</div>
      <div>
        <button onclick="closePriceList()" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.08);margin-right:8px;">Tutup</button>
        <button onclick="downloadPriceListCSV()" style="padding:8px 12px;border-radius:8px;background:#b58900;color:#fff;border:none;">Unduh CSV</button>
      </div>
    </div>
  </div>
</div>
<!-- END PRICE LIST POPUP -->


<script>
// Open/close price list popup
function openPriceList(){ try{ document.getElementById('priceListPopup').style.display='flex'; }catch(e){ alert('Gagal membuka daftar harga'); } }
function closePriceList(){ try{ document.getElementById('priceListPopup').style.display='none'; }catch(e){} }

// Download table as CSV
function downloadPriceListCSV(){
  try{
    var rows = [];
    var tbl = document.getElementById('priceListTable');
    if(!tbl) return alert('Tidak ada data.');
    for(var i=0;i<tbl.rows.length;i++){
      var cols = tbl.rows[i].querySelectorAll('td,th');
      var row = [];
      cols.forEach(function(c){ row.push('"' + (c.innerText||'').replace(/"/g,'""') + '"'); });
      rows.push(row.join(','));
    }
    var csv = rows.join('\n');
    var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'daftar_harga_produk.csv';
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){ alert('Gagal unduh CSV'); console.error(e); }
}

// Inject "Daftar Harga" into hamburger panel (re-use existing hamburger injection logic)
document.addEventListener('DOMContentLoaded', function(){
  try{
    // try common selectors first
    var pane = document.querySelector('#hamburgerPanel') || document.querySelector('.hamb-panel') || document.querySelector('.hamburger-panel') || document.querySelector('#menuPanel') || document.querySelector('.menu-panel') || document.querySelector('.drawer') || document.querySelector('nav') || document.querySelector('.nav') || document.querySelector('.panel') || document.querySelector('.sidebar') || document.querySelector('#sidebar');
    if(!pane){
      // fallback: find element that looks like menu
      var candidates = Array.from(document.querySelectorAll('div,nav,section'));
      for(var c of candidates){
        try{
          if(c.id && /menu|hamb|panel|nav|drawer|sidebar/i.test(c.id)){ pane = c; break; }
          if(c.className && /menu|hamb|panel|nav|drawer|sidebar/i.test(c.className)){ pane = c; break; }
        }catch(e){}
      }
    }
    if(pane && !document.getElementById('priceMenuItem')){
      var item = document.createElement('div');
      item.id = 'priceMenuItem';
      item.className = 'hamb-item';
      item.style.cursor = 'pointer';
      item.style.padding = '10px 12px';
      item.style.borderRadius = '8px';
      item.style.marginBottom = '6px';
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '8px';
      item.innerHTML = '<div style="width:34px;height:34px;border-radius:8px;background:#ecfeff;display:flex;align-items:center;justify-content:center;font-weight:700;color:#6b3e00;">Rp</div><div style="flex:1"><div style="font-weight:700">Daftar Harga</div><div style="font-size:12px;color:#64748b">Lihat & unduh harga produk</div></div>';
      item.onclick = function(e){ e.preventDefault(); openPriceList(); };
      if(pane.firstElementChild) pane.insertBefore(item, pane.firstElementChild.nextSibling);
      else pane.appendChild(item);
    } else if(!pane){
      // fallback: append small button into header
      var header = document.querySelector('.header') || document.querySelector('header') || document.body;
      if(header && !document.getElementById('priceMenuItem')){
        var f = document.createElement('div');
        f.id = 'priceMenuItem';
        f.style.cursor='pointer';
        f.style.display='inline-block';
        f.style.marginLeft='10px';
        f.innerHTML = '<a onclick="openPriceList()" style="text-decoration:none;color:inherit;font-weight:700">Daftar Harga</a>';
        header.appendChild(f);
      }
    }
  }catch(e){ console.error('inject price menu error', e); }
});
</script>


<script>
(function(){
  try{
    // Force dropdown to use click toggle (override hover display)
    var style = document.createElement('style');
    style.innerHTML = '.footer-enhanced .dropdown .dropdown-content{display:none !important;} .footer-enhanced .dropdown.open .dropdown-content{display:block !important;}';
    document.head.appendChild(style);

    var drop = document.querySelector('.footer-enhanced .dropdown');
    if(drop){
      var btn = drop.querySelector('.dropbtn');
      var content = drop.querySelector('.dropdown-content');
      function outsideClick(e){
        if(!drop.contains(e.target)){
          drop.classList.remove('open');
          document.removeEventListener('click', outsideClick);
        }
      }
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        var nowOpen = drop.classList.toggle('open');
        // play a small toggle sound if enabled
        try{
          if(localStorage.getItem('app_sound_on_v1') === '1' || (document.getElementById('notifSwitch') && document.getElementById('notifSwitch').classList.contains('on'))){
            playToggleSound();
          }
        }catch(err){ console.warn('toggle sound err', err); }
        if(nowOpen){
          // attach outside click to close
          setTimeout(function(){ document.addEventListener('click', outsideClick); }, 0);
        } else {
          document.removeEventListener('click', outsideClick);
        }
      });
      // close dropdown when a link is clicked
      content.querySelectorAll('a').forEach(function(a){
        a.addEventListener('click', function(){ drop.classList.remove('open'); document.removeEventListener('click', outsideClick); });
      });
    }

    // Play a short toggle "click" sound (uses WebAudio)
    window.playToggleSound = function(){
      try{
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var o = ctx.createOscillator();
        var g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = 1200;
        g.gain.value = 0.02;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(function(){ o.stop(); ctx.close(); }, 80);
      }catch(e){ console.warn('playToggleSound', e); }
    };

    // Play a friendly chime (two tones) for notifications
    window.playChime = function(){
      try{
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var g = ctx.createGain(); g.gain.value = 0.02; g.connect(ctx.destination);
        var o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=660; o1.connect(g);
        var o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=880; o2.connect(g);
        var now = ctx.currentTime;
        o1.start(now); o1.stop(now + 0.12);
        o2.start(now + 0.12); o2.stop(now + 0.26);
        setTimeout(function(){ try{ ctx.close(); }catch(e){} }, 400);
      }catch(e){ console.warn('playChime', e); }
    };

    // Override sampleNotify to use playChime (instead of previous beep)
    window.sampleNotify = function(){
      var enabled = localStorage.getItem('app_sound_on_v1') === '1' || (document.getElementById('notifSwitch') && document.getElementById('notifSwitch').classList.contains('on'));
      if(enabled) {
        try{ window.playChime(); }catch(e){ console.warn(e); }
      }
      alert('Tes notifikasi: ' + (enabled ? 'Suara ON' : 'Suara OFF'));
    };

    // Ensure toggle switch plays a short toggle sound (when clicked)
    var sw = document.getElementById('notifSwitch');
    if(sw){
      sw.addEventListener('click', function(e){
        // after toggle logic (handled elsewhere), play a softer click
        setTimeout(function(){
          if(localStorage.getItem('app_sound_on_v1') === '1' || sw.classList.contains('on')){
            try{ playToggleSound(); }catch(e){};
          }
        }, 80);
      });
    }

  }catch(e){ console.error('dropdown toggle init err', e); }
})();
</script>


<script>
(function(){
  try{
    // Override toggleNotif to avoid playing sound when toggling the switch.
    window.toggleNotif = function(el){
      try{
        var on = !el.classList.contains('on');
        if(on){
          el.classList.add('on');
          el.setAttribute('aria-checked','true');
          localStorage.setItem('app_sound_on_v1','1');
        } else {
          el.classList.remove('on');
          el.setAttribute('aria-checked','false');
          localStorage.setItem('app_sound_on_v1','0');
        }
        var statusEl = document.getElementById('statusSound');
        if(statusEl) statusEl.textContent = on ? 'ON' : 'OFF';
      }catch(e){ console.error('toggleNotif override err', e); }
    };

    // Replace the switch element to remove previously attached listeners that may play sounds.
    var sw = document.getElementById('notifSwitch');
    if(sw && sw.parentNode){
      var newSw = sw.cloneNode(true);
      // ensure aria state sync
      var saved = localStorage.getItem('app_sound_on_v1');
      if(saved === '1') newSw.classList.add('on'); else newSw.classList.remove('on');
      newSw.onclick = function(e){ e.stopPropagation(); window.toggleNotif(newSw); };
      sw.parentNode.replaceChild(newSw, sw);
      // update status text
      var statusEl = document.getElementById('statusSound');
      if(statusEl) statusEl.textContent = (saved === '1') ? 'ON' : 'OFF';
    }

    // Ensure only the dropdown button (social media) triggers playToggleSound.
    var drop = document.querySelector('.footer-enhanced .dropdown');
    if(drop){
      var btn = drop.querySelector('.dropbtn');
      // remove previous click handlers by cloning button
      if(btn && btn.parentNode){
        var newBtn = btn.cloneNode(true);
        newBtn.addEventListener('click', function(e){
          e.stopPropagation();
          var nowOpen = drop.classList.toggle('open');
          if(nowOpen){
            // play sound only if sound setting ON
            if(localStorage.getItem('app_sound_on_v1') === '1') {
              try{ window.playToggleSound(); }catch(err){ console.warn(err); }
            }
            // attach outside click to close
            setTimeout(function(){
              function outsideClickHandler(ev){
                if(!drop.contains(ev.target)){
                  drop.classList.remove('open');
                  document.removeEventListener('click', outsideClickHandler);
                }
              }
              document.addEventListener('click', outsideClickHandler);
            }, 0);
          }
        });
        btn.parentNode.replaceChild(newBtn, btn);
        // ensure links inside the dropdown close the menu without playing sounds
        var content = drop.querySelector('.dropdown-content');
        if(content){
          content.querySelectorAll('a').forEach(function(a){
            a.addEventListener('click', function(e){
              drop.classList.remove('open');
            });
          });
        }
      }
    }

    // Prevent other generic buttons from triggering playToggleSound by ensuring no global handlers exist.
    // If any element had an onclick invoking playToggleSound directly, override window.playToggleSound reference check.
    var origPlayToggle = window.playToggleSound;
    window.playToggleSound = function(){
      // Only allow playToggleSound to run when explicitly called by our dropdown button (we control calls).
      // If we need to play it elsewhere, we should call origPlayToggle directly.
      try{
        if(typeof origPlayToggle === 'function') {
          // do nothing by default to avoid accidental plays
        }
      }catch(e){}
    };

    // Provide a safe internal call for dropdown to use the real sound
    window.__playToggleSoundInternal = origPlayToggle;

    // Modify the dropdown button to use the internal function so only it triggers sound.
    var drop2 = document.querySelector('.footer-enhanced .dropdown');
    if(drop2){
      var btn2 = drop2.querySelector('.dropbtn');
      if(btn2){
        btn2.addEventListener('click', function(){
          if(localStorage.getItem('app_sound_on_v1') === '1'){
            try{ if(window.__playToggleSoundInternal) window.__playToggleSoundInternal(); }catch(e){console.warn(e);}
          }
        });
      }
    }

    // Also ensure sampleNotify uses playChime (it already does), but do not play on other UI actions.
    // Final: sync status text
    var statusEl = document.getElementById('statusSound');
    if(statusEl) statusEl.textContent = (localStorage.getItem('app_sound_on_v1') === '1') ? 'ON' : 'OFF';

  }catch(e){ console.error('override script err', e); }
})();
</script>


<script>
(function(){
  try{
    function $(sel){ return document.querySelector(sel); }
    var btn = document.getElementById('settingsBtn');
    var card = document.getElementById('appSettings');

    if(!btn || !card) return;

    // Toggle visibility function
    function showCard(show){
      if(show){
        card.classList.remove('hidden'); card.classList.add('visible');
        // scroll into view slightly
        setTimeout(function(){ try{ card.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){} }, 120);
      } else {
        card.classList.remove('visible'); card.classList.add('hidden');
      }
    }

    // Initialize based on current class
    var isVisible = card.classList.contains('visible');
    showCard(isVisible);

    btn.addEventListener('click', function(e){
      e.stopPropagation();
      isVisible = !card.classList.contains('visible');
      showCard(isVisible);
    });

    // Close when clicking outside the card (and not on the button)
    document.addEventListener('click', function(ev){
      if(!card.classList.contains('visible')) return;
      var target = ev.target;
      if(target === btn || btn.contains(target)) return;
      if(card.contains(target)) return;
      // otherwise hide
      showCard(false);
    });

    // Allow pressing Esc to close
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && card.classList.contains('visible')){
        showCard(false);
      }
    });

    // Prevent propagation for clicks inside card to avoid immediate close
    card.addEventListener('click', function(e){ e.stopPropagation(); });

  }catch(e){ console.error('settings toggle err', e); }
})();
</script>


<script>
(function(){
  try{
    function copyInsight(){
      try{
        var map = [
          ['ins_totalOrders','sum_totalOrders'],
          ['ins_totalSpent','sum_totalSpent'],
          ['ins_totalItems','sum_totalItems'],
          ['ins_avgOrder','sum_avgOrder'],
          ['ins_profit','sum_profit'],
          ['ins_date','sum_date']
        ];
        map.forEach(function(pair){
          var src = document.getElementById(pair[0]);
          var dst = document.getElementById(pair[1]);
          if(src && dst) dst.textContent = src.textContent;
        });
      }catch(e){ console.warn('copyInsight err', e); }
    }

    // Wrap existing renderInsight to also copy values when it runs
    if(window.renderInsight && typeof window.renderInsight === 'function'){
      var orig = window.renderInsight;
      window.renderInsight = function(showAlert){
        var res = orig.apply(this, arguments);
        try{ copyInsight(); }catch(e){ console.warn(e); }
        return res;
      };
    } else {
      // if renderInsight not ready yet, attempt to copy after a delay
      setTimeout(copyInsight, 800);
    }

    // Also copy on DOMContentLoaded and when visibility toggles
    document.addEventListener('DOMContentLoaded', copyInsight);
    // small interval to keep UI in sync when user triggers refresh button
    var t = setInterval(function(){ try{ copyInsight(); }catch(e){} }, 1200);
    // stop after 2 minutes to avoid long-running timers
    setTimeout(function(){ clearInterval(t); }, 120000);
  }catch(e){ console.error('sync script err', e); }
})();
</script>



<script>
(function(){
  // Ensure loader is visible for at least MIN_DISPLAY_MS milliseconds.
  var MIN_DISPLAY_MS = 10000; // 10 seconds
  var startTime = Date.now();
  var loader = document.getElementById('page-loader');

  function hide(){
    if(!loader) return;
    loader.classList.add('hidden');
    setTimeout(function(){ try{ if(loader && loader.parentNode) loader.parentNode.removeChild(loader); }catch(e){} }, 700);
  }

  function onLoadHide(){
    var elapsed = Date.now() - startTime;
    var remaining = Math.max(0, MIN_DISPLAY_MS - elapsed);
    setTimeout(hide, remaining);
  }

  // If the page fully loads, hide after ensuring minimum display time
  window.addEventListener('load', onLoadHide, {once:true});

  // If DOMContentLoaded occurs and page was already complete, also try to hide after min time
  document.addEventListener('DOMContentLoaded', function(){
    if (document.readyState === 'complete') {
      onLoadHide();
    }
  }, {once:true});

  // Absolute fallback: ensure the loader never blocks more than MIN_DISPLAY_MS + 1s
  setTimeout(function(){
    try{ hide(); }catch(e){}
  }, MIN_DISPLAY_MS + 1000);
})();
</script>






<!-- ===== Deteksi Koneksi Internet & Kuota ===== -->
<div id="offline-overlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  color:white;
  font-family:'Poppins',sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:999999;
  padding:20px;
  display:none;
">
  <h2 id="offline-title" style="margin-bottom:10px;">‚ö†Ô∏è Tidak Ada Koneksi Internet</h2>
  <p id="offline-msg">Silakan periksa sambungan internet Anda.</p>
</div>

<script>
(function(){
  const overlay = document.getElementById('offline-overlay');
  const title = document.getElementById('offline-title');
  const msg = document.getElementById('offline-msg');
  let wasOffline = false;
  let periodicChecker = null;
  const CHECK_INTERVAL_MS = 10000; // 10s between checks
  const FETCH_TIMEOUT_MS = 4000; // timeout for fetch attempts

  function showOverlay(text1, text2){
    try{
      if(title) title.textContent = text1;
      if(msg) msg.textContent = text2;
      if(overlay) overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }catch(e){ console.warn('showOverlay error', e); }
  }

  function hideOverlay(){
    try{
      if(overlay) overlay.style.display = 'none';
      document.body.style.overflow = '';
    }catch(e){ console.warn('hideOverlay error', e); }
  }

  // lightweight connectivity check using fetch to a 204 endpoint; uses AbortController for timeout
  async function checkOnlineAccess(){
    // If navigator.onLine is false, skip actual fetch
    if(!navigator.onLine) return false;
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), FETCH_TIMEOUT_MS);
    try{
      // generate_204 returns no content but indicates connectivity; mode no-cors reduces CORS trouble
      await fetch('https://www.google.com/generate_204', {method: 'GET', mode: 'no-cors', cache: 'no-store', signal: controller.signal});
      clearTimeout(id);
      return true;
    }catch(e){
      clearTimeout(id);
      return false;
    }
  }

  // Main update logic: detect both offline and "no access / kuota" cases
  async function updateConnection(){
    try{
      const online = navigator.onLine;
      if(!online){
        // clearly offline
        showOverlay('‚ö†Ô∏è Tidak Ada Koneksi Internet', 'Silakan periksa sambungan internet Anda.');
        wasOffline = true;
        return;
      }
      // navigator reports online: verify with lightweight fetch
      const hasAccess = await checkOnlineAccess();
      if(hasAccess){
        if(wasOffline){
          // show a brief "connecting" state then reload
          showOverlay('üîÑ Sedang menyambungkan jaringan...', 'Mohon tunggu ‚Äî halaman akan diperbarui.');
          // give small delay to allow network stabilization
          setTimeout(function(){
            try{ location.reload(); }catch(e){ console.warn('reload failed', e); hideOverlay(); }
          }, 1200);
        } else {
          hideOverlay();
        }
        wasOffline = false;
      } else {
        // navigator.onLine true but fetch failed -> likely captive portal / no data / kuota habis
        showOverlay('‚ö†Ô∏è Tidak Ada Akses Internet / Kuota Habis', 'Koneksi terdeteksi namun akses internet tidak tersedia. Periksa paket data atau login di jaringan Wi‚ÄëFi.');
        wasOffline = true;
      }
    }catch(err){
      console.warn('updateConnection error', err);
      // fallback to offline overlay to be safe
      showOverlay('‚ö†Ô∏è Tidak Ada Koneksi Internet', 'Terjadi kesalahan saat memeriksa koneksi. Silakan coba ulang.');
      wasOffline = true;
    }
  }

  // Start periodic checks when page is visible
  function startPeriodicChecks(){
    if(periodicChecker) return;
    periodicChecker = setInterval(updateConnection, CHECK_INTERVAL_MS);
  }
  function stopPeriodicChecks(){
    if(periodicChecker){ clearInterval(periodicChecker); periodicChecker = null; }
  }

  // Respond to browser online/offline events quickly, then rely on periodic checks for "no access" detection
  window.addEventListener('online', function(){
    updateConnection();
    startPeriodicChecks();
  });
  window.addEventListener('offline', function(){
    updateConnection();
    // keep periodic running so it'll auto-detect when connectivity returns
    startPeriodicChecks();
  });

  // When tab becomes visible again, re-run check (useful if network changed while hidden)
  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'visible'){
      updateConnection();
      startPeriodicChecks();
    } else {
      // while hidden we can keep checks but it's OK to stop to save resources
      // keep them running to detect reconnect even if hidden
    }
  });

  // Run initial check after DOM ready, and start periodic checking
  document.addEventListener('DOMContentLoaded', function(){
    updateConnection();
    startPeriodicChecks();
  });

  // safety: run once shortly after script in case it was added late
  setTimeout(function(){ updateConnection(); startPeriodicChecks(); }, 300);
})();
</script>
<!-- ===== Akhir Deteksi Koneksi Internet & Kuota ===== -->




<!-- ===== Deteksi Koneksi Internet & Kuota (Premium Overlay) ===== -->
<style>
/* Premium overlay styles */
#offline-overlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 999999;
  align-items: center;
  justify-content: center;
  background: linear-gradient(180deg, rgba(11,7,3,0.66), rgba(4,2,1,0.76));
  backdrop-filter: blur(6px) saturate(1.05);
  -webkit-backdrop-filter: blur(6px) saturate(1.05);
  padding: 28px;
  box-sizing: border-box;
  transition: opacity 280ms ease, visibility 280ms ease;
}
#offline-overlay.show { display:flex; opacity:1; visibility:visible; }

#offline-card {
  width: min(720px, 92%);
  max-width: 720px;
  background: linear-gradient(180deg, rgba(255,250,242,0.08), rgba(255,245,220,0.03));
  border: 1px solid rgba(212,175,55,0.12);
  box-shadow: 0 18px 60px rgba(15,12,7,0.6);
  border-radius: 18px;
  padding: 22px;
  color: #fde8b6;
  display: flex;
  gap: 18px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

/* Left: icon + title */
.offline-left {
  display:flex;
  gap:14px;
  align-items:center;
  min-width:220px;
}
.brand-badge {
  width:74px;
  height:74px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: linear-gradient(135deg,#ffd95a,#d4af37);
  box-shadow: 0 8px 24px rgba(212,175,55,0.14);
  color:#3b2300;
  font-weight:800;
  font-size:22px;
  border: 1px solid rgba(255,255,255,0.18);
  transform: translateZ(0);
}

/* Title / message */
.offline-text h3 { margin:0 0 6px 0; font-size:18px; color:#fff8e6; }
.offline-text p { margin:0; color:#f6e7c6; opacity:0.95; font-size:14px; }

/* Right: signal + spinner + small info */
.offline-right { display:flex; gap:14px; align-items:center; }

.signal-wrap { display:flex; flex-direction:column; gap:8px; align-items:center; min-width:120px; }
.signal-bars { display:flex; gap:6px; align-items:end; height:44px; }
.signal-bars .bar {
  width:10px;
  background: linear-gradient(180deg,#fff3d6,#ffd95a);
  border-radius:3px 3px 0 0;
  opacity:0.95;
  transform-origin: bottom center;
  transition: height 350ms cubic-bezier(.2,.9,.2,1), opacity 250ms ease;
  box-shadow: 0 6px 16px rgba(181,137,0,0.08);
}
.signal-bars .bar.dim { opacity:0.22; background: rgba(255,255,255,0.06); box-shadow:none; }
.signal-label { font-size:12px; color:#ffeec9; opacity:0.9; }

/* animated connecting pulse */
.connecting {
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border: 1px solid rgba(212,175,55,0.06);
  box-shadow: inset 0 -6px 30px rgba(0,0,0,0.12);
}
.connecting .dot {
  width:10px; height:10px; border-radius:50%; background: #ffd95a; box-shadow:0 6px 18px rgba(212,175,55,0.15);
  animation: pulse 1100ms infinite ease-in-out;
}
@keyframes pulse { 0%{ transform:scale(.85); opacity:.7; } 50%{ transform:scale(1.15); opacity:1 } 100%{ transform:scale(.85); opacity:.7 } }

/* shimmer text */
.shimmer {
  position:relative;
  overflow:hidden;
}
.shimmer::after {
  content:''; position:absolute; top:0; left:-120%; height:100%; width:120%;
  background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.45), rgba(255,255,255,0));
  animation: shimmer 3.6s linear infinite;
  mix-blend-mode: overlay; pointer-events:none;
}
@keyframes shimmer { to { left:120%; } }

/* small footer note */
.offline-footer { width:100%; margin-top:10px; text-align:center; color:#f2e7c0; font-size:13px; opacity:0.95; }

/* responsive */
@media (max-width:620px){
  #offline-card { flex-direction:column; gap:14px; align-items:center; text-align:center; }
  .offline-left{ justify-content:center; }
  .signal-wrap{ order:3; }
}
</style>

<div id="offline-overlay" aria-hidden="true">
  <div id="offline-card" role="alert" aria-live="assertive">
    <div class="offline-left">
      <div class="brand-badge">VIP</div>
      <div class="offline-text">
        <h3 class="shimmer" id="offline-title">‚ö†Ô∏è Tidak Ada Koneksi Internet</h3>
        <p id="offline-msg">Silakan periksa sambungan internet Anda.</p>
      </div>
    </div>

    <div class="offline-right">
      <div class="signal-wrap" aria-hidden="false">
        <div class="signal-bars" id="signalBars" aria-hidden="true">
          <div class="bar" data-level="1" style="height:8px"></div>
          <div class="bar" data-level="2" style="height:16px"></div>
          <div class="bar" data-level="3" style="height:26px"></div>
          <div class="bar" data-level="4" style="height:36px"></div>
        </div>
        <div class="signal-label" id="signalLabel">Sinyal: Tidak Tersedia</div>
      </div>

      <div id="connectBox" class="connecting" style="display:none;" aria-hidden="true">
        <div class="dot" aria-hidden="true"></div>
        <div style="font-size:14px;font-weight:700;color:#3b2300;">Sedang menyambungkan...</div>
      </div>
    </div>

    <div style="flex-basis:100%"></div>
    <div class="offline-footer" id="offline-footer-note">Tampilan premium ‚Äî sistem akan memperbarui halaman saat koneksi stabil.</div>
  </div>
</div>

<script>
(function(){
  const overlay = document.getElementById('offline-overlay');
  const title = document.getElementById('offline-title');
  const msg = document.getElementById('offline-msg');
  const footer = document.getElementById('offline-footer-note');
  const signalBars = document.getElementById('signalBars');
  const signalLabel = document.getElementById('signalLabel');
  const connectBox = document.getElementById('connectBox');
  let wasOffline = false;
  let periodicChecker = null;
  const CHECK_INTERVAL_MS = 10000; // 10s between checks
  const FETCH_TIMEOUT_MS = 4000; // timeout for fetch attempts

  function setOverlayState(show){
    try{
      if(show){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
      else { overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
    }catch(e){ console.warn(e); }
  }

  function showPremiumOffline(titleText, msgText){
    try{
      if(title) title.textContent = titleText;
      if(msg) msg.textContent = msgText;
      if(footer) footer.textContent = 'Tampilan premium ‚Äî sistem akan memperbarui halaman saat koneksi stabil.';
      // set signal to dim
      animateSignal(0);
      connectBox.style.display = 'none';
      setOverlayState(true);
    }catch(e){ console.warn('showPremiumOffline err', e); }
  }

  function showConnecting(){
    try{
      if(title) title.textContent = 'üîÑ Sedang menyambungkan jaringan...';
      if(msg) msg.textContent = 'Mohon tunggu ‚Äî halaman akan diperbarui otomatis.';
      footer.textContent = 'Menghubungkan ulang...';
      connectBox.style.display = 'flex';
      animateSignal(4, true); // full animate
      setOverlayState(true);
    }catch(e){ console.warn('showConnecting err', e); }
  }

  function hidePremiumOverlay(){
    try{
      connectBox.style.display = 'none';
      setOverlayState(false);
    }catch(e){ console.warn('hidePremiumOverlay err', e); }
  }

  // lightweight connectivity check using fetch to a 204 endpoint; uses AbortController for timeout
  async function checkOnlineAccess(){
    if(!navigator.onLine) return false;
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), FETCH_TIMEOUT_MS);
    try{
      await fetch('https://www.google.com/generate_204', {method: 'GET', mode: 'no-cors', cache: 'no-store', signal: controller.signal});
      clearTimeout(id);
      return true;
    }catch(e){
      clearTimeout(id);
      return false;
    }
  }

  // animate signal bars: level 0..4, if pulse true animate rising bars
  function animateSignal(level, pulse){
    try{
      const bars = Array.from(signalBars.querySelectorAll('.bar'));
      bars.forEach((b, idx) => {
        const target = Math.max(6, (idx+1) * 10); // default heights
        if(level === 0){
          b.style.height = (6 + idx*6) + 'px';
          b.classList.add('dim');
        } else if(pulse){
          // pulse animation by toggling heights
          b.classList.remove('dim');
          b.style.transition = 'height 420ms cubic-bezier(.2,.9,.2,1)';
          const alt = [12,22,32,42];
          setTimeout(()=> b.style.height = (alt[idx]) + 'px', idx*80);
        } else {
          b.classList.remove('dim');
          const h = (idx+1) * (8 + level*6);
          b.style.height = h + 'px';
        }
      });
      // update label
      if(level === 0){
        signalLabel.textContent = 'Sinyal: Tidak Tersedia';
      } else {
        signalLabel.textContent = 'Sinyal: ' + (level) + '/4';
      }
    }catch(e){ console.warn('animateSignal err', e); }
  }

  // Main update logic: detect both offline and "no access / kuota" cases
  async function updateConnection(){
    try{
      const online = navigator.onLine;
      if(!online){
        showPremiumOffline('‚ö†Ô∏è Tidak Ada Koneksi Internet', 'Silakan periksa sambungan internet Anda.');
        wasOffline = true;
        return;
      }
      const hasAccess = await checkOnlineAccess();
      if(hasAccess){
        if(wasOffline){
          showConnecting();
          // small delay to allow network to stabilise then reload
          setTimeout(function(){
            try{ location.reload(); }catch(e){ console.warn('reload failed', e); hidePremiumOverlay(); }
          }, 1200);
        } else {
          hidePremiumOverlay();
        }
        wasOffline = false;
      } else {
        showPremiumOffline('‚ö†Ô∏è Tidak Ada Akses Internet / Kuota Habis', 'Koneksi terdeteksi namun akses internet tidak tersedia. Periksa paket data atau login di jaringan Wi‚ÄëFi.');
        wasOffline = true;
      }
    }catch(err){
      console.warn('updateConnection error', err);
      showPremiumOffline('‚ö†Ô∏è Tidak Ada Koneksi Internet', 'Terjadi kesalahan saat memeriksa koneksi. Silakan coba ulang.');
      wasOffline = true;
    }
  }

  function startPeriodicChecks(){
    if(periodicChecker) return;
    periodicChecker = setInterval(updateConnection, CHECK_INTERVAL_MS);
  }
  function stopPeriodicChecks(){
    if(periodicChecker){ clearInterval(periodicChecker); periodicChecker = null; }
  }

  window.addEventListener('online', function(){ updateConnection(); startPeriodicChecks(); });
  window.addEventListener('offline', function(){ updateConnection(); startPeriodicChecks(); });

  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'visible'){
      updateConnection();
      startPeriodicChecks();
    }
  });

  document.addEventListener('DOMContentLoaded', function(){ updateConnection(); startPeriodicChecks(); });

  // safety run
  setTimeout(function(){ updateConnection(); startPeriodicChecks(); }, 300);

})();
</script>
<!-- ===== Akhir Deteksi Koneksi Internet & Kuota (Premium Overlay) ===== -->

<script>
// Profile registration date enhancement (added by assistant)
// - Stores 'profileRegistered' (ISO string) when profile is saved for the first time
// - Displays registration date under the profile button and in the popup in Indonesian full format
(function(){
  function formatDateFull(dStr){
    if(!dStr) return '-';
    try{
      const d = new Date(dStr);
      return d.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }catch(e){ return dStr; }
  }

  // Initialize or enhance existing initProfileButton
  const prevInit = window.initProfileButton;
  window.initProfileButton = function(){
    try{ if(typeof prevInit === 'function') prevInit(); }catch(e){};
    try{
      const btn = document.getElementById('profileNameBtn');
      const note = document.getElementById('profileSmallNote');
      const name = localStorage.getItem('profileName') || '';
      const birth = localStorage.getItem('profileBirth') || '';
      const reg = localStorage.getItem('profileRegistered') || '';
      if(btn) btn.textContent = name ? name : 'Masukkan Nama';
      if(note){
        const birthText = birth ? ('Tanggal Lahir: ' + formatDateFull(birth)) : 'Belum ada tanggal lahir.';
        const regText = reg ? ('üìÖ Akun terdaftar: ' + formatDateFull(reg)) : '';
        note.innerHTML = birthText + (regText ? '<br>' + regText : '');
      }
    }catch(e){ console.warn('initProfileButton (enhanced) err', e); }
  };

  // Show profile popup (enhanced)
  const prevShow = window.showProfilePopup;
  window.showProfilePopup = function(){
    try{
      const p = document.getElementById('profilePopup');
      const content = document.getElementById('profilePopupContent');
      const name = localStorage.getItem('profileName') || '';
      const birth = localStorage.getItem('profileBirth') || '';
      const reg = localStorage.getItem('profileRegistered') || '';
      if(content){
        content.innerHTML = `<p><strong>Nama:</strong> <span id="pp_name">${ name ? name : '-' }</span></p>
          <p><strong>Tanggal Lahir:</strong> <span id="pp_birth">${ birth ? new Date(birth).toLocaleDateString('id-ID') : '-' }</span></p>
          ${ reg ? ('<p><strong>Terdaftar:</strong> <span id="pp_reg">' + formatDateFull(reg) + '</span></p>') : '' }
          `;
      }
      if(p) p.style.display = 'flex';
      if(typeof prevShow === 'function') try{ prevShow(); }catch(e){};
    }catch(e){ console.warn('showProfilePopup (enhanced) err', e); }
  };

  // Edit profile from popup: show form in popup
  window.editProfileFromPopup = function(){
    try{
      const content = document.getElementById('profilePopupContent');
      const name = localStorage.getItem('profileName') || '';
      const birth = localStorage.getItem('profileBirth') || '';
      if(content){
        content.innerHTML = `
          <label class="small">Nama:</label><br>
          <input id="pp_input_name" type="text" value="${name.replace(/"/g,'&quot;')}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
          <label class="small">Tanggal Lahir:</label><br>
          <input id="pp_input_birth" type="date" value="${birth}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
            <button class="btn-checkout" onclick="saveProfileFromPopup()">Simpan</button>
            <button class="btn-checkout btn-close" onclick="cancelEditFromPopup()">Batal</button>
          </div>`;
      }
    }catch(e){ console.warn('editProfileFromPopup err', e); }
  };

  // Save profile from popup and set registration date if missing
  const prevSave = window.saveProfileFromPopup;
  window.saveProfileFromPopup = function(){
    try{
      // If previous exists, call it to keep behavior (validation)
      if(typeof prevSave === 'function'){
        prevSave();
      } else {
        // fallback save implementation
        const nameEl = document.getElementById('pp_input_name');
        const birthEl = document.getElementById('pp_input_birth');
        const name = nameEl ? nameEl.value.trim() : '';
        const birth = birthEl ? birthEl.value : '';
        if(!name){ alert('Nama tidak boleh kosong.'); if(nameEl) nameEl.focus(); return; }
        localStorage.setItem('profileName', name);
        if(birth) localStorage.setItem('profileBirth', birth); else localStorage.removeItem('profileBirth');
      }
      // ensure registration date exists
      try{
        if(localStorage.getItem('profileName') && !localStorage.getItem('profileRegistered')){
          localStorage.setItem('profileRegistered', new Date().toISOString());
        }
      }catch(e){ console.warn('set profileRegistered err', e); }
      // refresh display
      try{ initProfileButton(); }catch(e){};
      try{ showProfilePopup(); }catch(e){};
    }catch(e){ console.warn('saveProfileFromPopup (enhanced) err', e); alert('Gagal menyimpan profil: ' + e); }
  };

  window.cancelEditFromPopup = function(){ try{ showProfilePopup(); }catch(e){} };

  window.closeProfilePopup = function(){ try{ const p = document.getElementById('profilePopup'); if(p) p.style.display='none'; }catch(e){} };

  // Initialize on DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(initProfileButton, 80);
  else document.addEventListener('DOMContentLoaded', initProfileButton);
})();
</script>


<script>
// Update the registration display under the header (added by assistant)
(function(){
  function formatDateFull(dStr){
    if(!dStr) return '-';
    try{ return new Date(dStr).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); } catch(e){ return dStr; }
  }
  function updateRegisteredUnderHeader(){
    try{
      const container = document.getElementById('registeredUnderHeader');
      const textEl = document.getElementById('registeredUnderHeaderText');
      const reg = localStorage.getItem('profileRegistered') || '';
      const name = localStorage.getItem('profileName') || '';
      if(reg && textEl && container){
        const displayName = name ? (name + ' ‚Äî ') : '';
        textEl.textContent = displayName + 'üìÖ Akun terdaftar: ' + formatDateFull(reg);
        container.style.display = 'block';
      } else if(container){
        container.style.display = 'none';
      }
    }catch(e){ console.warn('updateRegisteredUnderHeader err', e); }
  }

  // Hook into existing initProfileButton if present
  const prevInit = window.initProfileButton;
  window.initProfileButton = function(){
    try{ if(typeof prevInit === 'function') prevInit(); }catch(e){};
    try{ updateRegisteredUnderHeader(); }catch(e){}
  };

  // Also hook into saveProfileFromPopup to update after save
  const prevSave = window.saveProfileFromPopup;
  window.saveProfileFromPopup = function(){
    try{
      if(typeof prevSave === 'function'){
        prevSave();
        try{ updateRegisteredUnderHeader(); }catch(e){}
        return;
      }
      // fallback: if prevSave missing, try to set registered timestamp and update
      try{
        const nameEl = document.getElementById('pp_input_name');
        const birthEl = document.getElementById('pp_input_birth');
        const name = nameEl ? nameEl.value.trim() : '';
        const birth = birthEl ? birthEl.value : '';
        if(name){ localStorage.setItem('profileName', name); if(birth) localStorage.setItem('profileBirth', birth); else localStorage.removeItem('profileBirth'); }
        if(name && !localStorage.getItem('profileRegistered')) localStorage.setItem('profileRegistered', new Date().toISOString());
        updateRegisteredUnderHeader();
      }catch(e){ console.warn('saveProfileFromPopup fallback err', e); }
    }catch(e){ console.warn('wrapped saveProfileFromPopup err', e); }
  };

  // Initialize on DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(updateRegisteredUnderHeader, 120);
  else document.addEventListener('DOMContentLoaded', updateRegisteredUnderHeader);
})();
</script>


<script>
// Override functions to make profile non-persistent by default and add Reset Data.
// This script intentionally overrides previous definitions.
(function(){
  function formatDateFull(dStr){
    if(!dStr) return '-';
    try{ return new Date(dStr).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }catch(e){ return dStr; }
  }

  // Edit form with "Simpan di perangkat" checkbox
  window.editProfileFromPopup = function(){
    try{
      const content = document.getElementById('profilePopupContent');
      const name = (localStorage.getItem('profileName')) || (window.tempProfile && window.tempProfile.name) || '';
      const birth = (localStorage.getItem('profileBirth')) || (window.tempProfile && window.tempProfile.birth) || '';
      if(content){
        content.innerHTML = `
          <label class="small">Nama:</label><br>
          <input id="pp_input_name" type="text" value="${name.replace(/"/g,'&quot;')}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
          <label class="small">Tanggal Lahir:</label><br>
          <input id="pp_input_birth" type="date" value="${birth}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
             <input id="pp_remember" type="checkbox" style="width:16px;height:16px;" /> <label for="pp_remember" class="small" style="margin:0;">Simpan di perangkat (ingat saya)</label>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
            <button class="btn-checkout" onclick="saveProfileFromPopup()">Simpan</button>
            <button class="btn-checkout btn-close" onclick="cancelEditFromPopup()">Batal</button>
          </div>`;
      }
    }catch(e){ console.warn('editProfileFromPopup (override) err', e); }
  };

  // Save profile: persistent only if checkbox checked; otherwise store in-memory window.tempProfile (will not persist on refresh)
  window.saveProfileFromPopup = function(){
    try{
      const nameEl = document.getElementById('pp_input_name');
      const birthEl = document.getElementById('pp_input_birth');
      const rememberEl = document.getElementById('pp_remember');
      const name = nameEl ? nameEl.value.trim() : '';
      const birth = birthEl ? birthEl.value : '';
      const remember = rememberEl ? rememberEl.checked : false;
      if(!name){ alert('Nama tidak boleh kosong.'); if(nameEl) nameEl.focus(); return; }

      if(remember){
        localStorage.setItem('profileName', name);
        if(birth) localStorage.setItem('profileBirth', birth); else localStorage.removeItem('profileBirth');
        if(!localStorage.getItem('profileRegistered')) localStorage.setItem('profileRegistered', new Date().toISOString());
      } else {
        window.tempProfile = window.tempProfile || {};
        window.tempProfile.name = name;
        window.tempProfile.birth = birth || '';
        if(!window.tempProfile.registered) window.tempProfile.registered = new Date().toISOString();
      }

      try{ if(typeof initProfileButton === 'function') initProfileButton(); }catch(e){}
      try{ if(typeof updateRegisteredUnderHeader === 'function') updateRegisteredUnderHeader(); }catch(e){}
      try{ showProfilePopup(); }catch(e){};
    }catch(e){ console.warn('saveProfileFromPopup (override) err', e); alert('Gagal menyimpan profil: ' + e); }
  };

  window.cancelEditFromPopup = function(){ try{ showProfilePopup(); }catch(e){} };

  // initProfileButton: prefer tempProfile (in-memory) over localStorage
  window.initProfileButton = function(){
    try{
      const btn = document.getElementById('profileNameBtn');
      const note = document.getElementById('profileSmallNote');
      const temp = (window.tempProfile && (window.tempProfile.name || window.tempProfile.birth || window.tempProfile.registered)) ? window.tempProfile : null;
      const name = temp ? (temp.name || '') : (localStorage.getItem('profileName') || '');
      const birth = temp ? (temp.birth || '') : (localStorage.getItem('profileBirth') || '');
      const reg = temp ? (temp.registered || '') : (localStorage.getItem('profileRegistered') || '');
      if(btn) btn.textContent = name ? name : 'Masukkan Nama';
      if(note){
        const birthText = birth ? ('Tanggal Lahir: ' + formatDateFull(birth)) : 'Belum ada tanggal lahir.';
        const regText = reg ? ('üìÖ Akun terdaftar: ' + formatDateFull(reg)) : '';
        note.innerHTML = birthText + (regText ? '<br>' + regText : '');
      }
      // update header block too if exists
      try{ if(typeof updateRegisteredUnderHeader === 'function') updateRegisteredUnderHeader(); }catch(e){}
    }catch(e){ console.warn('initProfileButton (override) err', e); }
  };

  // Show profile popup: use tempProfile or localStorage
  window.showProfilePopup = function(){
    try{
      const p = document.getElementById('profilePopup');
      const content = document.getElementById('profilePopupContent');
      const temp = (window.tempProfile && (window.tempProfile.name || window.tempProfile.birth || window.tempProfile.registered)) ? window.tempProfile : null;
      const name = temp ? (temp.name || '') : (localStorage.getItem('profileName') || '');
      const birth = temp ? (temp.birth || '') : (localStorage.getItem('profileBirth') || '');
      const reg = temp ? (temp.registered || '') : (localStorage.getItem('profileRegistered') || '');
      if(content){
        content.innerHTML = `<p><strong>Nama:</strong> <span id="pp_name">${ name ? name : '-' }</span></p>
          <p><strong>Tanggal Lahir:</strong> <span id="pp_birth">${ birth ? new Date(birth).toLocaleDateString('id-ID') : '-' }</span></p>
          ${ reg ? ('<p><strong>Terdaftar:</strong> <span id="pp_reg">' + formatDateFull(reg) + '</span></p>') : '' }
          `;
      }
      if(p) p.style.display = 'flex';
    }catch(e){ console.warn('showProfilePopup (override) err', e); }
  };

  // Reset data: remove many known localStorage keys and clear tempProfile
  window.resetAppData = function(){
    try{
      if(!confirm('Yakin ingin menghapus semua data (localStorage)? Ini akan menghapus profil, history, voucher, dan preferensi.')) return;
      const keys = ['profileName','profileBirth','profileRegistered','favorites','history','orderHistory','vipActive','vipExpire','vipState','voucherData','activeVouchers','keranjang','cart','searchHistory','app_sound_on_v1'];
      keys.forEach(k=>{ try{ localStorage.removeItem(k);}catch(e){} });
      try{ window.tempProfile = {}; }catch(e){};
      alert('Data telah dihapus. Halaman akan dimuat ulang.');
      location.reload();
    }catch(e){ console.warn('resetAppData err', e); alert('Gagal reset data: ' + e); }
  };

  // ensure the Reset Data button exists in settings; if not, add it
  try{
    const settings = document.getElementById('appSettings');
    if(settings && !document.getElementById('resetDataBtn')){
      const btn = document.createElement('button');
      btn.className = 'export-btn';
      btn.id = 'resetDataBtn';
      btn.style.background = '#ef4444';
      btn.textContent = 'Reset Data';
      btn.onclick = resetAppData;
      // place near the export buttons (append)
      const firstExport = settings.querySelector('.export-btn');
      if(firstExport && firstExport.parentElement){
        firstExport.parentElement.appendChild(btn);
      } else {
        settings.appendChild(btn);
      }
    }
  }catch(e){}

  // initialize
  if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(initProfileButton, 60);
  else document.addEventListener('DOMContentLoaded', initProfileButton);

})();
</script>


<script>
/* FORCE TEMPORARY PROFILE (added by assistant)
   - Remove any persisted profile keys on load
   - Ensure profile uses only window.tempProfile (in-memory)
   - Override functions to avoid writing to localStorage for profile keys
*/
(function(){
  try{
    // immediately remove persisted profile keys to avoid showing stale data
    try {
      localStorage.removeItem('profileName');
      localStorage.removeItem('profileBirth');
      localStorage.removeItem('profileRegistered');
    } catch(e){ /* ignore */ }

    // ensure tempProfile exists
    window.tempProfile = window.tempProfile || {};

    function formatDateFull(dStr){
      if(!dStr) return '-';
      try{ return new Date(dStr).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }catch(e){ return dStr; }
    }

    // Override initProfileButton to only read window.tempProfile (never localStorage)
    window.initProfileButton = function(){
      try{
        const btn = document.getElementById('profileNameBtn');
        const note = document.getElementById('profileSmallNote');
        const temp = window.tempProfile || {};
        const name = temp.name || '';
        const birth = temp.birth || '';
        const reg = temp.registered || '';
        if(btn) btn.textContent = name ? name : 'Masukkan Nama';
        if(note){
          const birthText = birth ? ('Tanggal Lahir: ' + formatDateFull(birth)) : 'Belum ada tanggal lahir.';
          const regText = reg ? ('üìÖ Akun terdaftar: ' + formatDateFull(reg)) : '';
          note.innerHTML = birthText + (regText ? '<br>' + regText : '');
        }
        // update under-header block if exists
        try{ if(typeof updateRegisteredUnderHeader === 'function') updateRegisteredUnderHeader(); }catch(e){}
      }catch(e){ console.warn('initProfileButton (force temporary) err', e); }
    };

    // Override showProfilePopup to use tempProfile
    window.showProfilePopup = function(){
      try{
        const p = document.getElementById('profilePopup');
        const content = document.getElementById('profilePopupContent');
        const temp = window.tempProfile || {};
        const name = temp.name || '';
        const birth = temp.birth || '';
        const reg = temp.registered || '';
        if(content){
          content.innerHTML = `<p><strong>Nama:</strong> <span id="pp_name">${ name ? name : '-' }</span></p>
            <p><strong>Tanggal Lahir:</strong> <span id="pp_birth">${ birth ? new Date(birth).toLocaleDateString('id-ID') : '-' }</span></p>
            ${ reg ? ('<p><strong>Terdaftar:</strong> <span id="pp_reg">' + formatDateFull(reg) + '</span></p>') : '' }
            `;
        }
        if(p) p.style.display = 'flex';
      }catch(e){ console.warn('showProfilePopup (force temporary) err', e); }
    };

    // Override editProfileFromPopup to populate fields from tempProfile
    window.editProfileFromPopup = function(){
      try{
        const content = document.getElementById('profilePopupContent');
        const temp = window.tempProfile || {};
        const name = temp.name || '';
        const birth = temp.birth || '';
        if(content){
          content.innerHTML = `
            <label class="small">Nama:</label><br>
            <input id="pp_input_name" type="text" value="${name.replace(/"/g,'&quot;')}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
            <label class="small">Tanggal Lahir:</label><br>
            <input id="pp_input_birth" type="date" value="${birth}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
               <input id="pp_remember" type="checkbox" style="width:16px;height:16px;" /> <label for="pp_remember" class="small" style="margin:0;">Simpan di perangkat (ingat saya)</label>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
              <button class="btn-checkout" onclick="saveProfileFromPopup()">Simpan</button>
              <button class="btn-checkout btn-close" onclick="cancelEditFromPopup()">Batal</button>
            </div>`;
        }
      }catch(e){ console.warn('editProfileFromPopup (force temporary) err', e); }
    };

    // Override saveProfileFromPopup: ALWAYS store to window.tempProfile only (ignore checkbox)
    window.saveProfileFromPopup = function(){
      try{
        const nameEl = document.getElementById('pp_input_name');
        const birthEl = document.getElementById('pp_input_birth');
        const name = nameEl ? nameEl.value.trim() : '';
        const birth = birthEl ? birthEl.value : '';
        if(!name){ alert('Nama tidak boleh kosong.'); if(nameEl) nameEl.focus(); return; }
        window.tempProfile = window.tempProfile || {};
        window.tempProfile.name = name;
        window.tempProfile.birth = birth || '';
        if(!window.tempProfile.registered) window.tempProfile.registered = new Date().toISOString();
        try{ if(typeof initProfileButton === 'function') initProfileButton(); }catch(e){}
        try{ if(typeof updateRegisteredUnderHeader === 'function') updateRegisteredUnderHeader(); }catch(e){}
        try{ showProfilePopup(); }catch(e){};
      }catch(e){ console.warn('saveProfileFromPopup (force temporary) err', e); alert('Gagal menyimpan profil: ' + e); }
    };

    // Ensure updateRegisteredUnderHeader only reads tempProfile
    window.updateRegisteredUnderHeader = function(){
      try{
        const container = document.getElementById('registeredUnderHeader');
        const textEl = document.getElementById('registeredUnderHeaderText');
        const temp = window.tempProfile || {};
        const reg = temp.registered || '';
        const name = temp.name || '';
        if(reg && textEl && container){
          const displayName = name ? (name + ' ‚Äî ') : '';
          textEl.textContent = displayName + 'üìÖ Akun terdaftar: ' + formatDateFull(reg);
          container.style.display = 'block';
        } else if(container){
          container.style.display = 'none';
        }
      }catch(e){ console.warn('updateRegisteredUnderHeader (force temporary) err', e); }
    };

    // Remove any persisted date shown on load by clearing element text (defensive)
    try{
      const txtEl = document.getElementById('registeredUnderHeaderText');
      if(txtEl) txtEl.textContent = '';
      const note = document.getElementById('profileSmallNote');
      if(note) note.textContent = 'Belum ada tanggal lahir.';
    }catch(e){}

    // Run once to initialize UI
    if(document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(function(){ try{ initProfileButton(); }catch(e){} }, 50);
    } else {
      document.addEventListener('DOMContentLoaded', function(){ try{ initProfileButton(); }catch(e){} });
    }

    // Also proactively remove persisted keys again after a short delay (in case earlier scripts re-set them)
    setTimeout(function(){
      try{ localStorage.removeItem('profileName'); localStorage.removeItem('profileBirth'); localStorage.removeItem('profileRegistered'); }catch(e){};
    }, 150);

  }catch(err){
    console.warn('force-temp-profile init err', err);
  }
})();
</script>


<script>
// Auto-register session timestamp on page load (added by assistant)
// - Sets window.tempProfile.registered = now when the user opens the page (if not already set)
// - Displays full date + time (Indonesian locale) under header and in popup
(function(){
  function formatDateTimeISO(dStr){
    if(!dStr) return '-';
    try{
      const d = new Date(dStr);
      // e.g., "Senin, 4 November 2025, 14:35:12"
      const datePart = d.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const timePart = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      return datePart + ', ' + timePart;
    }catch(e){ return dStr; }
  }

  // ensure tempProfile exists
  window.tempProfile = window.tempProfile || {};

  // set registered timestamp for this session immediately if not present
  try{
    if(!window.tempProfile.registered){
      window.tempProfile.registered = new Date().toISOString();
    }
  }catch(e){ console.warn('auto set session registered err', e); }

  // override updateRegisteredUnderHeader to include time formatting
  window.updateRegisteredUnderHeader = function(){
    try{
      const container = document.getElementById('registeredUnderHeader');
      const textEl = document.getElementById('registeredUnderHeaderText');
      const temp = window.tempProfile || {};
      const reg = temp.registered || '';
      const name = temp.name || '';
      if(reg && textEl && container){
        const displayName = name ? (name + ' ‚Äî ') : '';
        textEl.textContent = displayName + 'üìÖ Akun terdaftar: ' + formatDateTimeISO(reg);
        container.style.display = 'block';
      } else if(container){
        container.style.display = 'none';
      }
    }catch(e){ console.warn('updateRegisteredUnderHeader (auto) err', e); }
  };

  // enhance initProfileButton to use the date+time format in the small note
  const prevInit = window.initProfileButton;
  window.initProfileButton = function(){
    try{ if(typeof prevInit === 'function') prevInit(); }catch(e){};
    try{
      const btn = document.getElementById('profileNameBtn');
      const note = document.getElementById('profileSmallNote');
      const temp = window.tempProfile || {};
      const name = temp.name || '';
      const birth = temp.birth || '';
      const reg = temp.registered || '';
      if(btn) btn.textContent = name ? name : 'Masukkan Nama';
      if(note){
        const birthText = birth ? ('Tanggal Lahir: ' + formatDateTimeISO(birth)) : 'Belum ada tanggal lahir.';
        const regText = reg ? ('üìÖ Akun terdaftar: ' + formatDateTimeISO(reg)) : '';
        note.innerHTML = birthText + (regText ? '<br>' + regText : '');
      }
      try{ if(typeof updateRegisteredUnderHeader === 'function') updateRegisteredUnderHeader(); }catch(e){}
    }catch(e){ console.warn('initProfileButton (auto) err', e); }
  };

  // enhance showProfilePopup to include time formatting
  const prevShow = window.showProfilePopup;
  window.showProfilePopup = function(){
    try{
      const p = document.getElementById('profilePopup');
      const content = document.getElementById('profilePopupContent');
      const temp = window.tempProfile || {};
      const name = temp.name || '';
      const birth = temp.birth || '';
      const reg = temp.registered || '';
      if(content){
        content.innerHTML = `<p><strong>Nama:</strong> <span id="pp_name">${ name ? name : '-' }</span></p>
          <p><strong>Tanggal Lahir:</strong> <span id="pp_birth">${ birth ? new Date(birth).toLocaleDateString('id-ID') : '-' }</span></p>
          ${ reg ? ('<p><strong>Terdaftar:</strong> <span id="pp_reg">' + formatDateTimeISO(reg) + '</span></p>') : '' }
          `;
      }
      if(p) p.style.display = 'flex';
      if(typeof prevShow === 'function') try{ prevShow(); }catch(e){};
    }catch(e){ console.warn('showProfilePopup (auto) err', e); }
  };

  // run initialization after DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(function(){ try{ initProfileButton(); }catch(e){} }, 50);
  else document.addEventListener('DOMContentLoaded', function(){ try{ initProfileButton(); }catch(e){} });
})();
</script>


<script>
// Ensure resetAppData clears session tempProfile (including registered timestamp) and reloads
(function(){
  function safeRemoveKeys(keys){
    try{ keys.forEach(k=>localStorage.removeItem(k)); }catch(e){}
  }
  window.resetAppData = function(){
    try{
      if(!confirm('Yakin ingin menghapus semua data (localStorage + session)?')) return;
      // keys to remove from localStorage
      const keys = ['profileName','profileBirth','profileRegistered','favorites','history','orderHistory','vipActive','vipExpire','vipState','voucherData','activeVouchers','keranjang','cart','searchHistory','app_sound_on_v1'];
      safeRemoveKeys(keys);
      // clear in-memory tempProfile completely
      try{ window.tempProfile = {}; }catch(e){}
      // small delay to ensure scripts settle, then reload to start fresh session (new registered timestamp will be set on load)
      setTimeout(function(){ alert('Data dihapus. Halaman akan dimuat ulang dan waktu terdaftar akan dimulai dari awal.'); location.reload(); }, 80);
    }catch(err){
      console.warn('resetAppData override err', err);
      alert('Gagal mereset data: ' + err);
    }
  };
  // Also provide a helper to clear only session registered timestamp without localStorage
  window.clearSessionRegistered = function(){
    try{
      if(window.tempProfile) delete window.tempProfile.registered;
      alert('Waktu terdaftar sesi dihapus. Segarkan halaman untuk memulai ulang waktu terdaftar.');
    }catch(e){ console.warn('clearSessionRegistered err', e); }
  };
})();
</script>


<!-- Firebase Realtime integration (added) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, get, push, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {'apiKey': 'AIzaSyD7E_yunvovumS6TPuUyCbWKGRAcfjTUOE', 'authDomain': 'adi-pro-74048.firebaseapp.com', 'databaseURL': 'https://adi-pro-74048-default-rtdb.asia-southeast1.firebasedatabase.app', 'projectId': 'adi-pro-74048', 'storageBucket': 'adi-pro-74048.firebasestorage.app', 'messagingSenderId': '507607850334', 'appId': '1:507607850334:web:781e48c69229c76e49c3cf', 'measurementId': 'G-622G7MZBQ6'};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

async function seedProdukIfEmpty() {
  try {
    const prodRef = ref(db, 'produk');
    const snap = await get(prodRef);
    if (!snap.exists()) {
      const existing = (window.products && Array.isArray(window.products)) ? window.products : [];
      if (existing.length === 0) return;
      const promises = [];
      for (const p of existing) {
        const id = p.id || (p.nama ? p.nama.replace(/\s+/g,'_').toLowerCase() : 'prod_' + Math.random().toString(36).slice(2,8));
        const data = { nama: p.nama || '', harga: Number(p.harga) || 0, stok: Number(p.stok) || 0, deskripsi: p.deskripsi || '', kategori: p.kategori || '' };
        promises.push(set(ref(db, 'produk/' + id), data));
      }
      await Promise.all(promises);
      console.log('Seeded produk from local page data.');
    }
  } catch (e) { console.warn('seedProdukIfEmpty error', e); }
}
seedProdukIfEmpty();

const produkRef = ref(db, 'produk');
onValue(produkRef, (snapshot) => {
  const data = snapshot.val() || {};
  const arr = (window.products && Array.isArray(window.products)) ? window.products : [];
  arr.length = 0;
  Object.keys(data).forEach(k => {
    const p = data[k];
    p.id = k;
    p.harga = Number(p.harga);
    p.stok = Number(p.stok);
    arr.push(p);
  });
  window.products = arr;
  try {
    arr.forEach(p => {
      const stokEl = document.getElementById('stok-' + p.id);
      if (stokEl) stokEl.textContent = p.stok;
      const qtyEl = document.getElementById(p.id + '-qty');
      if (qtyEl) qtyEl.max = p.stok;
      const btn = document.getElementById('btn-' + p.id);
      if (btn) btn.disabled = (Number(p.stok) <= 0);
    });
  } catch (e) { }
});

async function createOrderAndReduceStock(prodId, qty) {
  if (!prodId) throw new Error('product id missing');
  const tx = await runTransaction(ref(db, 'produk/' + prodId + '/stok'), (current) => {
    const cur = Number(current) || 0;
    if (cur < Number(qty)) return;
    return cur - Number(qty);
  }, { applyLocally: false });
  if (!tx.committed) throw new Error('Stok tidak cukup atau transaksi gagal.');
  const order = { tanggal: new Date().toISOString(), items: [{ id: prodId, jumlah: Number(qty) }], total: 0 };
  try {
    const prodSnap = await get(ref(db, 'produk/' + prodId));
    if (prodSnap.exists()) { const prod = prodSnap.val(); order.items = [{ id: prodId, nama: prod.nama || '', jumlah: Number(qty), harga: Number(prod.harga) || 0 }]; order.total = (order.items[0].harga || 0) * Number(qty); }
  } catch (e) {}
  await set(push(ref(db, 'pesanan')), order);
  return order;
}

(function(){
  const original = window.tambahKeranjang;
  window.tambahKeranjang = async function(id) {
    try {
      const qtyEl = document.getElementById(id + '-qty');
      const jumlah = qtyEl ? Number(qtyEl.value) : 1;
      if (!jumlah || jumlah <= 0) { alert('Pilih jumlah yang benar'); return; }
      const prodSnap = await get(ref(db, 'produk/' + id));
      const prod = prodSnap.exists() ? prodSnap.val() : null;
      if (!prod) { alert('Produk tidak ditemukan di server'); return; }
      if (Number(prod.stok) < jumlah) { alert('Stok tidak cukup. Stok saat ini: ' + Number(prod.stok)); return; }
      await createOrderAndReduceStock(id, jumlah);
      alert('Pesanan berhasil dibuat. Stok diperbarui.');
      try { if (typeof updateCountKeranjang === 'function') updateCountKeranjang(); } catch(e){}
    } catch (err) { console.error(err); alert('Gagal membuat pesanan: ' + (err && err.message ? err.message : err)); }
  };
  window.tambahKeranjang._original = original;
})();

window.__firebase_db = db;
window.__firebase_config = firebaseConfig;
</script>
<!-- End Firebase Realtime integration -->


</body>
</html>
